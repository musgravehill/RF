
    $(".good_photo_min li").HoverDelay({
        hoverDuring: 100,
        outDuring: 100,
        hoverEvent: function (obj) {
            return function () {
                $(obj).addClass("active").siblings().removeClass("active");
                $(".good_photo_max div").html("<img src='" + $(obj).find("a").attr("ref") + "' />");
            }
        }
    });

$(".good_photo_max").HoverDelay({
	hoverDuring: 100,
	outDuring: 100,
	hoverEvent: function(obj){
		return function(){
			$(obj).find("span b").html(LANG_CLICK_THIS_IMAGE);//"Click this image");
		}
	},
	outEvent: function(obj){
		return function(){
			$(obj).find("span b").html(LANG_LARGER_VIEW);//"Larger view");
		}
	}
});

/*#14992 多件优惠促销需求 start*/
var filterBuyMoreSaveMoreNum = new Array();
var filterBuyMoreSaveMorePrice = new Array();
/*#14992 多件优惠促销需求 end*/

var addcartOrBuynow = false;
var scollToGoodsMain = false;
var ajax_priceRange = 0;
var ajax_showTime = 0;
var qtyAboveStock = false;

/* poa 层级 */
var getCurWarehouse = 1;
var is_sel_ware = 0;
var urlWarehouse = $.getUrlParam('cur_warehouse');
var warehouses = new Array('CN', 'USA', 'UK', 'AU', 'EU', 'HK', 'FR');
if ($.inArray(urlWarehouse, warehouses) >= 0) {
    getCurWarehouse = undefined;   // ajax请求不再重新计算当前仓库
    is_sel_ware = 1;               // stockMessage第二参数
    $("#curWarehouse").val(urlWarehouse);
}

$(".good_photo_max").click(function(){
	if(!IsPC() && 1==3){
		$("body").addClass("body_touch");
		$("body").append("<div class='touchbox'><ul key='" + ($('.good_photo_min li.active').index()+1) + "'></ul></div>")
		$(".good_photo_min li a").each(function(){
			$(".touchbox ul").append('<li><img src="' + $(this).attr("big") + '" /></li>');
		});
		$("head").prepend('<meta name="viewport" content="">');
		$("meta[name=viewport]").attr("content",'initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width');
		//alert($("meta[name=viewport]").attr("content"))
		TouchFunc(".touchbox",30);
		$(".touchbox").one("click", function(){
			$(".body_touch .touchbox").remove();
			$("body").removeClass("body_touch");
			$("meta[name=viewport]").attr("content",'initial-scale=1.0,user-scalable=yes,maximum-scale=1,width=device-width');
		});
		return false;
	}
	var good_photo_zoom_list_2 = "";


	msg='' +
		'<div class="good_photo_zoom_box">' +
			'<div class="good_photo_zoom">' +
				'<span><img src="' + $(".good_photo_min li.active a").attr("big") + '"></span>' +
				'<a class="prev" title="Prev" href="javascript:void(0);"><b class="arrow_c"><i><i></i></i></b></a>' +
				'<a class="next" title="Next" href="javascript:void(0);"><b class="arrow_d"><i><i></i></i></b></a>' +
				'<a class="close" title="Close" href="javascript:void(0);">×</a>' +
			'</div>' +
			'<div class="good_photo_zoom_list">' +
				$(".good_photo_min").html() +
			'</div>' +
		'</div>';
	modal_bg();
	$('.module .modal_mask').css("opacity","0.7");
	$('.modal_container').append(msg);
	$(".good_photo_zoom_list li").each(function(){
		if($(this).index() > 9){
			$(this).css({"top":59*($(this).index()-10),"left":59});
			$(".good_photo_zoom_box").addClass("good_photo_zoom_box_2");
		}
		else
		{
			$(this).css("top",59*$(this).index());
		}

	})
	modal_add();

	$(".good_photo_zoom_list li").HoverDelay({
		hoverDuring: 100,
		outDuring: 100,
		hoverEvent: function(obj){
			return function(){
				$(obj).addClass("active").siblings().removeClass("active");
				$(".good_photo_zoom span").html("<img src='"+$(obj).find("a").attr("big")+"' />");
			}
		}
	});
	$(".good_photo_zoom .prev").click(function(){
		if($(".good_photo_zoom_list li.active").index()==0){
			$(".good_photo_zoom_list li:last").trigger("mouseenter");
		}
		else
		{
			$(".good_photo_zoom_list li.active").prev().trigger("mouseenter");
		};
		$(".good_photo_zoom span").html("<img src='"+$(".good_photo_zoom_list li.active a").attr("big")+"' />");
	});

	$(".good_photo_zoom .next").click(function(){
		if($(".good_photo_zoom_list li.active").index()==$(".good_photo_zoom_list li").length-1){
			$(".good_photo_zoom_list li:first").trigger("mouseenter");
		}
		else
		{
			$(".good_photo_zoom_list li.active").next().trigger("mouseenter");
		};
		$(".good_photo_zoom span").html("<img src='"+$(".good_photo_zoom_list li.active a").attr("big")+"' />");
	});

	$(".good_photo_zoom .close").click(function(){
		modal_remove();
	});
});


$(document).on("keypress",".quantity input:text",function(event){
	if(event.keyCode == "13"){
		var num = parseInt($(this).find("#quantity").val());

		//如果Wholesale_item存在，说明是ws的详情页
		if ($('#Wholesale_item').length > 0) {
			if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num < 3){
				num = 3;
				$('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
			}
		} else {
			if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num == 0){
				num = 1;
			}
		}

		var qty = parseInt($(this).val());
		var oldQty = parseInt($(this).attr('value'));
		$(this).attr('value', qty);
		var $this = $(this).parents(".quantity");
		if(qty != oldQty){
			var qty_sub = --qty;
			checkFlashDealNum(qty, 'add');
			checkPreorderNum(qty)
            checkTimeDiscountNum(qty);
            checkSpecialNum(qty);

            if ($('#Wholesale_item').length <= 0 && $('#buymoresavemore_item').length==0) {
				changePriceAccordingToQtyAndFlag(qty+1);
			}
			if ($('#addWsCoLumnToCart').length > 0) {
				var element = $('.goods_together_all .thisitem .goodlist_1 li');
				element.find('.quantity01 input:text').val(qty+1);
				changePriceAccordingToQtyAndFlag01(element,qty+1);
				discountNum();
			}
		}
		if ($('#Wholesale_item').length > 0) {
			numPrice(qty+1);
		}
	}
});
$(document).on("blur",".quantity input:text",function(){
	if($("#quantity").attr("readonly")){
		return false;
	}
	var num = parseInt($(this).find("#quantity").val());
	//如果Wholesale_item存在，说明是ws的详情页
	if ($('#Wholesale_item').length > 0) {
		if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num < 3){
			num = 3;
			$('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
		}
	} else {
		if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num == 0){
			num = 1;
		}
	}

	var qty = parseInt($(this).val());
	var oldQty = parseInt($(this).attr('value'));
	$(this).attr('value', qty);
	var $this = $(this).parents(".quantity");

	if ($('#Wholesale_item').length > 0) {
		if(qty <= 3 || isNaN(qty)){
	        qty = 3;
	        $(this).val(qty);
	        $('.quantity .prev').addClass("gray");
	    }
	    else if(qty > 1)
	    {
	        $('.quantity .prev').removeClass("gray");
	    }
	} else {
		if(qty <= 0 || isNaN(qty)){
			qty = 1;
			$(this).val(qty);
			$('.quantity .prev').addClass("gray");
		}
		else if(qty > 0)
		{
			$('.quantity .prev').removeClass("gray");
		}
	}

	//if(qty != oldQty){

		var qty_sub = --qty;
		checkFlashDealNum(qty, 'add');
		checkPreorderNum(qty);
        checkTimeDiscountNum(qty);
        checkSpecialNum(qty);
        if ($('#Wholesale_item').length <= 0  && $('#buymoresavemore_item').length==0) {
			changePriceAccordingToQtyAndFlag(qty+1);
		}
	//}
	if ($('#Wholesale_item').length > 0) {
		numPrice(qty+1);
	}

	if ($('#addWsCoLumnToCart').length > 0) {
		var element = $('.goods_together_all .thisitem .goodlist_1 li');
		element.find('.quantity01 input:text').val(qty+1);
		changePriceAccordingToQtyAndFlag01(element,qty+1);
		discountNum();
	}
});

$('.quantity .next').click(function(){
    if($("#quantity").attr("readonly")){
		return false;
	}
	var num = parseInt($(this).prev(":text").val());
	//如果Wholesale_item存在，说明是ws的详情页
	if ($('#Wholesale_item').length > 0) {
		if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num < 3){
			num = 3;
			$('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
		}
	} else {
		if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num == 0){
			num = 1;
		}
	}

	if(!checkFlashDealNum(num, 'add')){
		return false;
	}

	if(!checkPreorderNum(num)){
		return false;
	}

    if(!checkTimeDiscountNum(num)){
		return false;
	}

    if(!checkSpecialNum(num)){
        return false;
    }

	num += 1;
	if ($('#Wholesale_item').length > 0) {
		if(num > 3){
			$('.quantity .prev').removeClass('gray');
		}
		$(this).prev(":text").val(num);
		numPrice(num);
	} else {
		if(num > 1){
			$('.quantity .prev').removeClass('gray');
		}
		$(this).prev(":text").val(num);
		if($('#buymoresavemore_item').length==0){
			changePriceAccordingToQtyAndFlag(num);
		}
		if ($('#addWsCoLumnToCart').length > 0) {
			var element = $('.goods_together_all .thisitem .goodlist_1 li');
			element.find('.quantity01 input:text').val(num);
			changePriceAccordingToQtyAndFlag01(element,num);
			discountNum();
		}
	}

});

$('.quantity .prev').click(function(){
	if($("#quantity").attr("readonly")){
		return false;
	}
	if(!$(this).hasClass("gray")){
		var num = parseInt($(this).next(":text").val());
		//如果Wholesale_item存在，说明是ws的详情页
		if ($('#Wholesale_item').length > 0) {
			if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num < 3){
				num = 3;
				$('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
			}
			if(num == 3){
				$('.quantity .prev').addClass('gray');
			}
		} else {
			if(!(/(^[0-9]\d*$)/.test(num)) || !num  || num == 0){
				num = 1;
			}
			if(num == 1){
				$('.quantity .prev').addClass('gray');
			}
		}


		checkFlashDealNum(num, 'sub');
		num -= 1;
		if ($('#Wholesale_item').length > 0) {
			if(num < 3){
	            num = 3;
	        }
	        $(this).next(":text").val(num);
	        numPrice(num)
		} else {
			if(num == 0)num=1;
			$(this).next(":text").val(num);
			if($('#buymoresavemore_item').length==0){
				 changePriceAccordingToQtyAndFlag(num);
			}
	        if ($('#addWsCoLumnToCart').length > 0) {
				var element = $('.goods_together_all .thisitem .goodlist_1 li');
				element.find('.quantity01 input:text').val(num);
				changePriceAccordingToQtyAndFlag01(element,num);
				discountNum();
			}
		}

	}
});

// 2016.12.27 ws专题
function numPrice(num){
    $('.quantity').find('p').remove();
    if (num >= $('.now1').attr('min-num') && num <= $('.now1').attr('max-num')) {
        $('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
    } else if(num >= $('.now2').attr('min-num') && num <= $('.now2').attr('max-num')) {
        $('.now2').parents('li').addClass('bg').siblings().removeClass('bg');
    } else if($('.now3').length > 0 && num >= $('.now3').attr('min-num') && num <= $('.now3').attr('max-num')) {
       $('.now3').parents('li').addClass('bg').siblings().removeClass('bg');
    } else if($('.now4').length > 0 && num >= $('.now4').attr('min-num') && num <= $('.now4').attr('max-num')) {
       $('.now4').parents('li').addClass('bg').siblings().removeClass('bg');
    } else if($('.now5').length > 0 && num >= $('.now5').attr('min-num')) {
        $('.now5').parents('li').addClass('bg').siblings().removeClass('bg');
    }
    // var numArr = [];
    // var num1 = parseFloat($('.now1').html()).toFixed(2);
    // numArr.push(parseFloat($('.now1').html()).toFixed(2));
    // numArr.push(parseFloat($('.now2').html()).toFixed(2));
    // numArr.push(parseFloat($('.now3').html()).toFixed(2));
    // console.log(Math.min.apply(null, numArr), 999)
    // console.log(Math.max.apply(null, numArr), 1111)
    nowPrice();
}

function nowPrice(){
	var num = parseFloat($('#quantity').val());
	var nowPrice = parseFloat($('.now').attr('oriprice'));
	if(num >= 3 && num < 10) {
		nowPrice = parseFloat($('.now1').html());
	}else if(num >= 10 && num < 30) {
		nowPrice = parseFloat($('.now2').html());
	}else if(num >= 30 && num < 100) {
		nowPrice = parseFloat($('.now3').html());
	}else if(num >= 100) {
		nowPrice = parseFloat($('.now4').html());
	}
	
	$('.now').html(nowPrice);
}

function Wholesale(){
    $('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
    $('#quantity').focus(function(){
        $(this).on('keyup', function(event){
            $('.quantity').find('p').remove();
            if ($(this).val() < 3 && event.keyCode != 8) {
                var element = $(this).parents('#detailCartForm');
                element.after('<p style="color:#FF6600; margin:0; margin-top:3px;">The quantity must exceed the minimum order (Min. Order = 3)</p>');
            }
        })

    })
}

//如果Wholesale_item存在，说明是ws的详情页
if ($('#Wholesale_item').length > 0) {
	Wholesale();
}

$(document).on("click",".good_main .warehouse a,.goods_together .item_attr_box .attr a",function(){
	if($(this).hasClass("attrimg"))
	{
		$(this).addClass("imgactive").append("<i />").siblings().removeClass("imgactive").find("i").remove();
		$(this).siblings().removeClass("active").removeClass("hasclicked");
	}else{
		$(this).addClass("active").append("<i />").siblings().removeClass("active").find("i").remove();
		$(this).siblings().removeClass("imgactive").removeClass("hasclicked");
	}
    if($(this).hasClass("hasclicked")){
        if(($(this).hasClass("imgactive")||$(this).hasClass("active"))){
            $(this).removeClass("hasclicked").removeClass("imgactive").removeClass("active").find("i").remove();
        }else{
            $(this).removeClass("hasclicked");
        }
    }else{
        $(this).addClass("hasclicked");
    }

	/*if($(this).parent().hasClass('item_box attr')){
		calculateBundlePrice();
	}*/
	if($(this).parent().parent().attr('id') == 'temptest'){
		$(this).parent().find("a").removeClass('out_stock');
		//判断属性组合的poa是否有库存;如果没有则变灰
		var obj = $(this).parent().parent().parent();
		obj.find("a").each(function(){
			if($(this).hasClass('out_stock')){
				$(this).removeClass('out_stock');
				if($(this).hasClass("attrimg")){
					$(this).addClass('imgactive');
				}else{
					$(this).addClass('active');
				}
			}
		});
		checkStockByPoa(obj);
		if ($('#addWsCoLumnToCart').length <= 0){
			calculateBundlePrice();
		}
	}

	return false;
});



//合并ajax请求
//这些变量必须弄全局
var ori_detail_add_cart_status = $('#detail_add_cart_status').html();
var limit_detail_add_cart_status = new Array();
var warehouse_country_limit = new Array();
var is_country_limit = false;
var product_bundle = {CN:"",USA:"",UK:"",};//存储配件列表html
var all_Stock_Out = '';
function ajaxAllin(getCurWarehouse){
	var data = '';
	//data += 'com=product&t=ajaxAllin';

	//下面的请求都只需要这些参数
	var curWarehouse = $('#curWarehouse').val();
	var product_id = $('#products_id').val();
	//data += '&warehouse='+curWarehouse;
	//data += '&products_id='+product_id;

	//ajax请求改成伪静态重定向
	var ajaxUrl = homeUrl+'ajax/ajaxAllin/'+product_id+'/'+curWarehouse+'.html';
	//把客户端的国家也做成缓存规则中去
	if(typeof($.cookie("countryCookie")) != 'undefined'){
		eval('var countryCookie = '+$.cookie("countryCookie")+';');
		data += 'clientCountry='+countryCookie.code;
	}
	

	//是否需要请求
	if(typeof(isRequest) == 'undefined'){
		var isRequest = false;
	}


	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}

	//ajax变化提交按钮判断
	var isGetChangeSubBtn = changeSubButton(1, true);
	if(!isGetChangeSubBtn){
		data += '&needChangeSubBtn=1';
		isRequest = true;
	}
	//End //ajax变化提交按钮判断

	//产品在部分国家不能销售
	var isGetCountryLimit = isCountryLimit(true);
	if(!isGetCountryLimit){
		data += '&needCountryLimit=1';
		isRequest = true;
	}
	//End //产品在部分国家不能销售

	//加载浏览历史
	var isGetViewHistory = initViewHistory(true);
	if(isGetViewHistory == 1){
		data += '&needViewHistory=1';
		isRequest = true;
	}
	//End 加载浏览历史

	//人工翻译按钮
	var isGetViewEnBtn = translate_btn();
	if(!isGetViewEnBtn){
		data += '&needViewEnBtn=1';
		isRequest = true;
	}
	//End 人工翻译按钮

	//显示产品相应广告
	var isGetCouponBanner = couponBanner();
	if(!isGetCouponBanner){
		data += '&needCouponBanner=1';
		isRequest = true;
	}
	//End 显示产品相应广告

	//获取配件列表
	var isGetBundleList = getBundleList();
	if(!isGetBundleList){
		data += '&needBundleList=1';
		isRequest = true;
	}
	//End获取配件列表

	if(!isRequest){
		return true;
	}

	var poaStr = getPoaStr();

	$.ajax({
		type: 'get',
		async: false,
		url: ajaxUrl,
		data: data,
		dataType: 'json',
		success: function(result){
			//处理ajax变化提交按钮
			if(!isGetChangeSubBtn){
				if (result.csb_curWarehouse != undefined) {
					var subBtnDivID = "button_css_"+result.csb_curWarehouse+poaStr;
all_Stock_Out = result.csb_allStockOut;
					$('.good_main .buy').append('<div style="display:none;" id="'+subBtnDivID+'" outStockCanBuy="'+result.csb_outStockCanBuy+'" is_preorder="'+result.csb_is_preorder+'" is_alert_me="'+result.csb_is_alert_me+'" buy_html="'+result.csb_buy_html+'"  buy_html2="'+result.csb_buy_html2+'" buy_html_fast="'+result.csb_buy_html_fast+'"  buy_html_notice="'+result.csb_buy_html_notice+'" presoldurl="'+result.csb_preSoldUrl+'" item_name="'+result.csb_item_name+'" all_StockOut="'+result.csb_allStockOut+'"></div>');
					changeSubButton(1, true);
				}
			}
			//End 处理ajax变化提交按钮

			//产品在部分国家不能销售
			if(!isGetCountryLimit){
				isCountryLimit(false, result.countryLimitData);
			}
			//End 产品在部分国家不能销售

			//加载浏览历史
			if(isGetViewHistory == 1){
				initViewHistory(false, result.viewHistoryHtml);
			}
			//End加载浏览历史

			//人工翻译按钮
			if(!isGetViewEnBtn){
				translate_btn(result.viewEnBtnHtml);
			}
			//End 人工翻译按钮


			//显示产品相应广告
			if(!isGetCouponBanner){
				couponBanner(result.couponBannerHtml);
			}
			//End 显示产品相应广告

			//获取配件列表
			if(!isGetBundleList){
				getBundleList(result.bundleHtml);
			}
			//End获取配件列表

			//获取品牌信息
			if(result.brandData){
				var tpl_html = '<li class="ajaxbranditem"><span style="padding-right:5px;">'+result.brandData.text+': <a href="'+result.brandData.url+'" style="color:#f60; text-decoration: none;">'+result.brandData.brands_name+'</a></span></li>';
				if($('.good_main .info').find('.ajaxbranditem').length==0){
					$('.good_main .info').prepend(tpl_html);
				}
			}
			//End获取品牌信息

			//QA数量显示
			if(result.qaText){
				$(".good_main .qaText").text(result.qaText);
			}

			/*37330 BG女包详情页推荐细分场景*/ 
			if(result.specialData && result.specialData.products_list.length>0){
				setTimeout(function(){
					setSpecialList(result.specialData);
				},0);
			}
			/*37330 end BG女包详情页推荐细分场景*/ 

		}
	});
}
ajaxAllin(getCurWarehouse);

/*37330 BG女包详情页推荐细分场景*/ 
function setSpecialList(specialData){
	var tabName = specialData.language;
	var specialList = specialData.products_list;
	var html = '';
	var len = $("#product_bundle").length;
	if (!len) {
		$(".detailpage").before('<div class="wrap" id="product_bundle" warehouse="{$warehouse}">'+
			'<input type="hidden" name="currencyPrefix" id="currencyPrefix_bdl" value="{$currencyPrefix}">'+
			'<div class="goods_together_unbeatable">'+
				'<ul class="good_tabs_title"></ul>'+
				'<div class="good_tabs_box"></div>'+
			'</div>'+
		'</div>');
	}
	$('#product_bundle').find('.good_tabs_title').append('<li class="'+(len>0?'':'active')+'">'+tabName+'</li>');
	$.each(specialList,function(key,item){
		html += '<li id="item_'+item.product_id+'">'+
					'<span class="img">'+
						'<a href="'+item.url+'?rmmds=detail-top-special" title="'+item.product_name+'">'+
							'<img src="'+item.img+'" data-original="'+item.img+'" alt="'+item.product_name+'">'+
						'</a>'+
					'</span>'+
					'<span class="title">'+
						'<a href="'+item.url+'?rmmds=detail-top-special" title="'+item.product_name+'">'+item.product_name+'</a>'+
					'</span>'+
					'<span class="price" oriprice="'+item.final_price+'">'+item.final_price+'</span>'+
				'</li>';
	});
	$('#product_bundle').find('.good_tabs_box').append('<div style="'+(len>0?'':'display:block;')+'" class="goods_together_all goods_together_bags">'+
		'<div class="chang btn_left btn_off"><span class="arrow_c"><i><i></i></i></span></div>'+
		'<div class="chang btn_right"><span class="arrow_d"><i><i></i></i></span></div>'+
		'<div class="scroll_box"><ul class="goodlist_1">'+html+'</ul><ol><li class="active"><i></i></li></ol></div>'+
	'</div>');
	scroll_play(".goods_together_bags",6);
}
/*37330 end BG女包详情页推荐细分场景*/ 

function getPoaStr(){
	var poaStr = '';
	var selOptions = getSelectedOptions();
    if (selOptions == false)
        selOptions = selectPOA();

    if (selOptions != false) {
        if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
            for(var i = 0; i < selOptions.valueIds.length; i++){
                poaStr += '_'+selOptions.valueIds[i];
            }
        }
    }

    return poaStr;
}

//ajax变化提交按钮
function changeSubButton(getCurWarehouse, getReturn){
	if(typeof(getReturn) == 'undefined'){
		getReturn = false;
	}
    var curWarehouse = $('#curWarehouse').val();
	var product_id = $('#products_id').val();
    var data = 'com=product&t=changeSubButton';
	data += '&warehouse='+curWarehouse;
	data += '&product_id='+product_id;
   	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}

	var poaStr = getPoaStr();
    var divID = "button_css_"+curWarehouse+poaStr;
    var buy_link = '.good_main .buy .buy_link' ;
    var buy_link_fast = '.fast_addtocart .fast_addtocart_box' ;

    if($('#'+divID).length > 0){
        var is_preorder = $('#'+divID).attr('is_preorder');
        var is_alert_me = $('#'+divID).attr('is_alert_me');
        var buy_html = $('#'+divID).attr('buy_html');
        var buy_html2 = $('#'+divID).attr('buy_html2');
        var buy_html_fast = $('#'+divID).attr('buy_html_fast');
        var buy_html_notice = $('#'+divID).attr('buy_html_notice');
        var presoldurl = $('#'+divID).attr('presoldurl');
        var item_name = $('#'+divID).attr('item_name');
        var outStockCanBuy = $('#'+divID).attr('outStockCanBuy');
        var all_StockOut = $('#'+divID).attr('all_StockOut');

        if(buy_html !== 'undefined' && buy_html_fast != 'undefined'){
        	$(buy_link).find('a').remove();
            $(buy_link_fast).children('a').remove();
            $(".item_box.price .item_name").html(item_name);

	        if(is_preorder == 1){
	            buy_html = '<a href="javascript:void(0);" class="perorder" id="booking"><i></i>'+buy_html+'</a>';
	            buy_html_fast = '<a href="javascript:void(0);" class="perorder"><i></i>'+buy_html_fast+'</a>';
	        }else if(is_alert_me == 1){
	            buy_html = '<a href="javascript:void(0);" class="arrivalnotice"><i></i>'+buy_html+'</a>';
	            buy_html_fast = '<a href="'+presoldurl+'" class="fastarrivalnotice"><i></i>'+buy_html_fast+'</a>';
	        }else if(outStockCanBuy == 1){
	        	buy_html = '<a href="javascript:void(0);" class="add_wish_btn"><i></i>'+buy_html+'</a><a href="javascript:void(0);" data-point-id="17200211613" class="arrival_alert clickandsend middle_arrivalNotice_button_170721" data-poa-stock="'+all_StockOut+'"><i></i>'+buy_html2+'</a>';
	        	buy_html_fast = '<a href="javascript:void(0);" class="add_wish_btn"><i></i>'+buy_html_fast+'</a>';
	        }
	        else{
	        	/*20161213 #12608*/
	            buy_html = '<a href="javascript:void(0);" data-point-id="1100400009" class="top_buyItNow_button_20161213 clickandsend buynow">'+buy_html+'</a><a href="javascript:void(0);" data-point-id="1100400010" class="top_addCart_button_20161213 clickandsend addcart"><i></i>'+buy_html2+'</a>';
	            buy_html_fast = '<a data-point-id="1100400044" class="top_buyNow_button_20161213 clickandsend fast_addcart" href="javascript:void(0);"><i></i>'+buy_html_fast+'</a>';
	            /*end 20161213 #12608*/
	        }

	        //隐藏和显示add wishlist
	        if(outStockCanBuy == 1){
	        	$(".addwish").hide();
	        	$("#product_bundle").hide();
	        } else {
	        	$(".addwish").show();
	        	$("#product_bundle").show();
	        }


        	$(buy_link).append(buy_html);
        	$(buy_link_fast).append(buy_html_fast);
        }
		if(getReturn){
			return true;
		}
    }else{
		if(getReturn){
			return false;
		}
    }
}

changeSubButton(1);


//产品在部分国家不能销售
isCountryLimit();
function isCountryLimit(getReturn, setData) {
	if(typeof(getReturn) == 'undefined'){
		getReturn = false;
	}
	if(typeof(setData) == 'undefined'){
		setData = {};
	}

    var products_id = $("#products_id").val();
    var warehouse = $("#curWarehouse").val();

    if (limit_detail_add_cart_status[warehouse] == undefined || warehouse_country_limit[warehouse] == undefined) {
		if(getReturn && setData.status == undefined){
			return false;
		}
		if(setData.status == 1){
			$('#detail_add_cart_status').html(setData.messege);
			limit_detail_add_cart_status[warehouse] = setData.messege;
			warehouse_country_limit[warehouse] = is_country_limit = true;
		}else {
			$('#detail_add_cart_status').html(ori_detail_add_cart_status);
			limit_detail_add_cart_status[warehouse] = ori_detail_add_cart_status;
			warehouse_country_limit[warehouse] = is_country_limit = false;
		}
    } else {
        $('#detail_add_cart_status').html(limit_detail_add_cart_status[warehouse]);
        is_country_limit = warehouse_country_limit[warehouse];
		if(getReturn){
			return true;
		}
    }
}



//判断属性的poa是否有库存
function checkStockByPoa(obj){
    var bRes = true;
    //获取产品id
	var cls = obj.attr("class");
	var arr = cls.split('_');
	var products_id = arr[1];
    opStr = '';
	var numAttr = 0;
	var attrv = new Array();
	obj.find(".active,.imgactive").each(function(){
		var options_val_id = $(this).attr('value_id');
		attrv.push(options_val_id);
		opStr = opStr + options_val_id + '-';
		numAttr ++;
	});

	//保持和主产品同一个属性选中状态
	bundle_same(2);

	//如果只有一个属性，则返回
	if(numAttr <= 1){
		return true;
	}
	opStr = opStr.substring(0,opStr.length-1);
	$.ajax({
		type: 'get',
		async: false,
		url: homeUrl + 'index.php',
		data: {'com':'product','t':'checkStockByPoa','products_id': products_id,'op_str':opStr},
		dataType: 'json',
		success: function(res){
		    //
			if(res.error == 0){
				//加载头部购物车
				if(!res.flag){
				    //当前选择的属性全部变灰
					obj.find("a").removeClass("imgactive");
					obj.find("a").removeClass("active");
					obj.find("a").each(function(){
						var op_val_id = $(this).attr('value_id');
						for(var i=0; i < attrv.length; i++){
						     if(attrv[i] == op_val_id){
								$(this).addClass('out_stock');
							 }
						}
					});
					$("#item_" + products_id).removeClass('selected');
					$("#item_" + products_id).find(".price").eq(0).find('span').removeClass('checkbox_on_active');
					$("#item_" + products_id).find(".price").eq(0).find('span').addClass('checkbox_on');
					$('.btn').find('.re_ok').eq(0).addClass('cancel');
					$('.btn').find('.re_ok').eq(0).removeClass('ok');

				}else{
					//当前的属性全部变为活动
					obj.find("a").removeClass("out_stock");
					obj.find("a").each(function(){
						var op_val_id = $(this).attr('value_id');
						for(var i=0; i < attrv.length; i++){
						     if(attrv[i] == op_val_id){
								if($(this).hasClass("attrimg")){
									$(this).addClass('imgactive');
								}else{
									$(this).addClass('active');
								}
							 }
						}
					});
					$("#item_" + products_id).addClass('selected');
					$("#item_" + products_id).find(".price").eq(0).find('span').removeClass('checkbox_on');
					$("#item_" + products_id).find(".price").eq(0).find('span').addClass('checkbox_on_active');
					$('.btn').find('.re_ok').eq(0).addClass('ok');
					$('.btn').find('.re_ok').eq(0).removeClass('cancel');
				}
			}
		}
	});
	return bRes;
}

if($(".size_chart").length>0)
{
	var size_chart_str = $(".size_chart").text();
	var size_chart_str_data = $(".size_chart").attr("data");
	var size_chart_str_data_1 = $(".size_chart").attr("vdata");
	var size_chart_str_data_2 = $(".size_chart").attr("ndata");
    var size_chart_str_data_3 = $(".size_chart").attr("mdata");
	var size_chart_str_data_4 = $(".size_chart").attr("ldata");
	var size_chart_str_data_5 = $(".size_chart").attr("wdata");
	var size_chart_str_data_6 = $(".size_chart").attr("hdata");
	var size_chart_str_data_7 = $(".size_chart").attr("idata");
	var size_chart_list = $(".good_tabs_box").find(".list").eq(0);
	if ($('#addWsCoLumnToCart').length <= 0) {
		var size_chart_all = size_chart_list.html().match(size_chart_str);
	}
	if(size_chart_all)
	{
		$(".size_chart").show();
	}
	size_chart_list.find("strong").each(function(){
		var text = $(this).text();
		if(size_chart_str_data == text || size_chart_str == text || size_chart_str_data_1 == text || size_chart_str_data_2 == text|| size_chart_str_data_3 == text || size_chart_str_data_4==text || size_chart_str_data_5==text || size_chart_str_data_6==text || size_chart_str_data_7 ==text)
		{
			$(".size_chart").show();
			$(this).before('<div id="Size_Chart"></div>');
		}
	});
}
$(".size_chart").click(function(){
	$("#Size_Chart").css("height","100px");
});
//select option
$(document).on("click",".attr a:not('.none,.noneimg,.size_chart,.out_stock,.out_stock_img')",function(){
	if($(this).parent().parent().attr('id') == 'temptest'){
		return true;
	}
	if($(this).hasClass("attrimg"))
	{
		$(this).addClass("imgactive").append("<i />").siblings().removeClass("imgactive").find("i").remove();
		$(this).siblings().removeClass("active").removeClass("hasclicked");
	}else{
		$(this).addClass("active").append("<i />").siblings().removeClass("active").find("i").remove();
		$(this).siblings().removeClass("imgactive").removeClass("hasclicked");
	}
    if($(this).hasClass("hasclicked")){
        //没选择时processing_time提示Calculated when item is selected
        $(".shipping_instock .shipping_time em").html(LC_PROCESSIONG_CALCULATED);

        if(($(this).hasClass("imgactive")||$(this).hasClass("active"))){
            $(this).removeClass("hasclicked").removeClass("imgactive").removeClass("active").find("i").remove();
        }else{
            $(this).removeClass("hasclicked");
        }
    }else{
        $(this).addClass("hasclicked");
    }

    //size 服装类，才会显示尺码转换

    if( $('.size_tip_box .size_tip').length>0){

            var size_table = $(this).attr('ori_name');
            if($('.size_tip_box .size_tip[size="'+size_table+'"]').length>0 && $(this).hasClass("hasclicked")){
                $(this).siblings('.size_tip').remove();
                $(this).parent().append($('.size_tip_box .size_tip[size="'+size_table+'"]').clone(true).attr('style','display:block;').get(0));
            }else if($('.size_tip_box .size_tip[size="'+size_table+'"]').length>0){
                $('.size_tip').hide();
            }
    }

	ajaxShipping();
	stockMessage();
	checkAttrStock(this);
	return false;
});

$(document).on('click', '.size_tip .size_close', function() {
    $('.size_tip').hide();
})

//根据链接中的属性自动选中属性
var G_autoSelAttrByUrl = false; //设置全局变量如果为真不允许库存回调后重新选择属性
function autoSelAttrByUrl(){
	var url = document.location.href;
	var pattern = /\-p\-[0-9]+\-av\-([^.]+)\.html/;
	var hasav = url.match(pattern);
	if(hasav != null){
		var attrVals = hasav[1].split('-');
		if(attrVals.length > 0){
			var lastObj = null;
			$('.attrValues').each(function(i){
				var vid = $(this).attr('value_id');
				if($.inArray(vid, attrVals) >= 0){
					if($(this).hasClass("attrimg"))
					{
						$(this).addClass("imgactive").append("<i />").siblings().removeClass("imgactive").find("i").remove();
						$(this).siblings().removeClass("active").removeClass("hasclicked");
					}else{
						$(this).addClass("active").append("<i />").siblings().removeClass("active").find("i").remove();
						$(this).siblings().removeClass("imgactive").removeClass("hasclicked");
					}
					if($(this).hasClass("hasclicked")){
						if(($(this).hasClass("imgactive")||$(this).hasClass("active"))){
							$(this).removeClass("hasclicked").removeClass("imgactive").removeClass("active").find("i").remove();
						}else{
							$(this).removeClass("hasclicked");
						}
					}else{
						$(this).addClass("hasclicked");
					}

					lastObj = $(this);
					G_autoSelAttrByUrl = true;
				}
			});
			if(lastObj){
				if(lastObj.hasClass("attrimg"))
				{
					lastObj.removeClass("imgactive").find("i").remove();
					lastObj.removeClass("active").removeClass("hasclicked");
					lastObj.removeClass('out_stock_img');
					lastObj.find('span').remove();
				}else{
					lastObj.removeClass("active").find("i").remove();
					lastObj.removeClass("imgactive").removeClass("hasclicked");
					lastObj.removeClass('out_stock');
				}
				lastObj.click();
				if(lastObj.find('img').length > 0){
					lastObj.find('img').eq(0).click();
				}
			}
		}
	}
}


function saw_better_price(){
	modal_bg();
	var ajaxTimeoutTest = $.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=showPriceMatch',
		dataType:'html',
		success:function(html){
			$('.modal_container').append(html);
			modal_add();
		},
		complete : function(XMLHttpRequest,status){
			if(status=='timeout'){
				ajaxTimeoutTest.abort();
				//console.log("Timeout!");
			}
		}
	});
};

/*#11272 20161118*/
function price_alert(){
	modal_bg();
	var products_id = $('#products_id').val();
	var ajaxTimeoutTest = $.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=showPriceAlert&products_id='+products_id,
		dataType:'html',
		success:function(html){
			$('.modal_container').append(html);
			modal_add();
		},
		complete : function(XMLHttpRequest,status){
			if(status=='timeout'){
				ajaxTimeoutTest.abort();
				//console.log("Timeout!");
			}
		}
	});
};
$('body').on('click','.price_alert_dialog_ok',function(){
    modal_remove();
});

$('body').on('click','.price_alert_dialog_comfirn',function(){
    var _this = $(this);
    var isClick = _this.hasClass('active');
    var oldEmail = _this.closest('.price_alert_dialog').find('.start_email input').attr('init-email');  //邮箱格式为 14***99@qq.com 提交不过去
    var email = _this.closest('.price_alert_dialog').find('.start_email input').val();
    var tip = _this.closest('.price_alert_dialog').find('.start_tip');
    var myreg = /^[\w-']+([\.\+][\w-']+)*@([a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*?\.[a-zA-Z]{2,6}|(\d{1,3}\.){3}\d{1,3})(:\d{4})?$/;
    var products_id = $('#products_id').val();
    var curWarehouse = $('#curWarehouse').val();
    if(email==oldEmail){
        email = _this.closest('.price_alert_dialog').find('.start_email input').attr('email');
    }
    if(!email || !myreg.test(email.replace(/(^\s*)|(\s*$)/g, ""))){
        tip.show();
        return;
    }
    if(isClick)return;
    _this.addClass('active');
    $.ajax({
        url:homeUrl+'index.php',
        type : 'post',
        data : 'com=ajax&t=priceAlert&products_id='+products_id+'&cur_warehouse='+curWarehouse+'&email='+email+'&notetxt=bool',
        dataType:'json',
        success:function(res){
            _this.removeClass('active');
            if(res==1){
                _this.closest('.price_alert_dialog').find('.start').hide().siblings('.end').show();
                var len = email.indexOf('@');
                var formatEmail = '';
                if(len>4){
                    //显示邮箱名称的前2个字符与结尾2个字符，名称中部用3个星号***代替
                    formatEmail = email.replace(/(^.{2})(.*)(.{2}@.*)$/,'$1***$3');
                }else if(len>1 && len<=4){
                    //邮箱名称4个或4个字符以下的，则显示首2个字符，剩余的用3个型号***代替；
                    formatEmail = email.replace(/(^.{2})(.*)(@.*)$/,'$1***$3');
                }else{
                    //前缀只有1个字符的，显示首字符，后添加3个星号***代替；
                    formatEmail = email.replace(/(^.?)(.*)(@.*)/,'$1***$3');
                }
                $('.price_alert_dialog').find('.start_email input').val(formatEmail).attr('init-email',formatEmail).attr('email',email);
                tip.hide();
            }
        }
    });
});
/*end #11272 20161118*/

function protection(){
	modal_bg();
	var ajaxTimeoutTest = $.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=showPriceProtect',
		dataType:'html',
		success:function(html){
			$('.modal_container').append(html);
			modal_add();
		},
		complete : function(XMLHttpRequest,status){
			if(status=='timeout'){
				ajaxTimeoutTest.abort();
				//console.log("Timeout!");
			}
		}
	});
};

function receive(){
	modal_bg();
	var ajaxTimeoutTest = $.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=showInvitFriends',
		dataType:'json',
		success:function(ret){
			if(ret.status == 2)
			{
				$('.modal_container').append(ret.msg);
				modal_add();
			}
			else if(ret.status == 1)
			{
			    msgbox(0, ret.msg);
			}
			else
			{
				login();
			}


		},
		complete : function(XMLHttpRequest,status){
			if(status=='timeout'){
				ajaxTimeoutTest.abort();
				//console.log("Timeout!");
			}
		}
	});
};

function report(){
	modal_bg();
	var ajaxTimeoutTest = $.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=showErrorReport',
		dataType:'html',
		success:function(html){
			$('.modal_container').append(html);
			modal_add();
		},
		complete : function(XMLHttpRequest,status){
			if(status=='timeout'){
				ajaxTimeoutTest.abort();
				//console.log("Timeout!");
			}
		}
	});
};


function addWishList(obj){
	if($(obj).hasClass("active")){return false;}
	$(obj).addClass("active");
	var products_id = $('#products_id').val();
	var data = 'com=product&t=addWishlist';
	data += '&products_id='+products_id;
	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :data,
		dataType:'json',
		success:function(res){
			$(obj).parent().removeClass('loading');
			$(obj).show();
			if(res.login){
				login();
				$(obj).removeClass("active");
			}else{
				if(res.amount){
					$(obj).parent().find('u').text(res.amount);
					$("#userwish").text(parseInt($("#userwish").text(), 10)+1);
					$(obj).removeClass("active");
					check_wish_flag();
				}
				modal_bg();
				msgbox(0, res.msg);
				$(obj).removeClass("active");
			}
		}
	});
};

function addShoesDealsWishList(obj,id){
	if($(obj).hasClass("active")){return false;}
	$(obj).addClass("active");
	var products_id = id;
	var data = 'com=product&t=addWishlist';
	data += '&products_id='+products_id;
	$.ajax({
		url:homeUrl+'index.php',
		async: false,
		type : 'get',
		data :data,
		dataType:'json',
		success:function(res){
			$(obj).parent().removeClass('loading');
			$(obj).show();
			if(res.login){
				login();
				$(obj).removeClass("active");
			}else{
				if(res.amount){
					$("input[value='"+products_id+"']").next('span').text(res.amount);
					$(obj).removeClass("active");
					check_wish_flag();
				}
				modal_bg();
				msgbox(0, res.msg);
				$(obj).removeClass("active");
			}
		}
	});
};

//Validate all option selected
function validateSelOptions(){
	var optionList = $('.good_main .attr');
	var length = optionList.length;
	var i = 0;
    var showPrompt = true;
	optionList.each(function(){
		var len = 0;
		$(this).find('a').each(function(){
			var acClass = $(this).hasClass('attrimg') ? 'imgactive' : 'active';
			if($(this).hasClass(acClass)){
				len = 1;return false;
			}
		});

		if(len == 1){
            $(this).children('.select_prompt').hide();
			i++;
		} else if (addcartOrBuynow == true && showPrompt == true) {
            $(this).children('.select_prompt').show();
            if (scollToGoodsMain == true) {
                scollToGoodsMain = false;
                $("html,body").animate({scrollTop:$(".good_main").offset().top},300);
            }
            showPrompt = false;
        }
	});
    addcartOrBuynow = false;
    if (showPrompt == false)
        return false;

	return length == i;
}


//Get selected options
function getSelectedOptions(){
	if(!validateSelOptions()){
		return false;
	}
	var optionList = $('.good_main .attr');
	var optionIds = new Array;
	var valueIds = new Array;
	optionList.each(function(){
		var option_id = $(this).attr('option_id');
		var value_id = 0;
		$(this).find('a').each(function(){
			var acClass = $(this).hasClass('attrimg') ? 'imgactive' : 'active';
			if($(this).hasClass(acClass)){
				value_id = $(this).attr('value_id');
				return false;
			}
		});
		optionIds.push(option_id);
		valueIds.push(value_id);
	});
	var result = {};
	result.optionIds = optionIds;
	result.valueIds = valueIds;
	return result;
}


//Get Stock Message
var isFirstChangeWarehouse = 1;
var isclearStock = 0;
var is_dropship_for_Brazil = 0;
function stockMessage(getCurWarehouse,is_sel_ware){
	showFlashDealsMsg('hide');
    if (getCurWarehouse != 1 && is_sel_ware !=1) {
        if(!validateSelOptions()){
            return false;
        }
    }

    var utm_medium = _GET('utm_medium', window.location.href);
	var sku = $('#sku').val();
	var curWarehouse = $('#curWarehouse').val();
	var products_id = $('#products_id').val();
	//获取是否没有匹配配送方式标识
	var noneShipment = $(".good_main .shipping .item_con").attr('noneShipment');
	//var data = 'com=product&t=stockMessage';
	var data = '';
	//ajax请求改成伪静态重定向
	var ajaxUrl = homeUrl+'ajax/stockMessage/'+products_id+'/'+curWarehouse+'.html';
	//把客户端的国家也做成缓存规则中去
	eval('var countryCookie = '+$.cookie("countryCookie")+';');
	data += 'clientCountry='+countryCookie.code;

	data += '&utm_medium='+utm_medium;
	data += '&sku='+encodeURIComponent(sku);
	//data += '&warehouse='+curWarehouse;
	//data += '&products_id='+products_id;
	data += '&noneShipment='+noneShipment;

	//ajax变化提交按钮判断
	var isGetChangeSubBtn = changeSubButton(1, true);
	if(!isGetChangeSubBtn){
		data += '&needChangeSubBtn=1';
	}

	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined' && getCurWarehouse != null){
		data += '&getCurWarehouse=1';
	}

	var divID = 'stockMsg_'+curWarehouse;
	var poaStr = getPoaStr();

	//Get selected options
	var selOptions = getSelectedOptions();
    if (selOptions == false)
        selOptions = selectPOA();

    if (selOptions != false) {
        if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
            for(var i = 0; i < selOptions.valueIds.length; i++){
                data += '&value_ids[]='+selOptions.valueIds[i];
                divID += '_'+selOptions.valueIds[i];
            }
        }
    }
	if($('#'+divID).html()){
		if($('#'+divID).html().length > 0){
			//不是ws详情页
			if ($('#Wholesale_item').length <= 0) {
				stockMessageCallback(divID);
			}
			// stockMessageCallback(divID);
			return true;
		}
	}

	//loadding
	$('.status').addClass('loading');

	//Facebook动态营销代码统计
	if(typeof(fbAutoTrackByUrl) != 'undefined' && typeof(G_fbPTrack) != 'undefined'){
		fbAutoTrackByUrl(G_fbPTrack.country);
	}

	/*24079 更新shipping内容和优化视觉设计*/
	$('.shipping_instock .loading').remove();
	$('.shipping_instock').prepend('<span class="loading"></span>');
	/*24079 更新shipping内容和优化视觉设计*/

	$.ajax({
		url:ajaxUrl,
		type : 'get',
		data :data,
		dataType:'json',
		beforeSend:function(){
			$('#isCheckStock').val(1);
		},
		success:function(result){
			if (result.isWholesalePrice == 1){
				$('.good_main .item_box.price .old').addClass('oldWholesale');
				if ($('.item_ws_price').length <= 0) $('.item_box.price').before(result.isWholesalePriceRetail_msg);
				$('.good_main .price .item_name').html(result.isWholesalePrice_msg);
				$('.good_main .price .now').html(result.wholesalePrice);
				if ($('.ws_details').length <= 0) $('.good_main .item_box.price .item_con').after(result.wholesalePriceHtml);
				$('#quantity').val(result.wholesaleMoq);
				$('.good_main .more_save_box').hide();
				$(".nav_cart").mouseenter(function () {
			        $(this).parents('.nav_right').addClass('active');
			    });
			    $(".nav_cart").mouseleave(function () {
			        $(this).parents('.nav_right').removeClass('active');
			    });
			}
			if( result.changeWarehouseCN && isFirstChangeWarehouse ){
				$(".warehouse .item_con ul li").each(function(index, el) {
					if( $(this).attr('id') == 'CN' ){
						selWarehouse(this);
						$(this).addClass('active');
						$(this).siblings().removeClass('active');
					}
				});
			}
			isFirstChangeWarehouse = 0;
			$('.status').removeClass('loading');
			$('#isCheckStock').val('');

            // DS用户隐藏wholesale联系方式
            if (result.is_dropship == 1) {
				$("#more_save_tips_contact").hide();
				/*33704*/
				$('#product_points').hide();
				$('.good_main .buy').css('margin','0px');
				/*33704 end*/
            }

            //切换按钮
            if(!isGetChangeSubBtn){
				var subBtnDivID = "button_css_"+result.curWarehouse+poaStr;
				$('.good_main .buy').append('<div style="display:none;" id="'+subBtnDivID+'" outStockCanBuy="'+result.csb_outStockCanBuy+'" is_preorder="'+result.csb_is_preorder+'" is_alert_me="'+result.csb_is_alert_me+'" buy_html="'+result.csb_buy_html+'"  buy_html2="'+result.csb_buy_html2+'" buy_html_fast="'+result.csb_buy_html_fast+'" presoldurl="'+result.csb_preSoldUrl+'" item_name="'+result.csb_item_name+'"></div>');
				changeSubButton(1, true);
			}

			//计算币种转换
            var currency = getCookieCurrency();
            var nowFinalPrice = getPriceByCurrency(result.final_price, currency);
            var nowPrice = getPriceByCurrency(result.price, currency);
            var nowFormatFinalPrice = getPriceByCurrency(result.final_price, currency, true);
            var nowFormatPrice = getPriceByCurrency(result.price, currency, true);
            var nowFormatPriceMax = result.attrRange.max > 0 ? getPriceByCurrency(result.attrRange.max, currency, true) : 0;
            var nowFormatPriceMin = result.attrRange.min > 0 ? getPriceByCurrency(result.attrRange.min, currency, true) : 0;
            var nowPriceMax = result.attrRange.max > 0 ? getPriceByCurrency(result.attrRange.max, currency) : 0;
            var nowPriceMin = result.attrRange.min > 0 ? getPriceByCurrency(result.attrRange.min, currency) : 0;
			if(typeof(getCurWarehouse) != 'undefined' && typeof(result.curWarehouse) != 'undefined'){
				//如果有回传的选中id要先选中,但是url中要没有选中的属性id
                // 默认不选poa,如果只有一个POA的产品，客户只能选择这个POA下单
				if(typeof(result.sel_attr) != 'undefined' && !G_autoSelAttrByUrl && result.isOnlyOnePoa==true){
				    $.each(result.sel_attr, function(attr_id, attr_val){
					    $(".attrValues[option_id='"+attr_id+"'][value_id='"+attr_val+"']").addClass("hasclicked").addClass('active').append("<i />").siblings().removeClass('active');
					    $(".attrValues.attrimg[option_id='"+attr_id+"'][value_id='"+attr_val+"']").addClass("hasclicked").addClass('imgactive').append("<i />").siblings().removeClass('imgactive');
					 })
					 autoClickAttrPic(result.sel_attr);
				}


				$('#curWarehouse').val(result.curWarehouse);
				divID = 'stockMsg_'+result.curWarehouse;
				//Get selected options
				var selOptions = getSelectedOptions();
                if (selOptions != false) {
                    if(selOptions.valueIds.length > 0){
                        for(var i = 0; i < selOptions.valueIds.length; i++){
                            divID += '_'+selOptions.valueIds[i];
                        }
                    }
                }
			}

			//临时处理全站产品都受预定产品限制影响
			if(typeof(result.isBookingProduct) != 'undefined' && result.isBookingProduct && typeof(result.preorderLimitNum) != 'undefined'){
				$('#preorder_limit_num').val(result.preorderLimitNum);
			} else if(!result.is_vip_price) {
				$('#preorder_limit_num').remove();
			}

			$('#preorder_limit_msg').html(result.preorderMsgTip);

			if(typeof(result.isBookingProduct) != 'undefined' && result.isBookingProduct && typeof(result.preRateHtml) != 'undefined' && result.preRateHtml){
				$('.good_main .interval').hide();
            	$('.status').hide();
            	if($('.good_main .interval_'+result.curWarehouse).length < 1){
                    $('.good_main .price').before(result.preRateHtml);
                    $('.good_main .interval_'+result.curWarehouse).show();
            	}

            }else{
                $('.status').show();
            }

            if (result.status == 0) {
				$(".good_main .status").html(result.message);
				/*24079 更新shipping内容和优化视觉设计*/
				$('#item_shipments_box').html('<div class="item_name">'+LP_NOTE_SHIPPING+'</div>'+
				'<div class="item_con">'+
					'<div class="shipping_newmethod">'+
						'<div class="shipping_instock">'+
							'<span class="shipping_light">'+result.message+'</span>'+
						'</div>'+
					'</div>'+
				'</div>');
				/*24079 更新shipping内容和优化视觉设计*/
                return;
            }

            if(typeof(result.vip_price) != 'undefined' && !isNaN(parseFloat(result.vip_price)) && parseFloat(result.vip_price) > 0){
	        	//poa变化时 VIP价和库存也要变化
            	changeGrowthPrice(result.poa_diff);	        	
            }
			if(curWarehouse=="CN"){
                if(result.isWholesaleEDM == 1){
                    if($('#isWholesaleEDM').length < 1){
                    $('#detailCartForm').append('<input type="hidden" wholesalePrice="'+result.wholesalePrice+'" value="1" id="isWholesaleEDM">');
                    $('#detailCartForm').append('<input type="hidden" value="'+result.isWholesaleEDM_msg+'" id="isWholesaleEDM_msg">');
                    $('#detailCartForm').append('<input type="hidden" value="'+result.wholesaleMoq+'" id="wholesaleMoq">');
                    }
                }else{
                    $('#isWholesaleEDM').remove();
                }
            }

			$('#stockMsgCache').append('<div id="'+divID+'" isBookingProduct="'+result.isBookingProduct+'" maxStock="'+result.maxStock+'" maxStockMsg="'+result.maxStockMsg+'" stocks="'+result.stocks+'" clearStock="'+result.clearStock+'" poaDiffPrice="'+result.poa_diff+'" clearStockMsg="'+result.clearStockMsg+'"  discount="'+result.discount+'" points="'+result.points+'" hideBuy="'+result.hideBuy+'" oriPrice="'+result.price+'" oriPrice3="'+result.price_3+'" oriPrice10="'+result.price_10+'" oriPrice30="'+result.price_30+'" oriPrice100="'+result.price_100+'" oriFinalPrice="'+result.final_price+'" price="'+nowPrice+'" format_price="'+nowFormatPrice+'" final_price="'+nowFinalPrice+'" format_final_price="'+nowFormatFinalPrice+'" hideSku="'+result.hideSku+'" now_price_max="'+nowPriceMax+'" now_price_min="'+nowPriceMin+'" now_price_max_format="'+nowFormatPriceMax+'" now_price_min_format="'+nowFormatPriceMin+'" ori_max_price="'+result.attrRange.max+'" ori_min_price="'+result.attrRange.min+'" wholesalePrice="'+result.wholesalePrice+'" stock_message="'+result.stock_message+'" processing_time="'+result.processing_time+'" delay_explain="'+result.delay_explain+'" noneShipment="'+result.noneShipment+'" preorderLimitNum="'+result.preorderLimitNum+'" preorderMsgTip="'+result.preorderMsgTip+'">'+result.message+'</div>');
			stockMessageCallback(divID);
			/*24079 更新shipping内容和优化视觉设计*/
			//更新库存信息
			var select_attr_id_split=getSelectAttrIdSplit();
			var stockMessageDiv='stockMsg_'+curWarehouse+select_attr_id_split;
			showStockMessageAndProcessingTime(stockMessageDiv);
			/*24079 更新shipping内容和优化视觉设计*/

			if ($('#addWsCoLumnToCart').length > 0) {
				var element = $('.goods_together_all .thisitem .goodlist_1 li');
				changePriceAccordingToQtyAndFlag01(element, $('.goods_together_all .thisitem .goodlist_1 li .quantity01 input:text').val());
				discountNum();
			}

			/*#14992 多件优惠促销需求 start*/
			if(result.multiDiscount != '' && $('.buymoresavemore').length==0){
				var eachLiHtml = '';
				var eachHtml = ''
				for(var i=0;i<result.multiDiscount.discount.length;i++){
					eachLiHtml = '<li each-price="'+result.multiDiscount.discount[i].price+'" max="'+result.multiDiscount.discount[i].quantity+'">'+
						'<span>'+result.multiDiscount.discount[i].quantity + result.multiDiscount.LPcs+' = <b class="price" oriprice="'+result.multiDiscount.discount[i].total_price+'">US$'+result.multiDiscount.discount[i].total_price+'</b></span>'+
						'<span><em class="price" oriprice="'+result.multiDiscount.discount[i].price+'">US$'+result.multiDiscount.discount[i].price+'</em> '+result.multiDiscount.LEach+'</span>'+
					'</li>';
					eachHtml += eachLiHtml;
				}
				var SaveMoreHtml = ''+
					'<div class="item_box buymoresavemore">'+
						'<div class="item_con">'+
							'<ul class="goodlist_1">'+
								'<li>'+result.multiDiscount.Lbuy+'</li>'+
								eachHtml+
							'</ul>'+
						'</div>'+
					'</div>';
				$('.good_main .warehouse').before(SaveMoreHtml);
				$('#detailCartForm').append('<input type="hidden" id="buymoresavemore_item">');
				$('.more_save_box').hide();
				createBuyMore();

				var repertoryWIdth = 0;
				if($('.repertory').length>0){
					repertoryWIdth = $('.repertory').outerWidth(true) + 5;
				}
				var addonemoreTipsHtml = result.multiDiscount.LAdd;
					addonemoreTipsHtml = addonemoreTipsHtml.replace(/%d/,'<b class="getnum">'+(result.multiDiscount.discount[0].quantity-1)+'</b>');
					addonemoreTipsHtml = addonemoreTipsHtml.replace(/%s/,'<b class="getprice price" oriprice="'+result.multiDiscount.discount[0].price+'">US$'+result.multiDiscount.discount[0].price+'</b>');
				var addonemoreHtml = ''+
					'<div class="addonemore productslist">'+
						'<span class="get">'+addonemoreTipsHtml+'</span>'+
						'<span class="enough"><b><i class="getprice price" oriprice="'+result.multiDiscount.discount[0].price+'">US$'+result.multiDiscount.discount[0].price+'</i></b> '+result.multiDiscount.LEach+'</span>'+
					'</div>';
				$('#detailCartForm').after(addonemoreHtml);
				$('.addonemore').css('left',190+repertoryWIdth);
				if($.cookie("_bgLang") ==  "ar-AR")
				{
					$('.addonemore').css({'right':190+repertoryWIdth,'left':'auto'});
				} 

				$(".buymoresavemore li,.productslist").each(function(){
					$(this).find('.price').each(function(){
						autoChangePrice($(this), getCookieCurrency(), true);
					});
				});
				$('.item_box .now').eq(0).attr('oldoriprice',$('.item_box .now').eq(0).attr('oriprice'));
			}
			/*#14992 多件优惠促销需求 end*/
			if(result.clearStock == 1){
				isclearStock = 1;
			}
			is_dropship_for_Brazil = result.is_dropship;
			GetBrazilSupportedPayment();
		}
	});
}
stockMessage(getCurWarehouse, is_sel_ware);


//优化详情页库存提示，处理时间提示
function showStockMessageAndProcessingTime(divID,type){
	$('.shipping_instock .loading').remove();
	var stock_message=$('#'+divID).attr('stock_message');
	var processing_time=$('#'+divID).attr('processing_time');
	/* 新增Processing time延迟逻辑及说明 */
	var delay_explain=$('#'+divID).attr('delay_explain');
	var selOptions = getSelectedOptions();
	if(selOptions==false && processing_time){
		processing_time=LC_PROCESSIONG_CALCULATED;//未选全属性提示
	}
	else if(delay_explain && processing_time){
		processing_time+= delay_explain;
	}
	/* 新增Processing time延迟逻辑及说明  end*/
	$(".shipping_instock").show();
	if(type){
		$(".shipping_instock .shipping_light").hide();
		$(".shipping_instock .shipping_time").hide();
	}
	$(".shipping_instock .shipping_light").html(stock_message);
	$(".shipping_instock .shipping_time em").html(processing_time);
	if(stock_message){
		$(".shipping_instock .shipping_light").show();
	}
	if(processing_time){
		$(".shipping_instock .shipping_time").show();
	}
	if(!$(".shipping_instock .shipping_light").text()){
		$(".shipping_instock .shipping_light").css('marginLeft','-10px');
	}else{
			$(".shipping_instock .shipping_light").css('marginLeft','0px');
	}
	if(!$(".shipping_instock .shipping_time em").text()){
			$(".shipping_instock .shipping_time").hide();
	}

	var noneShipment = $('#'+divID).attr('noneShipment');
    if (noneShipment == 1) {
		$(".shipping_instock .shipping_light").hide();
		$(".shipping_instock .shipping_time").hide();
    } 
}

//Get Stock Message Callback
var callBackTimesDivID = new Array();
function stockMessageCallback(divID){
	//修改详情页出现无限死循环
	if ($('#addWsCoLumnToCart').length <= 0) {
		$(".quantity input:text").trigger('blur');
	}
    //如果提交按钮没有变化完成，延时执行
    var curWarehouse = divID.split("_");
    curWarehouse = curWarehouse[1];
    var divButton = "button_css_"+curWarehouse;

    if($('#'+divButton).length <= 0 && callBackTimesDivID[divID] != 1){
        callBackTimesDivID[divID] = 1;
        setTimeout("stockMessageCallback('"+divID+"')",100);
        return false;
    }
	if($('.good_main .interval_'+curWarehouse).length < 1){

		$('.good_main .interval').hide();
		// $('.status').html($('#'+divID).html()).show();
		showStockMessageAndProcessingTime(divID);

	}else{
		$('.good_main .interval').hide();
		$('.good_main .interval_'+curWarehouse).show();
		// $('.status').html($('#'+divID).html()).hide();

	    var width = $(".price_interval").outerWidth();
		$(".accounting_interval_c").css({width: width + 'px'});
		$(".order_interval li").eq(0).css({width: 8 + 'px',marginLeft:- 8 + 'px'});
		$(".order_interval li").eq(0).find("span").css({marginRight:- 8 + 'px'});
		$(".order_interval li:gt(0) span").each(function(){
			var right = $(this).outerWidth() / 2 ;
			$(this).css({right: - right + 'px'});
			$(".order_interval li:gt(0) span").not(":last").addClass("callout_span");
		});
	}

	//切换原始价格
	$('.item_con .now').attr('oriPrice', $('#'+divID).attr('oriFinalPrice'));
	$('.item_con .old').attr('oriPrice', $('#'+divID).attr('oriPrice'));
	$('.item_con .now').attr('oriPrice3', $('#'+divID).attr('oriPrice3'));
	$('.item_con .now').attr('oriPrice10', $('#'+divID).attr('oriPrice10'));
	$('.item_con .now').attr('oriPrice30', $('#'+divID).attr('oriPrice30'));
	$('.item_con .now').attr('oriPrice100', $('#'+divID).attr('oriPrice100'));

	//ws详情页
	$('.thisitem .now_1').attr('oriPrice', $('#'+divID).attr('oriFinalPrice'));
	$('.thisitem .now_1').attr('oriPrice3', $('#'+divID).attr('oriPrice3'));
	$('.thisitem .now_1').attr('oriPrice10', $('#'+divID).attr('oriPrice10'));
	$('.thisitem .now_1').attr('oriPrice30', $('#'+divID).attr('oriPrice30'));
	$('.thisitem .now_1').attr('oriPrice100', $('#'+divID).attr('oriPrice100'));

	var finalPrice = $('#'+divID).attr('final_price');
	var attrRangeStr = attrRangeStr_fast_product = '';
    //如果存在价格区间，显示价格区间
    if ($('#'+divID).attr('now_price_max') != undefined && $('#'+divID).attr('now_price_min') != undefined &&
        parseFloat($('#'+divID).attr('now_price_max')) > parseFloat($('#'+divID).attr('now_price_min'))) {
        attrRangeStr = $('#'+divID).attr('now_price_min') + ' ~ '+ $('#'+divID).attr('now_price_max');
        attrRangeStr_fast_product = $('#'+divID).attr('now_price_min_format') +' ~ '+ $('#'+divID).attr('now_price_max');

        $('.item_con .now').attr('oriAttrMax', $('#'+divID).attr('ori_max_price'));
        $('.item_con .now').attr('oriAttrMin', $('#'+divID).attr('ori_min_price'));
        $('.thisitem .now_1').attr('oriAttrMax', $('#'+divID).attr('ori_max_price'));
        $('.thisitem .now_1').attr('oriAttrMin', $('#'+divID).attr('ori_min_price'));
        $(".fast_product .price").attr("oriAttrMax", $('#'+divID).attr('ori_max_price'));
        $(".fast_product .price").attr("oriAttrMin", $('#'+divID).attr('ori_min_price'));
        ajax_priceRange = 1;

        //如果showTime先加载出来，这里就加上区间价格的样式
        if (ajax_showTime == 1 && $('#Wholesale_item').length <= 0) {
            $('.now').addClass('now_interregional');
            $('.old').addClass('old_interregional');
        }

    } else {
        //不存在价格区间
        attrRangeStr = finalPrice;
        attrRangeStr_fast_product = $('#'+divID).attr('format_final_price');

        $('.item_con .now').attr('oriAttrMax', 0);
        $('.item_con .now').attr('oriAttrMin', 0);
        $('.thisitem .now_1').attr('oriAttrMax', 0);
        $('.thisitem .now_1').attr('oriAttrMin', 0);
        $(".fast_product .price").attr("oriAttrMax", 0);
        $(".fast_product .price").attr("oriAttrMin", 0);

        $('.now').removeClass('now_interregional');
        $('.old').removeClass('old_interregional');
        ajax_priceRange = 0;
    }
    $('.now').html(attrRangeStr);



	//快速购买切换价格
	$(".fast_product .price").attr("oriPrice", $('#'+divID).attr('oriFinalPrice'));
	$(".fast_product .price_old").attr("oriPrice", $('#'+divID).attr('oriPrice'));
	$(".fast_product .price").html(attrRangeStr_fast_product);
	$(".fast_product .price_old").html($('#'+divID).attr('format_price'));

	var price = $('#'+divID).attr('price');
	var format_price = $('#'+divID).attr('format_price');
	var hideBuy = $('#'+divID).attr('hideBuy');
	var points = $('#'+divID).attr('points');
	var discount = $('#'+divID).attr('discount');

        var currency = $.cookie("currency");
        var itemprop_priceCurrency = $(".good_main .price .item_con meta[itemprop='priceCurrency']");
        var itemprop_price = $(".good_main .price .item_con meta[itemprop='price']");
       // var itemprop_availability = $(".good_main .price .item_con meta[itemprop='availability']");

//        if(itemprop_priceCurrency.length){
//            itemprop_priceCurrency.attr('content',currency);
//            itemprop_price.attr('content',price);
//        }

	$('#product_points').html(points);
	if(finalPrice != price){
		$('.old').html(format_price);
		$('.old').show();
		$(".fast_product .price_old").show();
	}else{
		$('.old').hide();
		$(".fast_product .price_old").hide();
	}
	if(hideBuy == 1 || is_country_limit){
		$('.buynow').addClass('gray');
		$('.addcart').addClass('gray');
		$('.fast_addcart').addClass('gray');
		$('.perorder').addClass('gray');
		$('.selected_cart').addClass('gray');

	}else{
		$('.buynow').removeClass('gray');
		$('.addcart').removeClass('gray');
		$('.fast_addcart').removeClass('gray');
		$('.perorder').removeClass('gray');
		$('.selected_cart').removeClass('gray');

	}

	$(".good_view .good_photo .good_photo_max").remove('strong');
	if(discount !='' && discount != undefined && discount != null){
		//先remove掉在追加
		$(".good_view .good_photo .good_photo_max strong").remove();
		$(".good_view .good_photo .good_photo_max").append('<strong>'+discount+'</strong>');
	} else {
		$(".good_view .good_photo .good_photo_max strong").remove();
	}

	//显示库存数量
	var stocks = $('#'+divID).attr('stocks');
	if(stocks != '' ){
		$('.good_main .info .stocks').remove();
		$(".good_main .info ").append('<li class="stocks">Stocks: <b>'+stocks+'</b></li>');
	}

	var hideSku = $('#'+divID).attr('hideSku');
	if(hideSku == 0){
		$('.info .sku').show();
	}else{
		$('.info .sku').remove();
	}

    var wholesalePrice = $('#'+divID).attr('wholesalePrice');
    if(wholesalePrice>0){
       $('#isWholesaleEDM').attr('wholesalePrice',wholesalePrice);
    }

	if($("#isWholesaleEDM").length > 0 && $("#isWholesaleEDM").attr('isNotFirst') != 1 ){
    	$("#isWholesaleEDM").attr('isNotFirst',1);
        var wholesalemoq = $("#wholesaleMoq").val();
        changePriceAccordingToQtyAndFlag(wholesalemoq, 1);
    }else{
        changePriceAccordingToQtyAndFlag($("#quantity").val());
    }

    //如果有绑定的配件，更新配件主产品价格
    if($(".goods_together_new").length > 0){
        changeAccessProductPrice($('#'+divID).attr('format_final_price'),$('#'+divID).attr('oriFinalPrice'),$('#'+divID).attr('format_price'),$('#'+divID).attr('oriPrice'));
    }

    // 仓库列表当前仓库的价格跟着改变
    $('.item_warehouse_list li').each(function() {
        if ($(this).attr('value') == curWarehouse) {
            $(this).children('.item_warehouse_price').attr('oriPrice', $('#'+divID).attr('oriFinalPrice')).html($('#'+divID).attr('format_final_price'));
        }
	}); 

    var preorderLimitNum = $("#"+divID).attr('preorderLimitNum');
    var isBookingProduct = $("#"+divID).attr('isBookingProduct');
    if(typeof(isBookingProduct) != 'undefined' && isBookingProduct && typeof(preorderLimitNum) != 'undefined'){
        $('#preorder_limit_num').val(preorderLimitNum);
        $('#preorder_limit_msg').html($("#"+divID).attr('preorderMsgTip')); 
        checkPreorderNum(1);
        if (preorderLimitNum <= 0) {
            $(".perorder").addClass('gray');
        } else {
            $(".perorder").removeClass('gray'); 
        }
    } 

    changeUrl();
}

function changeAccessProductPrice(format_final_price,oriFinalPrice,format_price,ori_price){

	$("#main_final_price").val(oriFinalPrice);
	$("#main_ori_price").val(ori_price);

	$(".goods_together_new .thisitem .price" ).attr("oriprice",oriFinalPrice).html(format_final_price);

    $(".goods_together_new .thisitem  .price_old" ).attr("oriprice",ori_price).html(format_price);

    //计算数量和价格
    var selected_num = 0;
    var accSpeTotalPrice = parseFloat($("#main_final_price").val());
    var accTotalPrice = parseFloat($("#main_ori_price").val());
    $(".goods_together_new .goodlist_1 li").each(function(){
    	if($(this).find('.checkbox_on_active').length == 1){
    		selected_num++;

    		accSpeTotalPrice += parseFloat($(this).find('.final_price_class').val());
    		accTotalPrice += parseFloat($(this).find('.ori_price_class').val());
    	}

    })

    //设置数量
    $("#selected_num").html(selected_num);

	var accSavePrice = accTotalPrice - accSpeTotalPrice;
    //价格
	$("#accTotalPrice").attr('oriprice', accTotalPrice.toFixed(2));
	$("#accSpeTotalPrice").attr('oriprice', accSpeTotalPrice.toFixed(2));
	$("#accSavePrice").attr('oriprice', accSavePrice.toFixed(2));

	var currency = $.cookie("currency")
	autoChangePrice($("#accSpeTotalPrice"), currency, true);
	autoChangePrice($("#accTotalPrice"), currency, true);

	var node = $("#accSavePrice");
	var format = true;
	var oriPrice = parseFloat(node.attr('oriPrice'));
	var oriAttrMax = parseFloat(node.attr('oriAttrMax'));
	var oriAttrMin = parseFloat(node.attr('oriAttrMin'));
	var formatPrice = getPriceByCurrency(oriPrice, currency, format);
	var preg = /<span.+?\/span>/;
	if(preg.test(node.html())){
		var span = node.html().match(preg);
		formatPrice = span + formatPrice;
		node.html(formatPrice);
	}else{
		if(oriAttrMax > oriAttrMin){
			if (currency == 'RUB' || currency == 'AED') {
				var str1 = getPriceByCurrency(oriAttrMin, currency, false);
				var str2 = getPriceByCurrency(oriAttrMax, currency, format);
			} else {
				var str1 = getPriceByCurrency(oriAttrMin, currency, format);
				var str2 = getPriceByCurrency(oriAttrMax, currency, false);
			}
			var attrRangeStr = str1 +' ~ '+ str2;
			node.html(attrRangeStr);
		}else{
			node.text(formatPrice);
		}
	}
}



//Select warehouse
function selWarehouse(obj){
	var warehouse = $(obj).attr('value');
	$('#curWarehouse').val(warehouse);
    changeUrl();
    /*changeSubButton();
	isCountryLimit();*/
	ajaxAllin();
	ajaxShipping();
	stockMessage(null,1);
	viewProduct();
	checkAttrStock(null, true);
	//getBundleList();
	clearSaveMore();
	changeWarehouseGift();
	changeBuyMoreSaveMoreWarehouse(warehouse);
}


function clearSaveMore(){
	var hasTr = $(".more_save_tips tr.has");
	hasTr.removeClass('has');
	hasTr.find('td').eq(0).nextAll().remove();
}


//Get shipping list
function shipping(){
	addcartOrBuynow = true;
	if (!validateSelOptions()) {
        return false;
    }
	modal_bg();
	var warehouse = $('#curWarehouse').val();
	var select_attr_id = getSelectAttrId();
	autoSelShipment();
	var html = $('#shippingList_'+warehouse+select_attr_id).html();
	$('.modal_container').append(html);
	modal_add();
};

//Ajax get shipping list
function ajaxShipping(){
	addcartOrBuynow = true;
	if (!validateSelOptions()) {
        return false;
    }
	var curWarehouse = $('#curWarehouse').val();
	var products_id = $('#products_id').val();
	var data = 'com=product&t=getShipments';
	data += '&warehouse='+curWarehouse;
	data += '&products_id='+products_id;

	var select_id = '';

	//Get selected options
	var selOptions = getSelectedOptions();
	if(selOptions.valueIds.length > 0){
		for(var i = 0; i < selOptions.valueIds.length; i++){
			data += '&value_ids[]='+selOptions.valueIds[i];
			select_id += selOptions.valueIds[i];
		}
	}

	var divID = 'shippingList_'+curWarehouse+select_id;
	if($('#'+divID).html()){
		if($('#'+divID).html().length > 0){
			autoSelShipment();
			return true;
		}
	}

	$('.item_box .shipping').addClass('loading');
	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :data,
		dataType:'json',
		success:function(res){
			$('.item_box .shipping').removeClass('loading');
			$('#shippingListCache').append('<div id="'+divID+'">'+res.html+'</div>');
			if(res.hideBuy == 1){

				/*24079 更新shipping内容和优化视觉设计*/
				//$(".good_main .shipping .item_con").html(res.noneShipMsg);
				// $(".good_main .shipping .item_con").html('<div class="shipping_newmethod">'+
				// 	'<div class="shipping_instock" style="display:none;">'+
				// 		'<span class="shipping_light"></span>'+
				// 	'</div>'+
				// 	'<div class="shipping_options">'+res.noneShipMsg+'</div>'+
				// '</div>');
				$(".good_main .shipping .shipping_options").html(res.noneShipMsg);
				var select_attr_id_split=getSelectAttrIdSplit();
				var stockMessageDiv='stockMsg_'+curWarehouse+select_attr_id_split;
				showStockMessageAndProcessingTime(stockMessageDiv);
				/*24079 更新shipping内容和优化视觉设计*/

				$(".good_main .shipping .item_con").attr('noneShipment', 1);
				//$('.buynow').addClass('gray');
				//$('.addcart').addClass('gray');
			}else{
				autoSelShipment();
				$(".good_main .shipping .item_con").attr('noneShipment', 0);
				//$('.buynow').removeClass('gray');
				//$('.addcart').removeClass('gray');
			}
		}
	});
};


//Ajax get special time
function initSpecialTime(){
	//废弃
	return false;
	var curWarehouse = $('#curWarehouse').val();
	var products_id = $('#products_id').val();
	var data = 'com=product&t=initSpecialTime';
	data += '&warehouse='+curWarehouse;
	data += '&product_id='+products_id;

	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data : data,
		dataType: 'json',
		success:function(html){
			if(html.flashdeals != '')
			{
				$("#detailCartForm").after(html.flashdeals);
				$(".good_main .quantity").css('height', '')
			}

			if(html.timeshow != '')
			{
				$('.good_main .price .item_con').append(html.timeshow);
				$(".timeShow").timeGo({});

                ajax_showTime = 1;
                //如果存在区间价格，加上区间价格样式
                if (ajax_priceRange == 1 && $('#Wholesale_item').length <= 0) {
                    $('.now').addClass('now_interregional');
                    $('.old').addClass('old_interregional');
                }
			} else {
                $('.now').removeClass('now_interregional');
                $('.old').removeClass('old_interregional');
            }
		}
	});
}
initSpecialTime();


function isSetGallery(){
	//废弃
	return false;
	var data = 'com=product&t=isSetGallery';
	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :data,
		success:function(res){
			if(res == 1){
				var href = '<a href="javascript:;" onClick="set_gallery(\'set_description\');">Set Description Picture</a><a href="javascript:;" onClick="set_gallery(\'set_gallery\');">Set Gallery</a>';
				$('.detail_other_title .post').append(href);
			}
		}
	});
}
isSetGallery();

//Ajax get view history
function viewProduct(getCurWarehouse){
	var products_id = $('#products_id').val();
	var curWarehouse = $('#curWarehouse').val();
	var data_specials_warehouse = $('.timeShow').attr('data-specials_warehouse');
	if($(".timeShow").length>0)
	{
		if(curWarehouse == data_specials_warehouse)
		{
			$(".timeShow").show();
			$(".dealsProductLimitInfo").show();
		}
		else
		{
			$(".timeShow").hide();
			$(".dealsProductLimitInfo").hide();
		}
	}

		if($(".good_main .vip_price").length > 0){
			   var isLogin = $(".good_main .vip_price .vipbtn_check").length > 0 ? false : true;
			   var data_vip = $('#curWarehouse').data(curWarehouse);
			   var data_vip_price = $('#curWarehouse').data(curWarehouse+"_price");
			   var data_curr_vip_price = getPriceByCurrency(data_vip_price, $.cookie("currency"));
			   if(!isLogin){
				   if(typeof(data_vip) != 'undefined'){
					   $(".good_main .vip_price").show();
				   }else{
					   $(".good_main .vip_price").hide();
				   }
			   }else{
		           if(typeof(data_vip) != 'undefined'){
		        	   $(".good_main .price:eq(1) .old").show();
		        	   if (data_vip == 1){
			        	   $(".good_main .price:not('.vip_price') .hbactive").remove();
			    		   $(".good_main .price:not('.vip_price') .now").remove();
			    		   $(".vip_price .now").html(data_curr_vip_price);
			    		   $(".vip_price .now").attr("oriprice", data_vip_price);
		        	   }
		        	   if(!$(".good_main .vip_price").hasClass("price")){
		        		   $(".good_main .vip_price").addClass("price");
		        	   }
		        	   $(".good_main .vip_price").show();
		        	   $(".quantity .repertory").show();
		        	   $(".more_save_box").hide();
		           }else{
		        	   $(".good_main .vip_price").removeClass("price");
		        	   $(".good_main .vip_price").hide();
		        	   if ($(".good_main .vip_price .item_con div:not('.member_price')").length > 0){
			        	   $(".good_main .price .hbactive").remove();
			    		   $(".good_main .price .now").remove();
		        	   }
		    		   $(".quantity .repertory").hide();
		    		   $(".more_save_box").show();
		        	   //$(".good_main .price .item_con").append($(".good_main .vip_price .item_con .member_price").prevAll().clone());
		    		   if ($(".good_main .price:not('.vip_price') .old").length > 0){
		    			   $(".good_main .price:not('.vip_price') .old").before($(".good_main .vip_price .item_con div:not('.member_price')").clone());
		    		   }else
		        	   $(".good_main .vip_price .item_con div:not('.member_price')").clone().appendTo(".good_main .price .item_con");
		           }
			   }
			   if($(".vip_price .vip_con .p_content").length > 0){
  					$(".vip_price .vip_con .p_content").attr("data-oriprice", data_vip_price);
  					$(".vip_price .vip_con .p_content").find("strong").html(data_curr_vip_price);
  				}
        }

	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	//var data = 'com=product&t=viewProduct';
	var data = '';
	//ajax请求改成伪静态重定向
	var ajaxUrl = homeUrl+'ajax/viewProduct/'+products_id+'/'+curWarehouse+'.html';
	//把客户端的国家也做成缓存规则中去
	eval('var countryCookie = '+$.cookie("countryCookie")+';');
	data += 'clientCountry='+countryCookie.code;


	//data += '&product_id='+products_id;
	data += '&utm_medium='+utm_medium;
	data += '&utm_source='+utm_source;
	//data += '&warehouse='+curWarehouse;

	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}

	if($("#isWholesaleEDM").val()!=1){

		if ($('#Wholesale_item').length > 0) {
			$("#quantity").val(3);
		} else {
			$("#quantity").val(1);
		}
    }

    $('.size_tip').hide();

    $('.price_sub_info').hide();
   // $('.sold').addClass('loading');

	$.ajax({
		url:ajaxUrl,
		type : 'get',
		data :data,
		async:true,
		dataType : 'json',
		success:function(res){
			
			/* 29601 */
			if(res.caTips != ''){
				$('.good_tabs_box > .list').eq(0).append('<div class="en_warning">' + res.caTips + '</div>');
			}
			/* 29601 end*/

			if ($('#Wholesale_item').length > 0) {
				$('.now').removeClass('now_interregional');
			}

			// //res.ws_deals有数据
			// if (typeof(res.ws_deals) != "undefined" && res.ws_deals.length > 0 && $('#Wholesale_item').length <= 0) {
			// 	$('.item_box.price .price_sub_info').before(res.ws_deals);
			// 	$('.now1').parents('li').addClass('bg').siblings().removeClass('bg');
			// 	$('.now').removeClass('now_interregional');
			// 	// $('.more_save_box').hide();
			// 	if ($('.ws_details').length > 1){
			// 		$('.ws_details').eq(1).remove();
			// 	}
			// }
			// //如果ws_header存在，就把原来的头部隐藏，替换为ws的详情页的头部
			// if (typeof(res.ws_header) != "undefined" && res.ws_header.length > 0 && $('#Wholesale_item').length <= 0) {
			// 	var language_list = $('.top .language ul li');
			// 	$('.top').hide();
			// 	$('.topbanner').hide();
			// 	$('.header').hide();
			// 	$('.nav').hide();
			// 	$('.top').before(res.ws_header);
			// 	$('.toolbar_sub_language').find('ul').html(language_list);
			// 	loadHeaderShipCountry();
			// 	$(".nav_cart").HoverDelay({
			//         hoverDuring: 200,
			//         outDuring: 200,
			//         hoverEvent: function(obj){
			//             return function(){
			//                 $(obj).find(".nav_cart_box").slideDown(200);
			//                 $(".nav_category_list").hide();
			//                 $(".nav_search .quick_tips").hide();
			//                 if(hasLoading==0){
			//                     loadHeadCart();
			//                     hasLoading=1;
			//                 }
			//             };
			//         },
			//         outEvent: function(obj){
			//             return function(){
			//                 $(obj).find(".nav_cart_box").slideUp(200);
			//             };
			//         }
			//     });
			// }
			// //如果是wholesale_item数据存在并且$('#Wholesale_item')这个id不存在，就需要把$('#Wholesale_item')插入在next的后面
			// if (typeof(res.wholesale_item) != "undefined" && res.wholesale_item.length > 0 && $('#Wholesale_item').length <= 0) {
			// 	$('.quantity .next').after(res.wholesale_item);
			// 	if($("#isWholesaleEDM").val()!=1){
			// 		if ($('#Wholesale_item').length > 0) {
			// 			$("#quantity").val(3);
			// 		} else {
			// 			$("#quantity").val(1);
			// 		}
			//     }
			//     Wholesale();
			// }

			$(".price .accounting").remove();
            $(".price .accounting_date").remove();
			$(".price").removeClass('sale_price');
			$(".item_box.price .item_name:eq(1)").remove();
			$(".item_box.price .item_name").show();

            $("#time_discount_limit_num").remove();
            $(".good_main .quantity u").remove();
            $(".good_main .quantity").removeAttr('style');
            $("#special_limit_num").remove();

            //如果有显示折扣每单限制
            if(typeof(res.DiscountOrderLimite) != "undefined" && res.DiscountOrderLimite !== 'zero'){
                $("#detailCartForm").append('<input id="time_discount_limit_num" type="hidden" value="'+res.DiscountOrderLimite+'">');
                $('#time_discount_limit_msg').html(res.lp_time_discount_limit);
            }

            //如果是特定产品限制买一个
            if(typeof(res.tspecialnum) != "undefined"){
                $("#detailCartForm").append('<input id="special_limit_num" type="hidden" value="'+res.tspecialnum+'">');
            }

			//Facebook动态营销代码统计
			if(typeof(fbAutoTrackByUrl) != 'undefined' && res.country_code){
				fbAutoTrackByUrl(res.country_code);
			}
			if(typeof(getCurWarehouse) != 'undefined' && typeof(res.curWarehouse) != 'undefined'){
				$('#curWarehouse').val(res.curWarehouse);
			}

			if(typeof(res.newPriceHtml) != "undefined" && res.newPriceHtml.length){
				//更改产品EDM邮件价格
				$('.item_con .old').remove();
				$('.item_con .now').replaceWith(res.html);
				//配件部分更新
				$('#main_pro_val').val(res.productInfo.final_price);
				$('#main_pro_val').attr('oriPrice', res.productInfo.ori_final_price);
				var node = $('#item_'+products_id+' .price');
				node.attr('oriPrice', res.productInfo.ori_final_price);
				var preg = /<span.+?\/span>/;
				if(preg.test(node.html())){
					var span = node.html().match(preg);
					var formatPrice = span + res.productInfo.format_final_price;
					node.html(formatPrice);
				}
			}

			//产品特价时间更新
			if(res.flashdeals != '' && $('#is_unbeatble').length == 0 && $('#is_flashdeals').length == 0)
			{
				$("#detailCartForm").after(res.flashdeals);
				$(".good_main .quantity").css('height', '')
			}
			if(res.timeshow != '' && $('.timeShow').length==0)
			{
				$('.good_main .price .item_con').append(res.timeshow);
				if ($('#Wholesale_item').length <= 0) {
					$(".timeShow").timeGo({});
				}
				// $(".timeShow").timeGo({});

                ajax_showTime = 1;
                //如果存在区间价格，加上区间价格样式
                if (ajax_priceRange == 1 && $('#Wholesale_item').length <= 0) {
                    $('.now').addClass('now_interregional');
                    $('.old').addClass('old_interregional');
                }
			} else {
                $('.now').removeClass('now_interregional');
                $('.old').removeClass('old_interregional');
            }

			if(res.hidebatch != '')
			{
				$("#detailCartForm").after(res.hidebatch);

			}
			//判断是否是公司设置产品相册人员
			if(res.isSetGallery == 1){
				var href = '<a href="javascript:;" onClick="set_gallery(\'set_description\');">Set Description Picture</a><a href="javascript:;" onClick="set_gallery(\'set_gallery\');">Set Gallery</a>';
				$('.detail_other_title .post').append(href);
			}
			//产品销售数量
//			if(!$('.sold').hasClass('pre') && !$('.sold').hasClass('presell')){
//				if(res.soldTotal > 0 ){
//					$('.sold b').text(res.soldTotal);
//					$('.sold').removeClass('sold_active');
//				}
//			}
            var sold_name = res.sold_name;
            var pre_num =  res.pre_num;
            var soldTotal =  res.soldTotal ;
            var sold_num = $('.sold');

            sold_num.removeClass('pre');
            sold_num.removeClass('presell');
            sold_num.removeClass('sold_active');
            sold_num.removeClass('loading');
            if(res.is_preorder == 1){
                sold_name ='<span id="sold_num">'+pre_num+'</span>&nbsp;'+sold_name;
                sold_num.addClass('pre');
                sold_num.html(sold_name);

            }else if(res.is_alert_me == 1){

                sold_name ='<span id="sold_num">'+pre_num+'</span>&nbsp;'+sold_name;

                sold_num.addClass('presell');
                sold_num.html(sold_name);
            }else{
                soldTotal = soldTotal>0 ? soldTotal:0;
                sold_name =sold_name+': <b id="sold_num">'+soldTotal+'</b>';

                if(res.isBgAccount==1){
                    sold_num.removeClass('sold_active');
                }else if(res.isAir==1){
                    sold_num.addClass('sold_active');
                }else if(soldTotal > 0 ){
                    sold_num.removeClass('sold_active');
                }else{
                    sold_num.addClass('sold_active');
                }
                sold_num.html(sold_name);
            }

			var is_flashdeals = $("#is_flashdeals").val();
			var is_unbeatble = $("#is_unbeatble").val();
			if(is_unbeatble == 1 || is_flashdeals == 1 || res.hidebatch != ''){
				$(".good_main .more_save_box").hide();
			}

			if(res.tdiscount != '')
			{
				$(".price .item_con").append(res.tdiscount);
				$(".price").addClass('sale_price');
				//20170109暂时注释这两行，后端没有相应字段返回，以至于前端显示 undefined
				//$(".item_box.price .item_name").hide();
				//$('<div class="item_name">'+res.tdiscountTitle+':</div>').insertAfter($(".item_box.price .item_name"));
                $(".more_save_box").hide();
                //$(".item_box.price .item_name").html(res.tdiscountTitle);

			}

            //活动标签，目前复活节在用
            if (res.activity_label.logo != undefined) {
                if ($(".easter").html() == undefined) {
                    $(".good_photo_max").append('<i class="easter"><img src="'+res.activity_label.logo+'" /></i>');
                } else {
                    $(".easter").html('<img src="'+res.activity_label.logo+'" />');
                }
            }

            //APP专享特价提示
            if (typeof(res.appSuperPrice) != 'undefined' && res.appSuperPriceOri != $(".now").attr("oriprice")) {
                // 计算APP专享价区间
                var mprice = parseFloat(res.appSuperAttrRange.minAp);
                var pprice = parseFloat(res.appSuperAttrRange.maxAp);
                // // 厉遍POA，计算价格增减量
                // $(".good_main .attrValues").each(function(){
                //     var oriprice = parseFloat($(this).attr("oriprice"));
                //     if($(this).attr("price_prefix") == "-"){
                //         if(mprice < oriprice){
                //             mprice = oriprice;
                //         }
                //     }
                //     else if(pprice < oriprice){
                //             pprice = oriprice;
                //         }
                // });

               var appSuperPriceOri = parseFloat(res.appSuperPriceOri);
               var upPrice = (appSuperPriceOri + pprice).toFixed(2);
               var lowPrice = (appSuperPriceOri + mprice).toFixed(2);
               if(upPrice != lowPrice){
                   if(parseFloat($(".now").attr("oriminprice")) != lowPrice || parseFloat($(".now").attr("orimaxprice")) != upPrice){
                       $('.price_sub_info .appSuperPrice').attr('oriprice', lowPrice);
                       $('.price_sub_info .appSuperPrice').attr('oriattrmax', upPrice);
                       $('.price_sub_info .appSuperPrice').attr('oriattrmin', lowPrice);
                       $('.price_sub_info .appSuperPrice').attr('orimaxAppPrice', upPrice);
                       $('.price_sub_info .appSuperPrice').attr('oriminAppPrice', lowPrice);
                       var currency = $.cookie("currency");
                       // autoChangePrice($('.price_sub_info .appSuperPrice'), currency, true);
                       currencyLowPrice = getPriceByCurrency(lowPrice, currency);
                       currencyUpPrice = getPriceByCurrency(upPrice, currency);
                       $('.price_sub_info .appSuperPrice').html(currency + " " + currencyLowPrice + " ~ " + currencyUpPrice);
                       $('.price_sub_info').show();
                   }
               } else {
                   $('.price_sub_info .appSuperPrice').attr('oriprice',res.appSuperPriceOri);
                   $('.price_sub_info .appSuperPrice').attr('oriattrmax',0);
                   $('.price_sub_info .appSuperPrice').html(res.appSuperPrice);
                   $('.price_sub_info').show();
               }

               $('.price_sub_info .appSuperPrice').attr('oriappprice',res.appSuperPriceOri);
           	   $('.price_sub_info .erweima_img').html('<img id="productsqrcode" src="/QRcode/app-M440.png?$deeplink_path=banggood://prod-'+products_id+'" width="134" height="134" />');
           }

           //会员优惠价
           //if($(".good_main .vip_price").length > 0){

	           if(typeof(res.vip_price) != 'undefined' && parseFloat(res.vip_price) > 0){
	        	   if (typeof($('#curWarehouse').data(curWarehouse)) == 'undefined'){
	        		   $('#curWarehouse').data(curWarehouse, res.is_vip_sold_out ? '0' : '1');
	        		   $('#curWarehouse').data(curWarehouse+"_price", res.vip_price);
	        		   if($(".good_main .vip_price").length > 0){
	        			   var curr_vip_price = getPriceByCurrency(res.vip_price, $.cookie("currency"));
	        			   if (res.is_login){
				        	   $(".good_main .price:eq(1) .old").show();
				        	   if (!res.is_vip_sold_out){
					        	   $(".good_main .price .hbactive").remove();
					    		   $(".good_main .price .now").remove();
					    		   $(".vip_price .now").html(curr_vip_price);
					    		   $(".vip_price .now").attr("oriprice", res.vip_price);
				        	   }
				        	   if(!$(".good_main .vip_price").hasClass("price")){
				        		   $(".good_main .vip_price").addClass("price");
				        		   //$(".good_main .vip_price").show();
				        	   }
				        	   $(".quantity .repertory").show();
				        	   $(".more_save_box").hide();
	        			   }
	        			   if($(".vip_price .vip_con .p_content").length > 0){
		       					$(".vip_price .vip_con .p_content").attr("data-oriprice", res.vip_price);
		       					$(".vip_price .vip_con .p_content").find("strong").html(curr_vip_price);
		       				}
	        			   $(".good_main .vip_price").show();
	        		   }else{
	        			   vipPrice(res.is_vip_sold_out, curWarehouse);
	        		   }

	        	   }

	        	   //vipObj[curWarehouse] = true;
	        	   /*$(".good_main .price:eq(1) .old").show();
	        	   $(".good_main .price .hbactive").remove();
	    		   $(".good_main .price .now").remove();
	        	   if(!$(".good_main .vip_price").hasClass("price")){
	        		   $(".good_main .vip_price").addClass("price");
	        		   $(".good_main .vip_price").show();
	        	   }*/
	           }/*else{
	        	   $(".good_main .vip_price").removeClass("price");
	        	   $(".good_main .vip_price").hide();
	        	   $(".good_main .price .hbactive").remove();
	    		   $(".good_main .price .now").remove();
	        	   //$(".good_main .price .item_con").append($(".good_main .vip_price .item_con .member_price").prevAll().clone());
	        	   $(".good_main .vip_price .item_con div:not('.member_price')").clone().appendTo(".good_main .price .item_con");
	           }*/
           //}
//			$('.info .sku').hide();
            //如果是wholesaleEDM
            if($("#isWholesaleEDM").val()==1&&res.curWarehouse=='CN'){
                changePriceAccordingToQtyAndFlag($("#quantity").val());
            }

            /*2016-10-06 coupon领取入口*/

            //如果有 coupon获取入口
            if(res.coupon_entrance){
            	$(".good_main .item_coupon").html(res.coupon_entrance).show();
            }else{
            	$(".good_main .item_coupon").hide();
            }

            /*2016-10-06 coupon领取入口*/

			//19732 分享享低价 店庆 过后可删除
			$('.shareprice_link_wrap,.shareprice_sign').remove();
			if(res.share_grads_tag){
				$('.more_save_box').remove();
				$('.good_main .price .item_con').append(res.share_grads_activity_desc);
			}
			//End 分享享低价

		}
	});
}
viewProduct(getCurWarehouse);

function vipPrice(is_vip_sold_out, curWarehouse){
	var products_id = $('#products_id').val();
	//var curWarehouse = $('#curWarehouse').val();

	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	var data = 'com=product&t=getVipPrice';
	data += '&product_id='+products_id;
	data += '&utm_medium='+utm_medium;
	data += '&utm_source='+utm_source;
	data += '&warehouse='+curWarehouse;

	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}
	
	var selOptions = getSelectedOptions();
    if (selOptions == false)
        selOptions = selectPOA();

    if (selOptions != false) {
        if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
            for(var i = 0; i < selOptions.valueIds.length; i++){
                data += '&value_ids[]='+selOptions.valueIds[i];
            }
        }
    }

	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :data,
		dataType : 'json',
		success:function(res){
			if (typeof(res.vip_html) != 'undefined' && res.vip_html != ''){
				if($(".good_main .vip_price").length > 0){
					//console.log('has vip html');
					return false;
				}else {
					//console.log('no vip html');
				}
				$(".good_main .warehouse").before(res.vip_html);

				var curr_ori_price = 0;
				if($(".vip_price .vip_con .p_content").length > 0){
					var ori_price = $(".vip_price .vip_con .p_content").attr("data-oriprice");
					curr_ori_price = ori_price;
					$(".vip_price .vip_con .p_content").find("strong").html(getPriceByCurrency(ori_price, $.cookie("currency")));
				}

				if (typeof(res.over_qty_tip) != 'undefined'  &&  res.over_qty_tip != '' && !is_vip_sold_out){
					$("#preorder_limit_msg").html(res.over_qty_tip);
				}

				$('#curWarehouse').data(curWarehouse, is_vip_sold_out ? '0' : '1');

				if (typeof(res.limit_num_tips) != 'undefined' && res.limit_num_tips != '' && !is_vip_sold_out){
					if(res.is_login){
						$(".quantity .more_save_box").hide();
						$(".good_main .price:not(.vip_price) .now").remove();
						$(".good_main .price:not(.vip_price) .hbactive").remove();
						$(".good_main .price .timeShow").remove();
						$("#products_id").after(res.limit_num_tips);
						var vip_price = $(".vip_price .now").attr("oriprice");
						var old_price = $(".price:not(.vip_price) .old").attr("oriprice");
						if (vip_price == old_price) $(".price:not(.vip_price) .old").show();
						curr_ori_price = vip_price;
						$(".vip_price .now").html(getPriceByCurrency(vip_price, $.cookie("currency")));
					}

				}
				$('#curWarehouse').data(curWarehouse+"_price", curr_ori_price);
				if($('.addonemore').length>0){
					$('.addonemore').css('left',190+$('.repertory').outerWidth(true)+5);
					if($.cookie("_bgLang") ==  "ar-AR")
					{
						$('.addonemore').css({'right':190+$('.repertory').outerWidth(true)+5,'left':'auto'});
					} 
				}
			}
		}
	})
}
//vipPrice();

//Ajax get view history
function initViewHistory(getReturn, html){
	if($('#isCloth').val()){return 0;}
	if(typeof(getReturn) == 'undefined'){
		getReturn = false;
	}
	if(typeof(isGetViewHistory) == 'undefined'){
		isGetViewHistory = false;
	}
	if(typeof(html) == 'undefined'){
		html = '';
	}
	if(!isGetViewHistory){
		if(getReturn && html.length == 0){
			return 1;
		}
		$('.wrap_left').append(html);
		DetailLazyImage();
		isGetViewHistory = true;
	}else{
		if(getReturn){
			return 2;
		}
	}
}
initViewHistory();


//Ajax get shipping list
function initShipments(getCurWarehouse,saveShipFlag){
	var curWarehouse = $('#curWarehouse').val();
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	var sku = $('#sku').val();
	var selPoa = $('#selPoa').val();
	var selAttrId = $('#selAttrId').val();
	//var data = 'com=product&t=initShipments';
	var data = '';

	//ajax请求改成伪静态重定向
	var ajaxUrl = homeUrl+'ajax/initShipments/'+products_id+'/'+curWarehouse+'.html';
	//把客户端的国家也做成缓存规则中去
	eval('var countryCookie = '+$.cookie("countryCookie")+';');
	data += 'clientCountry='+countryCookie.code;

	//显示库存和处理时间提示
	var select_attr_id_split=getSelectAttrIdSplit();
	var stockMessageDiv='stockMsg_'+curWarehouse+select_attr_id_split;

	//data += '&warehouse='+curWarehouse;
	//data += '&products_id='+products_id;
	data += '&sku='+encodeURIComponent(sku);
	data += '&selPoa='+encodeURIComponent(selPoa);
	data += '&selAttrId='+selAttrId;
	data += '&utm_medium='+utm_medium;
	data += '&utm_source='+utm_source;
	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}
	
	var selOptions = getSelectedOptions();
    if (selOptions == false)
        selOptions = selectPOA();

    if (selOptions != false) {
        if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
            for(var i = 0; i < selOptions.valueIds.length; i++){
                data += '&value_ids[]='+selOptions.valueIds[i];
            }
        }
    }

	$('.item_box .shipping').addClass('loading');
	$.ajax({
		url:ajaxUrl,
		type : 'get',
		data :data,
		dataType:'json',
		success:function(html){
            if (html.cur_warehouse != undefined) {
                $('.item_box .shipping').removeClass('loading');
                $('#item_shipments_box').html(html.shipmentBox);
                $('.warehouse .item_con').html(html.warehouseBox);
                $('#curWarehouse').val(html.cur_warehouse);

                //初始化加载库存和处理时间提示
                showStockMessageAndProcessingTime(stockMessageDiv,true);

                //不同仓库来路地址
                if (curWarehouse != html.cur_warehouse) {
                    changeCurWarehouse(html.cur_warehouse);
                }
                //外仓比中仓价格更低
                if (html.lowPriceTips != '') {
                    $('.warehouse').addClass('warehouse_prompt');
                    $('.warehouse .item_con').append('<div class="warehouse_prompt_c"><i></i><span>'+html.lowPriceTips+'</span></div>');
                }

                if(!html.shipping){
                    $('.buynow').addClass('gray');
                    $('.addcart').addClass('gray');
                }

                if(typeof(saveShipFlag) != 'undefined'){
                    //changeSubButton();
					ajaxAllin();
                    //切换国家清掉页面缓存
                    $('#stockMsgCache').empty();
                    stockMessage(null,1);
                    viewProduct();
                    checkAttrStock(null, true);
                }
            }

		}
	});
};

initShipments(getCurWarehouse);

//Select shipment
function selShipment(obj){
	var $_this = $(obj);
	var curWarehouse = $('#curWarehouse').val();
	var select_attr_id = getSelectAttrId();
	var divID = 'shippingList_'+curWarehouse+select_attr_id;
	var selCode = $_this.val();
	$('#'+divID).find('.modal_shipping').eq(0).attr('code', selCode);
	if (typeof(selCode) != 'undefined'){
		/*24079 更新shipping内容和优化视觉设计*/
			/*20161213 #12608*/
			//$(".good_main .shipping .item_con").html('<b class="changePrice" oriPrice="'+$_this.attr("oriPrice")+'">'+$_this.attr("fee")+'</b><em>to</em><a class="top_shippingMethod_datalist_20161213" href="javascript:void(0)" onclick="shipping()">'+$_this.attr("label")+'<u><span class="arrow_a"><i></i></span></u></a><p>'+$_this.attr("time")+'</p>');
			/*end 20161213 #12608*/
			// $(".good_main .shipping .item_con").html('<div class="shipping_newmethod">'+
			// 	'<div class="shipping_instock" style="display:none;">'+
			// 		'<span class="shipping_light"></span>'+
			// 		'<span class="shipping_time">'+LC_PROCESSIONG_TIME+':<em></em></span>'+
			// 	'</div>'+
			// 	'<div class="shipping_options">'+
			// 		'<span class="shipping_light changePrice" oriprice="'+$_this.attr("oriPrice")+'">'+$_this.attr("fee")+'</span>'+
			// 		'<em>'+$_this.attr("via")+'</em><a class="shipping_type" data-point-id="1100400005" class="top_shippingMethod_datalist_20161213 clickandsend" href="javascript:void(0)" onclick="shipping();">'+$_this.attr("ship")+'<u><span class="arrow_a"><i><i></i></i></span></u></a>'+
			// 		'<span class="shipping_time"> '+LC_SHIPPING_TIME+':<em>'+$_this.attr("time")+'</em></span>'+
			// 	'</div>'+
			// '</div>');
			$(".good_main .shipping .shipping_options").html('<span class="shipping_light changePrice" oriprice="'+$_this.attr("oriPrice")+'">'+$_this.attr("fee")+'</span>'+
				'<em>'+$_this.attr("via")+'</em><a class="shipping_type" data-point-id="1100400005" class="top_shippingMethod_datalist_20161213 clickandsend" href="javascript:void(0)" onclick="shipping();">'+$_this.attr("ship")+'<u><span class="arrow_a"><i><i></i></i></span></u></a>'+
				'<span class="shipping_time"> '+LC_SHIPPING_TIME+':<em>'+$_this.attr("time")+'</em></span>');

			var select_attr_id_split=getSelectAttrIdSplit();
			var stockMessageDiv='stockMsg_'+curWarehouse+select_attr_id_split;
			showStockMessageAndProcessingTime(stockMessageDiv);
		/*24079 更新shipping内容和优化视觉设计*/
	} else {
		/*24079 更新shipping内容和优化视觉设计*/
		//$(".good_main .shipping .item_con").html('This warehouse can not ship to your location.');
		// $(".good_main .shipping .item_con").html('<div class="shipping_newmethod">'+
		// 	'<div class="shipping_instock" style="display:none;">'+
		// 		'<span class="shipping_light"></span>'+
		// 	'</div>'+
		// 	'<div class="shipping_options">'+
		// 		'This warehouse can not ship to your location.'+
		// 	'</div>'+
		// '</div>');
		$(".good_main .shipping .shipping_options").html('This warehouse can not ship to your location.');
		var select_attr_id_split=getSelectAttrIdSplit();
		var stockMessageDiv='stockMsg_'+curWarehouse+select_attr_id_split;
		showStockMessageAndProcessingTime(stockMessageDiv);
		/*24079 更新shipping内容和优化视觉设计*/
		$(".good_main .shipping .item_con").attr('noneShipment', 1);
	}
}

$(document).on("click",".modal_shipping_con .shipto_tips_item",function(){
	selShipment($(this).prev().children('input').eq(0));
	$(this).prev().children("input").eq(0).click();
});

//Auto select shipment
function autoSelShipment(){
	var curWarehouse = $('#curWarehouse').val();
	var select_attr_id = getSelectAttrId();
	var divID = 'shippingList_'+curWarehouse+select_attr_id;
	var selCode = $('#'+divID).find('.modal_shipping').eq(0).attr('code');
	var selRadio = null;
	$('#'+divID).find('input').each(function(){
		if($(this).val() == selCode){
			$(this).attr('checked', true);
			selRadio = this;
		}else{
			$(this).attr('checked', false);
		}
	});
	selShipment(selRadio);
}

//Get reviews
function getReviews(page){
	var products_id = $('#products_id').val();
	var data = 'lang='+$.cookie('_bgLang');
	var size = $("#size_option").val();
	var star = $("#star_option").val();
	var filter = $("#filter_option").val();
	var tag = $("#tag_option").val();
	var url = homeUrl+'reviews-'+products_id+'-'+page;
	if(size){
		url = url+'-size-'+size;
	}
	if(star){
		url = url+'-star-'+star;
	}
	if(filter){
		url = url+'-filter-'+filter;
	}
	if(tag){
		url = url+'-tag-'+tag;
	}
	url = url+".html";

	$("#reviewList .loading").css("display","block");

	$.ajax({
		url: url,
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$("#reviewList .loading").css("display","none");
			$('#reviewList').html(html);
			FormatReplySpace();
		}
	});
	return false;
}

function FormatReplySpace(){
	$('.good_review_list dl').each(function(){
		if($(this).find('.detail .reply').length>0){
			var str = $(this).find('.detail .reply').html();
			$(this).find('.detail .reply').html(str.replace(/&nbsp;/g, " "));
		}
	});
}

function getImageReviews(page){
	var w = 244;focusW = parseInt($(".wrap:eq(0)").css("width"));
	if(focusW == 1000){
		w = 259;
	}
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	var data = 'utm_medium='+utm_medium;
	data += '&utm_source='+utm_source;
	data += '&lang='+$.cookie('_bgLang')

	$.ajax({
		url:homeUrl+'imagesreviews-'+products_id+'-'+page+'.html',
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('#reviewImageList').html(html);
			$('#reviewImageList .photo_video_box').masonry({columnWidth:w});
			image_load = true;
		}
	});
}


function getVideoReviews(page){
	var w = 244;focusW = parseInt($(".wrap:eq(0)").css("width"));
	if(focusW == 1000){
		w = 259;
	}
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	var data = 'utm_medium='+utm_medium;
	data += '&lang='+$.cookie('_bgLang');
	data += '&utm_source='+utm_source;

	$.ajax({
		url:homeUrl+'videoreviews-'+products_id+'-'+page+'.html',
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('#reviewVideoList').html(html);
			$('#reviewVideoList .photo_video_box').masonry({columnWidth:w});
			DetailLazyImage();
			video_load = true;
		}
	});
}


function getDiscussion(page){
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
	var data = 'utm_medium='+utm_medium;
	data += '&lang='+$.cookie('_bgLang')
	data += '&utm_source='+utm_source;

        var topic_id = $('#topic_id').val();
        data += '&topic_id='+topic_id;

	$.ajax({
		url:homeUrl+'discussion-'+products_id+'-'+page+'.html',
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('#discussionList').html(html);
		},
		complete:function(){
			var firstTopicUrl = $(".learnmore a").eq(0).attr("href");

			$("#win_vouchers").attr("href", firstTopicUrl);
		}
	});
}


function getProductDiscussion(){
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
        var data = 'com=product&t=getProductDiscussion&pid='+products_id;
	data += '&utm_medium='+utm_medium;
	data += '&lang='+$.cookie('_bgLang')
	data += '&utm_source='+utm_source;

	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('#discussionList').html(html);
            scroll_play(".askquestion_c", 1);
			askquestion_c_c();
			var askquestion_c_liHeight = $('.askquestion_c .goodlist_1 li').eq(0).outerHeight();
			$(".askquestion_c .goodlist_1").css({'height':askquestion_c_liHeight+20,'overflow':'hidden'});

		},
		complete:function(){
			var firstTopicUrl = $(".learnmore a").eq(0).attr("href");
			$("#win_vouchers").attr("href", firstTopicUrl);
		}
	});
}


//QA信息加载
function getProductQuestionAnswer(page){
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);

	var ajaxUrl=homeUrl+'questionanswer-'+products_id+'-'+page+'.html';
	var data = '&utm_medium='+utm_medium;
	data += '&lang='+$.cookie('_bgLang')
	data += '&utm_source='+utm_source;

	$.ajax({
		url:ajaxUrl,
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('#questionAnswerList').html(html);
			//将数据插入到页面之后，判断把数据在每个li里面放满5个数据再放到后面的li。以此类推
			var arr = [];
			var newStr = '';
			$('#question_list li').each(function(){
				$(this).find('.answerList').each(function(){
					arr.push($(this)[0].outerHTML);
				})
			});

			var num = Math.ceil(arr.length/5);
			var count = 0;
			for(var i = 0; i < num; i++) {
				newStr += '<li>';
				for (var j = i*5; j < 5*(i+1); j++) {
					if (arr.length < j + 1)
					break;
					newStr += arr[j];
				}
				count += 5;
				newStr += '</li>';
			}
			$('#questionAnswerList ul').html(newStr);
			scroll_play('.item_QAproduct', 1);
			var askquestion_c_liHeight = $('.qa_answerList ul li').eq(0).outerHeight();
			$(".qa_answerList ul").css({'height':askquestion_c_liHeight + 10,'overflow':'hidden'});
			askquestion_cV2();
		},
		complete:function(){
			//no think to do
		}
	});
}

var alsobuyPids = [];
var looingforPids = [];
function getAlsoBuy(){
	var products_id = $('#products_id').val();
	var utm_medium = _GET('utm_medium', window.location.href);
	var utm_source = _GET('utm_source', window.location.href);
    var filter_id	=	[];
    $('#goods_together .scroll_box li').each(function(){
        var str = $(this).attr('id');
        if(str !== null && str !== undefined)
        {
            filter_id.push(str.substring(5));
        }
    });
	var data = 'utm_medium='+utm_medium;
	data += '&lang='+$.cookie('_bgLang');
	data += '&utm_source='+utm_source;
  	data += '&filterId=' + filter_id.join(',') + ',' + hotProductIds.join(',');
    var rec_sid = GetRecommendCookie('rec_sid');

    var ab = rec_sid.split('|');
    ab = ab[0];
    ab = ab%2;

    data += '&ab='+ab;

	$.ajax({
		url:homeUrl+'alsobuy-'+products_id+'.html',
		type : 'get',
		data :data,
		dataType:'html',
		success:function(html){
			$('.hotgoods_970').html(html);
			$('.hotgoods_970').addClass('rec_hotgoods_970');
			$('.hotgoods_970 .goodlist_1 li').each(function(){
		        var href= $(this).find('.img a').attr('href');
		        var s = new RegExp(".*-p-([0-9]*)\\.html");
		        var g = s.exec(href);
		        alsobuyPids.push(g[1]);
			});
			Ajaxalsoviewlookingfor();
			DetailLazyImage();
			scroll_play('.hotgoods_970',5);
			var currency = $.cookie("currency");
			$(".goodlist_1 li").each(function(){
				var node = $(this).find('.price').eq(0);
				autoChangePrice(node, currency, true);

				node = $(this).find('.price_old').eq(0);
				autoChangePrice(node, currency, true);
			});
		}
	});
}


function submit_topic(obj){
	if($(obj).parent().hasClass('formsubmitgray')){
		return false;
	}
	$(obj).parent().addClass('formsubmitgray');
	//登录不跳转
	loginRefresh = false;
	var p_title= $('#topic_title').val();
	var validate = true;
	var message = '';
	delInputNotice($('#topic_title'));
	delInputNotice($('#topic_content'));

	if(p_title.length<10){
		inputNotice($('#topic_title'), $('#topic_title').attr('msg1'));
		validate = false;
	}else if(p_title.length>100){
		inputNotice($('#topic_title'), $('#topic_title').attr('msg2'));
		validate = false;
	}

	editor.sync();
	var p_content = $('#topic_content').val();

	if(p_content.length<30){
		inputNotice($('#topic_content'), $('#topic_content').attr('msg'));
		validate = false;
	}
	if(!validate){
		$(obj).parent().removeClass('formsubmitgray');
		return false;
	}


	var pid = $('#products_id').val();
	$.ajax({
		type: 'post',
		url:  homeUrl+'index.php',
		data: {'com':'ajaxforum','t':'submitTopic','title':p_title,'fid':4,'content':p_content,'pid':pid},
		dataType:'json',
		success:function(res){
			$(obj).parent().removeClass('formsubmitgray');
			$('.huanchong').css('visibility','hidden');
			if(res.success == 2){
				login();
			}else {
				if(res.success == 1){
					$('#topic_content').val('');
					$('#topic_title').val('');
					editor.html('');
				}
				modal_bg();
				msgbox(0, res.message);
			}
		}
	});
}

function submitTopic(obj){
	var validate = true;
	if($(obj).hasClass('formsubmitgray')){
		return false;
	}
	if($('#post-content').prev('.ke-container').length>0){
		editor.sync();
	}

        delInputNotice($('#post-title'));
	delInputNotice($('#post-content'));


        var p_title = $('#post-title').val();
	var p_content = $('#post-content').val();
        if(p_title.length<10){

		inputNotice($('#post-title'), $('#post-title').attr('msg1'));
		validate = false;
	}else if(p_title.length>100){
		inputNotice($('#post-title'), $('#post-title').attr('msg2'));
		validate = false;
	}

	if(p_content.length<30){

		inputNotice($('#post-content'), $('#post-content').attr('msg'));
		validate = false;
	}

        if(!validate){
		$(obj).removeClass('formsubmitgray');
		return false;
	}

		$(obj).addClass('formsubmitgray');

	var pid = $('#products_id').val();
	$.ajax({
		type: 'post',
		url:  homeUrl+'index.php',
		data: {'com':'ajaxforum','t':'submitTopic','fid':4,'title':p_title,'content':p_content,'pid':pid},
		dataType:'json',
		success:function(res){
			$('.huanchong').css('visibility','hidden');
			$(obj).removeClass('formsubmitgray');
			if(res.success == 2){
				login();
			}else {
				if(res.success == 1 || res.success == -3){
					$('#post-title').val('');
					$('#post-content').val('');
					editor.html('');
                    $(".write_item").fadeOut();
				}
				modal_bg();
				msgbox(0, res.message);
			}
		}
	});
}

//sort排序函数
function sortNumber(a, b)
{
	return a - b
}

//取得添加购物车的value_id
function getFbCartValueId()
{
	var k = 0;
	var fb_cart_value_id = [];
	$('.hasclicked').each(function(){
			fb_cart_value_id[k] = $(this).attr('value_id');
			k++;
	});

	fb_cart_value_id = fb_cart_value_id.sort(sortNumber);

	var products_id = '';
	products_id = $('#products_id').val();

	if(typeof(fb_jsonNewFB.content_ids!='undefined')){
	    var content_ids_str = fb_jsonNewFB.content_ids;
		var str = content_ids_str[0];
		var lang_end = str.substr(str.length - 2);
	}else{
		var lang_end = 'US';
	}

	$(fb_cart_value_id).each(function(i, item){
	   products_id += '-' + item;
	});

	products_id += lang_end;

	var pid_arr = [products_id];
	return pid_arr;
}

//传递Facebook统计添加购物车数据
function sendFbAddCart(params){
	if (typeof(params) == "undefined") {
		var addType = 0; //添加购物车
	}
	else{
		var addType = 1; //绑定产品添加购物车
	}

	if(typeof(fbq) != 'undefined'){

		if(typeof(fbq) != 'undefined'){
			var first_source,campaign;
			if(typeof(fb_jsonNewFB.content_ids!='undefined')){
				first_source = fb_jsonNewFB.first_source;
				campaign = fb_jsonNewFB.campaign;
			}else{
				first_source = '';
				campaign = '';
			}
		}

		var lang = $('.top_right .language a.active').attr('code');
		lang = lang ? lang : 'en-GB';

		if(addType == 0){
			var price = $('.now').attr('oriPrice');
			if(typeof(fbq) != 'undefined'){
				var pid;
				pid = getFbCartValueId();

				var cc = [];
				var j = 0;
				$('.inhere').find('li').each(function(i){
					if(i > 1 && i % 2 == 0){
						cc[j] = $(this).find('span').eq(0).text();
						j++;
					}
				});
				cc = cc.join(' > ');
				var name = $('.good_main').find('h1').eq(0).text();
			}
		}
		else{
			//绑定产品添加购物车
			var price = params.price;
			var pid = params.pid;
			var cc = params.cc;
			var name = params.name;
		}

		fbq('track', 'AddToCart', {"content_type":"product","content_ids":pid,"value":price,"currency":'USD',"content_category":cc,"content_name":name,"page_lang":lang,"first_source":first_source,"campaign":campaign});
	}

}

var isAxajIng=false;

//Buy now
$(document).on("click",".buynow, .fast_addtocart .fast_addcart",function(){
	if($(this).hasClass('gray') || is_country_limit){
		return false;
	}
    addcartOrBuynow = true;
    if ($.trim($(this).attr('class')) == 'fast_addcart') {
        scollToGoodsMain = true;
    }

	var qty = $("#quantity").val();
	qty--;
	if(checkFlashDealNum(qty, 'add') == false)
	{
		return false;
	}

	//传递Facebook统计添加购物车数据
	sendFbAddCart();

	//获取选中的属性
	var selOpResult = getSelectedOptions();
	if(selOpResult==false){
		$('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
		return false;
	}
	if(selOpResult){
		if($('#isCheckStock').val()==1){//检查是否还在查库存状态
			return false;
		}
		for(var i = 0; i < selOpResult.optionIds.length; i++){
			var op = selOpResult.optionIds[i];
			var val = selOpResult.valueIds[i];
			var html = '<input type="hidden" name="id['+op+']" value="'+val+'" />';
			$('#detailCartForm').append(html);
		}
	}

	//获取赠品
	$('input[name="accesory_id[]"]').remove();
	var warehouse = $('#curWarehouse').val();
	if ($(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").length) {
		$(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").each(function () {
			var accesory_id = $(this).attr('acc_id');
			var accesory_attrs = '';
			$(".more_select_box_list[acc_id='"+accesory_id+"'][warehouse='"+warehouse+"']").find('.gift_attr').each(function () {
				var acc_option_id = $(this).attr('option_id');
				var acc_value_id = $(this).find('a.active').attr('value_id');
				accesory_attrs = accesory_attrs + '{' + acc_option_id + '}' + acc_value_id;
			});
			var accesory_cart_id = accesory_id + accesory_attrs;
			var html = '<input type="hidden" name="accesory_id[]" value="'+accesory_cart_id+'" />';
			$('#detailCartForm').append(html);
		});
	};

	if( $('#dianya_msg_buy').length > 0){
		var dianya_msg =  $('#dianya_msg_buy').val();
		if( dianya_msg != '' ){
			var _html = dianya_msg;
			$("#detail_add_cart_status").append(_html);
			$(".fast_addtocart_box").append(_html);
			return false;
		}
	}


	$("input[name=t]").val('countCartType');
	$("input[name=com]").val('product');
	var params = $('#detailCartForm').serialize();
	//检查是否超一百种类商品
	$.ajax({
		type: 'post',
		url:  '/index.php',
		data: params,
		dataType:'json',
		beforeSend:function(){
			$("input[name=com]").val('shopcart');
			$("input[name=t]").val('addProduct');
				//如果没有关闭提示窗口，阻击请求
			if(isAxajIng)
				return false;
			else
				isAxajIng=true;
		},
		success:function(res){
			isAxajIng=false;
			//单品超三百件，返回处理提示
            if(res.err==1){
            	showFlashDealsMsg('show', res.msg); //提示信息
            	$("#quantity").val(res.data);
            }else if(res.err==2){
            	//alert(res.msg);//超一百种商品，提示
            	modal_bg();
				msgbox(1, res.msg);
				$('.modal_msgbox_button').find('.button_yes').remove();
				$('.modal_msgbox_button').find('.button_no').before('<a href="/shopping_cart_new.php" class="button_yes">'+res.text+'</a>');
            }else{
            	_setDEMProductTOCart($('#products_id').val());
				$('#detailCartForm').submit();
			}
		}
	});



});

function checkvoltage(){
	$('#detailCartForm').submit();
}
function checkvoltageClose(){
	$('.voltage_tips').remove();
}

function titlescroll(){
	var shoesHeight = 0;
	if($(".detailpage").find(".new_arrivals_c").length>0){
		var shoesHeight = $(".new_arrivals_c").outerHeight();
	}
	/* 28679 */
	shoesHeight = 0;
	/* 28679 end*/
	if(($(".detailpage").offset().top-$(window).scrollTop()+shoesHeight+10)<0 && ($("#detail_reviews").offset().top-$(window).scrollTop()+shoesHeight-30)>0)
	{
		$(".detailpage").addClass("detailpage_fixed");
		if($(".fast_addtocart").length==0){
			$(".detailpage_fixed .good_tabs_title_desc").css('top','0');
		}
	}
	else
	{
		$(".detailpage").removeClass("detailpage_fixed");
	}
};
if ($('#addWsCoLumnToCart').length <= 0) {
	titlescroll();
}
$(window).scroll(function(){
	if ($('#addWsCoLumnToCart').length <= 0) {
		titlescroll();
	}
});



$(document).on("click",".detailpage_fixed .good_tabs_title_desc",function(){
	$(window).scrollTop($(".detailpage").offset().top+10);
	$(".detailpage").removeClass("detailpage_fixed");
});


$(document).on("mouseenter", ".warehouse .item_con ul:not('.only')", function(){
		$(this).addClass("active");
}).on("mouseleave click", ".warehouse .item_con ul:not('.only')", function(){
		$(this).removeClass("active");
});

var warehouse_clicked = 0;
$(document).on("click", ".warehouse .item_con ul li", function(){
	if($(this).hasClass('active')){
		return false;
	}

	if(warehouse_clicked == 1){
		return false;
	}
	warehouse_clicked = 1;
	selWarehouse(this);
	$(this).addClass('active');
	$(this).siblings().removeClass('active');
	warehouse_clicked = 0;
});


$(document).on("click",".addcart_status .close",function(){
	addCartClose();
});

function addCartClose(){
	var $this = $(".addcart_status .close");
	$this.parent().animate({"opacity":0},500,function(){
		$(this).hide();
		$(".good_main .buy").removeClass("buyz");
	});
}

//limit quantity number
$("#quantity").keyup(function(){
	var quantity = $("#quantity").val();

	if(quantity.length == 1){
		this.value=this.value.replace(/[^1-9]/g,'')
		$("#quantity").val($("#quantity").val().replace(/[^1-9]/g,''));
	}else{
		this.value=this.value.replace(/\D/g,'')
		$("#quantity").val($("#quantity").val().replace(/\D/g,''));
	}

	/*33704*/ 
	autoSubtotal();
	/*33704 end*/ 
})
//check quantity number
function chkQuantity(){
	var quantity = parseInt($("#quantity").val());
	if(!(/(^[0-9]\d*$)/.test(quantity)) || !quantity  || quantity == 0){
		quantity = 1;
	}
	$("#quantity").val(quantity);
}
$(document).on("click",".buy_link .addcart",function(){
//$(".buy_link .addcart").click(function(){
	if($(this).hasClass('gray')){
		return false;
	}
	//判断比价限购
        if($('#time_discount_limit_num').length>0 && $('#time_discount_limit_num').val()==0){
            if($(".good_main .quantity").children("u").length<1){
                var msg = $("#time_discount_limit_msg").text();
                $(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
                $(".good_main .quantity").html($(".good_main .quantity").children().slice(0,2));
                $(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
            }
	    return false;
	}

        //判断指定产品限购限购
        if($('#special_limit_num').length>0 && $('#special_limit_num').val()==0){
            if($(".good_main .quantity").children("u").length<1){
                var msg = $("#special_limit_msg").text();
                $(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
                $(".good_main .quantity").html($(".good_main .quantity").children().slice(0,2));
                $(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
            }
	    return false;
	}

    addcartOrBuynow = true;
	chkQuantity();

	var qty = $("#quantity").val();
	qty--;
	if(checkFlashDealNum(qty, 'add') == false)
	{
		return false;
	}

	//传递Facebook统计添加购物车数据
	sendFbAddCart();

	//获取选中的属性
	var selOpResult = getSelectedOptions();
	if(selOpResult==false){
		$('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
		return false;
	}
	if(selOpResult){
		if($('#isCheckStock').val()==1){//检查是否还在查库存状态
			return false;
		}
		for(var i = 0; i < selOpResult.optionIds.length; i++){
			var op = selOpResult.optionIds[i];
			var val = selOpResult.valueIds[i];
			var html = '<input type="hidden" name="id['+op+']" value="'+val+'" />';
			$('#detailCartForm').append(html);
		}
	}

	//获取赠品
	$('input[name="accesory_id[]"]').remove();
	var warehouse = $('#curWarehouse').val();
	if ($(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").length) {
		$(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").each(function () {
			var accesory_id = $(this).attr('acc_id');
			var accesory_attrs = '';
			$(".more_select_box_list[acc_id='"+accesory_id+"'][warehouse='"+warehouse+"']").find('.gift_attr').each(function () {
				var acc_option_id = $(this).attr('option_id');
				var acc_value_id = $(this).find('a.active').attr('value_id');
				accesory_attrs = accesory_attrs + '{' + acc_option_id + '}' + acc_value_id;
			});
			var accesory_cart_id = accesory_id + accesory_attrs;
			var html = '<input type="hidden" name="accesory_id[]" value="'+accesory_cart_id+'" />';
			$('#detailCartForm').append(html);
		});
	};

	var params = $('#detailCartForm').serialize();
	var nums = $('#quantity').val();
	//add by guoshigeng
	var products_id = parseInt($('#products_id').val());
	var text = $('.addcart_tips').find('b').eq(0).text();
	text = text.replace(/[0-9]*/, nums);

	if( $('#dianya_msg_cart').length > 0 ){
		var dianya_msg =  $('#dianya_msg_cart').val();
		if( dianya_msg != '' ){
			var _html = dianya_msg ;
			$("#detail_add_cart_status").append(_html);
			return false;
		}
	}



	$.ajax({
		type: 'post',
		url:  homeUrl+'index.php',
		data: params,
		dataType:'json',
		beforeSend:function(){
			//如果没有关闭提示窗口，阻止请求
			if(isAxajIng)
				return false;
			else
				isAxajIng=true;
		},
		success:function(res){
            isAxajIng=false;
			//单品超三百件，返回处理提示
            if(res.err==1){
            	showFlashDealsMsg('show', res.msg); //提示信息
            	$("#quantity").val(res.data);
            }else if(res.err==2){
            	//alert(res.msg);//超一百种商品，提示
            	modal_bg();
				msgbox(1, res.msg);
				$('.modal_msgbox_button').find('.button_yes').remove();
				$('.modal_msgbox_button').find('.button_no').before('<a href="/shopping_cart.html" class="button_yes">'+res.text+'</a>');
            }else{

            	$('.addcart_tips').find('b').eq(0).text(text);

				$(".addcart_status").show().css("opacity","1");
				$(".addcart_hotlist").html($(".hotgoods_970").html());
				$(".addcart_hotlist .goodlist_1").css("margin-left",0);
				$(".addcart_hotlist .chang").removeClass("btn_off");
				ChangeHotgood970();
				scroll_play('.addcart_hotlist',4);
				$(".good_main .buy").addClass("buyz");
            	 //如果有比价限购
                 if($('#time_discount_limit_num').length>0){
                    $('#time_discount_limit_num').val($('#time_discount_limit_num').val()-nums > 0 ? $('#time_discount_limit_num').val()-nums:0);
                 }

                if($('#special_limit_num').length>0){
                    $('#special_limit_num').val($('#special_limit_num').val()-nums > 0 ? $('#special_limit_num').val()-nums:0);
                }
            	loadHeadCart();

            	/*set DBM cookies #36733*/
            	_setDEMProductTOCart(products_id);
            	if(typeof(pintrk) != 'undefined'){
            		var productName = document.querySelector("meta[property='og:title']").getAttribute('content'),
						productId = $('#products_id').val(),
						productPrice = document.querySelector("meta[itemprop='price']").getAttribute('content'),
						allproductcategory = PinterestTrackItem._GetProductCategory(),
						allproductlist = [],
						valueIDarr = [];
					if($('.good_main .item_box.attr').length > 0){
						$('.good_main .item_box.attr').each(function(){
							var value_id = $(this).find('.hasclicked').attr('title');
							if(value_id.length == 0){
								value_id = $(this).find('.hasclicked').attr('value_id');
							}
							valueIDarr.push(value_id);
						});
					}
					valueIDarr = valueIDarr.join(',');
					allproductlist.push({
	                	product_name: productName,
	                	product_id: productId,
	                	product_price: productPrice,
	                	product_quantity: $('#quantity').val(),
	                	product_variant:valueIDarr,
	                	product_category:allproductcategory
	                });
            		pintrk('track', 'AddToCart', {
					    value: $('.good_main .price .now').attr('oriprice'),
					    currency: 'USD',
					    lead_type:PinterestTrackItem._GetCookie('__bgqueue').split('|')[1],
					    line_items:allproductlist
					  });
            	}
            }
		}
	});
});

function _setDEMProductTOCart(products_id){
	var DEMProduct = products_id;
	var DEMProductPRICE = document.querySelector('meta[itemprop="price"]').getAttribute('content');
	if(document.querySelector('meta[itemprop="sku"]') != null){
        DEMProduct = document.querySelector('meta[itemprop="sku"]').getAttribute('content');
    }
	window.localStorage.setItem("_DBMLastProductID",DEMProduct);
	window.localStorage.setItem("_DBMLastProductPRICE",DEMProductPRICE);
}

function checkvoltageaddClose(){
	$(".voltage_tips").remove();
}
function checkvoltageadd(){
	var params = $('#detailCartForm').serialize();
	var nums = $('#quantity').val();
	var text = $('.addcart_tips').find('b').eq(0).text();
	text = text.replace(/[0-9]*/, nums);
	$('.addcart_tips').find('b').eq(0).text(text);
	$(".voltage_tips").remove();
	$(".addcart_status").show().css("opacity","1");
	$(".addcart_hotlist").html($(".hotgoods_970").html());
	scroll_play('.addcart_hotlist',4);
	$(".good_main .buy").addClass("buyz");
	$.ajax({
		type: 'post',
		url:  homeUrl+'index.php',
		data: params,
		dataType:'json',
		success:function(res){
			loadHeadCart();
		}
	});
}

//属性图片点击操作
function clickAttrPic(obj, flag){
	flag = flag || '1';
	var tinyImage = $(obj).attr('src');
	var viewImage = $(obj).attr('viewImage');
	var largeImage = $(obj).attr('largeImage');
	$(".good_photo_max div").html("<img src='"+viewImage+"' />");
	$(".good_photo_max").addClass("good_photo_max_attr");
	$('.good_photo_zoom span').html("<img src='"+largeImage+"' />");
	if (flag == '1') {
		$('.fast_product .img').html("<img src='"+tinyImage+"' />");
	};
}

$(".good_main .attrimg").mouseenter(function(){
	clickAttrPic($(this).find("img").eq(0), '0');
});
$(".good_main .attrimg").mouseleave(function(){
	var viewImage = $(this).parent().find(".imgactive").find("img").attr('viewImage');
    if (viewImage != undefined)
        $(".good_photo_max div").html("<img src='"+viewImage+"' />");
});


//配件选择功能
//var item_attr_box=$(".goods_together .item_attr_box");
$(document).on("click",".goods_together .price",function(){
	if ($('#addWsCoLumnToCart').length <= 0) {
		var li=$(this).parents("li"),
			$checkbox = $(this).find('span');
		var item_attr_box=$(".goods_together .item_attr_box");
		if(!li.hasClass("selected")){
			if(li.hasClass("hasattr")){
				goods_getattr(li.attr("id"));
				//$(".goods_together .item_attr_list ."+ li.attr("id")).show().siblings().hide();
				$(".goods_together .item_attr_list").children().hide();
				$(".goods_together .item_attr_list ."+ li.attr("id")).show();
				$(".goods_together").addClass("goods_together_zindex");
				if(li.parent().parent().hasClass("thisitem")){
					item_attr_box.fadeIn().css({"left":16});
				}else{
					item_attr_box.fadeIn().css({"left":$(this).position().left + 284});
				}
			}
	        $checkbox.removeClass('checkbox_on');
	        $checkbox.addClass('checkbox_on_active');

		}else{
	        $checkbox.removeClass('checkbox_on_active');
	        $checkbox.addClass('checkbox_on');
			$(".goods_together").removeClass("goods_together_zindex");
			item_attr_box.fadeOut();
		}
		//获取主产品id
		var main_pid = $("#main_pro_bdl").val();
		li.toggleClass("selected");
		$("#selected_main").removeClass("checkbox_on");
		$("#selected_main").addClass("checkbox_on_active");
		var tmpObj = $checkbox;
		$('.btn').find('.re_ok').eq(0).addClass('ok');
		$('.btn').find('.re_ok').eq(0).removeClass('cancel');
		if(li.hasClass('hasattr')){
			var id = li.attr("id");
			var arr = new Array();
			arr =id.split("_");
			var bdl_pid = arr[1];
			var tmpflag = false;
			$('.item_' + bdl_pid).find('img').each(function(){
	            if ($(this).attr('src') == '') {
	                // 勾选再加载poa图片
	                $(this).attr('src', $(this).attr('osrc'));
	            }
	        });
			$('.item_' + bdl_pid).find('a').each(function(){
				if($(this).hasClass('out_stock')){
					tmpObj.removeClass("checkbox_on_active");
					tmpObj.addClass("checkbox_on");
					li.removeClass('selected');
	                $(this).removeClass('checkbox_on_active');
	                $(this).addClass('checkbox_on');
					tmpflag = true;
				}
			});
			if(tmpflag){
				$('.btn').find('.re_ok').eq(0).addClass('cancel');
				$('.btn').find('.re_ok').eq(0).removeClass('ok');
			}
		}

		calculateBundlePrice();
	}
});

$(document).on("click",".goods_together .item_attr_box .close,.goods_together .item_attr_box .cancel,.goods_together .chang",function(){
	$(".goods_together").removeClass("goods_together_zindex");
	var item_attr_box=$(".goods_together .item_attr_box");
	item_attr_box.fadeOut();
});
$(document).on("click",".goods_together .item_attr_box .ok",function(){
	$(".goods_together").removeClass("goods_together_zindex");
	var item_attr_box=$(".goods_together .item_attr_box");
	item_attr_box.fadeOut();
	//alert($(".goods_together .item_attr_list > div:visible").html());
	//$(".goods_together .selected_total strong").html("US $200.99");
});

//edit-by-zyh-2014-7-22
function goods_getattr(obj){
    var arr = new Array();
	arr =obj.split("_");
	var bdl_pid = arr[1];
	//发送ajax请求
	if($(".goods_together .item_attr_list ."+obj).length==0){
		//$(".goods_together .item_attr_list").append('<div class=\"'+ obj +'\">'+ $("#temptest").html() +'</div>');
		 //产品id
		var main_pid = $("#main_pro_bdl").val();
		//副产品id
		//ajax请求
		$.ajax({
			type: 'post',
			url: homeUrl + 'index.php',
			data: {'com':'product','t':'getBundleAttr','main_pid':main_pid,'bdl_pid':bdl_pid},
			dataType: 'html',
			// async: false,
			beforeSend: function(){
			    $(".goods_together .item_attr_box").addClass("loading");
				$(".btn").hide();
			},
			success: function(res){
			    $(".goods_together .item_attr_list").append('<div class=\"'+ obj +'\">'+ res +'</div>');
			},
			complete: function(){
			    $(".goods_together .item_attr_box").removeClass("loading");
				$(".btn").show();
			}
		});
	}
}

//计算绑定产品的价格-by-zyh-2014-7-22
function calculateBundlePrice(){
    var total_price = 0;
	var ori_total_price = 0;

    var main_price_cur = 0;

	var main_price = $("#main_pro_val").val();

	var main_oriPrice = $("#main_pro_val").attr('oriPrice');

	var newOriPrice = $("#main_pro_val").attr('newOriPrice');
	//产品数量
	var goods_numbers = 1;

	if($(".goods_together .thisitem li").hasClass("hasattr")){
	    var main_pid = $("#main_pro_bdl").val();
	    //获取属性id
		var mobjAttr = $(".goods_together .item_attr_list .item_" + main_pid);
		mobjAttr.find(".active,.imgactive").each(function(){
			var moptions_val_id = $(this).attr('value_id');
            var mAttrPrice = $("#mAttr_" + main_pid + '_' + moptions_val_id).val();
			var mOriAttrPrice = $("#mAttr_" + main_pid + '_' + moptions_val_id).attr('oriPrice');
		    var currency = getCookieCurrency();

			main_oriPrice = newOriPrice * 1 + mOriAttrPrice * 1;
		   // main_oriPrice = $(".good_main .price .now ").attr("oriprice");
		    $("#main_pro_val").attr("oriPrice",main_oriPrice);
		    $(".goods_together .thisitem li .price").attr("oriPrice",main_oriPrice);
            main_price_cur = getPriceByCurrency(main_oriPrice, currency);

		});
        if  (main_price_cur > 0) {
            if($("#currencyPrefix_bdl").val() == 'руб.' || $("#currencyPrefix_bdl").val() == 'AED' ){
                if ($("#currencyPrefix_bdl").val() == 'AED') {
                    $(".goods_together .thisitem li").find('.price').eq(0).html('<span class="checkbox_on_active" id="selected_main"><i></i></span>' + formatNum(float_decimal(main_price_cur,2),2) + ' ' + $("#currencyPrefix_bdl").val());
                } else {
                    $(".goods_together .thisitem li").find('.price').eq(0).html('<span class="checkbox_on_active" id="selected_main"><i></i></span>' + formatNum(float_decimal(main_price_cur,2),0) + ' ' + $("#currencyPrefix_bdl").val());
                }
            }else{
                $(".goods_together .thisitem li").find('.price').eq(0).html('<span class="checkbox_on_active" id="selected_main"><i></i></span>' + $("#currencyPrefix_bdl").val() + formatNum(float_decimal(main_price_cur,2),2));
            }
        }

	}
	total_price = total_price + (main_price_cur > 0 ? main_price_cur : main_price) * 1;
	ori_total_price = main_oriPrice * 1;
    $(".goods_together .scroll_box li").each(function(){
	    if($(this).hasClass("selected")){
			var final_price = $(this).find(".final_price").val();
			var ori_final_price = $(this).find(".final_price").attr('oriPrice');
			if ($('#addWsCoLumnToCart').length > 0) {
                var value = $(this).find('.quantity01 input:text').val();
               	if (value >= 3 && value < 10) {
               		final_price = parseFloat($(this).find('.price.now_1').attr('oriprice3'));
               		ori_final_price = parseFloat($(this).find('.price.now_1').attr('oriprice3'));
               	} else if (value >= 10 && value < 30) {
               		final_price = parseFloat($(this).find('.price.now_1').attr('oriprice10'));
               		ori_final_price = parseFloat($(this).find('.price.now_1').attr('oriprice10'));
               	} else if (value >= 30 && value < 100) {
               		final_price = parseFloat($(this).find('.price.now_1').attr('oriprice30'));
               		ori_final_price = parseFloat($(this).find('.price.now_1').attr('oriprice30'));
               	} else if (value > 100) {
               		final_price = parseFloat($(this).find('.price.now_1').attr('oriprice100'));
               		ori_final_price = parseFloat($(this).find('.price.now_1').attr('oriprice100'));
               	}
			}

			//计算属性价
			if($(this).hasClass("hasattr")){
				var bdl_str = $(this).attr("id");
				var bdl_arr = bdl_str.split('_');
				var bdl_pid = bdl_arr[1];

				//获取属性id
			    var objAttr = $(".goods_together .item_attr_list .item_" + bdl_pid);
				//var chgShw = false;
				objAttr.find(".active,.imgactive").each(function(){
				    var options_val_id = $(this).attr('value_id');
			        var attrPrice = $("#bdAttr_" + bdl_pid + '_' + options_val_id).val();
					var oriAttrPrice = $("#bdAttr_" + bdl_pid + '_' + options_val_id).attr('oriPrice');
					if ($('#addWsCoLumnToCart').length > 0) {
						final_price = final_price * 1;
						ori_final_price = ori_final_price * 1;
					} else {
						final_price = final_price * 1 + attrPrice * 1;
						ori_final_price = ori_final_price * 1 + oriAttrPrice * 1;
					}

				});
				if($("#currencyPrefix_bdl").val() == 'руб.' || $("#currencyPrefix_bdl").val() == 'AED'){
                    if ($("#currencyPrefix_bdl").val() == 'AED') {
                        $(this).find('.price').eq(0).html('<span class="checkbox_on_active"><i></i></span>' + formatNum(float_decimal(final_price,2),2) + ' ' + $("#currencyPrefix_bdl").val());
                    } else {
                        $(this).find('.price').eq(0).html('<span class="checkbox_on_active"><i></i></span>' + formatNum(float_decimal(final_price,2),0) + ' ' + $("#currencyPrefix_bdl").val());
                    }
                }else{
					$(this).find('.price').eq(0).html('<span class="checkbox_on_active"><i></i></span>' + $("#currencyPrefix_bdl").val() + formatNum(float_decimal(final_price,2),2));
				}
				$(this).find('.price').eq(0).attr('oriPrice', ori_final_price);
				//return false;
			}


			total_price = total_price + final_price * 1;
			ori_total_price = ori_total_price + ori_final_price * 1;
			goods_numbers++;
		}
	});

	total_price = float_decimal(total_price,2);
	ori_total_price = float_decimal(ori_total_price,2);

	ori_total_price = formatNum(ori_total_price,2);
	var currencyPrefix = $("#currencyPrefix_bdl").val();
	if(currencyPrefix == 'руб.' || currencyPrefix == 'AED'){
        if (currencyPrefix == 'AED') {
            total_price = formatNum(total_price,2);
        } else {
            total_price = formatNum(total_price,0);
        }
		total_price = total_price + ' ' + currencyPrefix;
	}else{
	    total_price = formatNum(total_price,2);
		total_price = currencyPrefix + ' ' + total_price;
	}
	$(".goods_together .selected_total strong").html(total_price);
	$(".goods_together .selected_total strong").attr('oriPrice', ori_total_price);
	$("#show_bdl_num").html(goods_numbers);
}

 //格式化金额-by-zyh-2014-7-22
function formatNum(num,n)
{//参数说明：num 要格式化的数字 n 保留小数位
	 num = String(num.toFixed(n));
	 var re = /(-?\d+)(\d{3})/;
	 while(re.test(num)) num = num.replace(re,"$1,$2");
	 return num;
}
//四舍五入浮点数-by-zyh-2014-7-22
function float_decimal(num,v)
{
    var vv = Math.pow(10,v);
    return Math.round(num*vv)/vv;
}
//add-by-zyh
$(document).on("click",".goods_together .selected_cart",function(){
	if($(this).hasClass('gray') || is_country_limit){
		return false;
	}
	if($(this).hasClass("selected_cart_loading")){return false;};
	$(this).addClass("selected_cart_loading");
	addBundleToCart();
});
$(document).on("click",".goods_together .buy_now",function(){
	if($(this).hasClass('gray') || is_country_limit){
		return false;
	}
	if($(this).hasClass("selected_cart_loading")){return false;};
	$(this).addClass("selected_cart_loading");
	addBundleToCart(1);
});
//把绑定数据放进购物车-by-zyh-2014-7-23
function addBundleToCart(toShopcart){
	if (typeof(toShopcart) == "undefined") {
		var toShopcart = 0;
	}
    addcartOrBuynow = true;
    scollToGoodsMain = true;
    if (!validateSelOptions()) {
        $(".goods_together .selected_cart").removeClass("selected_cart_loading");
        $(".goods_together .buy_now").removeClass("selected_cart_loading");
        $('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
        return false;
    }
    var params = '';
	//仓库
	var warehouse = $("#curWarehouse").val();
	//主产品属性
	var main_pid = $("#main_pro_bdl").val();
	var moptions = '';
	if($(".goods_together .thisitem li").hasClass("hasattr")){
	    //获取属性id
		var mobjAttr = $(".goods_together .item_attr_list .item_" + main_pid);
		mobjAttr.find(".active,.imgactive").each(function(){
			var moptions_id = $(this).parent().attr("option_id");
			var moptions_val_id = $(this).attr('value_id');
			var moptions_str = moptions_id + '-' + moptions_val_id;
			moptions = moptions + moptions_str + '_';
		});
		moptions = moptions.substring(0,moptions.length-1);
	}
	params = params + main_pid + '_' + moptions + '>' + warehouse + '|';
	//统计产品数量
	var goods_num = 1;
    $(".goods_together .scroll_box li").each(function(){
	    if($(this).hasClass("selected")){
		   var bdl_str = $(this).attr("id");
		   var bdl_arr = bdl_str.split('_');
		   var bdl_pid = bdl_arr[1];
		   var options = '';
		   //判断它是否有属性
		   if($(this).hasClass("hasattr")){
		       //获取属性id
			    var objAttr = $(".goods_together .item_attr_list .item_" + bdl_pid);
				objAttr.find(".active,.imgactive").each(function(){
				    var options_id = $(this).parent().attr("option_id");
				    var options_val_id = $(this).attr('value_id');
					var options_str = options_id + '-' + options_val_id;
					options = options + options_str + '_';
				});
				options = options.substring(0,options.length-1);
		   }

		   //获取产品的仓库
		   var the_warehouse = $(this).find(".the_warehouse").val();
		   params = params + bdl_pid + '_' + options + '>' + the_warehouse + '|';
		   goods_num++;
		}
	});
	if(params.length > 2){
	    params = params.substring(0,params.length-1);
	}


	//发送ajax请求
	$.ajax({
	    type: 'post',
		url: homeUrl + 'index.php',
		data: {'com':'product','t':'addBundleToCart','params':params},
		dataType: 'json',
		success: function(res){
			if(res.error == 0){
				_setDEMProductTOCart($('#products_id').val());
				if (toShopcart == 1) {
					window.location.href = '/shopping_cart.html';
				} else {
					//加载头部购物车
					loadHeadCart();
					modal_bg();
					msgbox(0,res.msg);
					sumCartGoodsNum(goods_num);
				}

				$.ajax({
				    type: 'post',
					url: homeUrl + 'index.php',
					data: {'com':'product','t':'getProductFBParam','params':params},
					dataType: 'json',
					success: function(dres){
						if(dres.error == 0){
							var fBP = {};
							fBP.price = $(".goods_together_sub .selected_total strong").attr('oriPrice');
							fBP.pid = dres.pid;
							fBP.cc = dres.cc;
							fBP.name = dres.name;

							//传递Facebook统计添加购物车数据
							sendFbAddCart(fBP);
						}
					 }
				});
			}
			$(".goods_together .selected_cart").removeClass("selected_cart_loading");
		}
	});
}

//计算购物车的产品个数
function sumCartGoodsNum(goods_num){
    //get goods_nums
	var hasGoodsNum = $("#cart_nums_id").html();
	var total_nums = goods_num * 1 + hasGoodsNum * 1;
	$(".cart_number").html(total_nums);
}

//add to wish list
$(document).on("click",".goods_together .selected_wish",function(){
    var pids = '';
    var main_pid = $('#products_id').val();
    var validSelect = 0;
    $(".goods_together li").each(function(){
	    if($(this).hasClass("selected")){
	    	validSelect++;
		    var pid_str = $(this).attr("id");
		    var pid_arr = pid_str.split('_');
		    var pid = pid_arr[1];
			pids = pids + pid + '|';
		}
	});

    //没有勾选要收藏的产品
	if (validSelect == 0){
		modal_bg();
		msgbox(0, selected_none);
		return false;
	}
	// 防止多次点击
	if($('.goods_together .selected_wish').hasClass('gray')) return false;
	$('.goods_together .selected_wish').addClass('gray');

	$.ajax({
		type: 'post',
		url: homeUrl + 'index.php',
		data: {'com':'product','t':'addManyWishList','pids':pids, 'main_pid':main_pid},
		dataType: 'json',
		success: function(res){
			$('.goods_together .selected_wish').removeClass('gray');
		    if(res.login){
			    login();
			}else{
				if(res.mainProductAmount) $('.addwish').find('u').text(res.mainProductAmount);
			    countWishList(res.nums);
			    modal_bg();
				msgbox(0, res.msg);
			}
		}
	});
});

//计算wishlist的个数
function countWishList(num){
    var old_num = $("#userwish").html();
	var new_num = old_num * 1 + num * 1;
	$("#userwish").html(new_num);

}

function changeGrowthPrice(poa_diff){
	if ($(".good_main .vip_price").length == 0) return false;
	
	var selOptions = getSelectedOptions();	
    if (selOptions == false){
    	return false;
    }
    var curPoaPrice = 0;
    poa_diff = parseFloat(poa_diff);
    if(typeof poa_diff != 'undefined' && !isNaN(poa_diff)){
    	 curPoaPrice = poa_diff;
    }else{
    	var divID = 'stockMsg_'+$('#curWarehouse').val();
		var selOptions = getSelectedOptions();
		var poaDivId = divID;
        if (selOptions != false) {
            if(selOptions.valueIds.length > 0){
                for(var i = 0; i < selOptions.valueIds.length; i++){
                	poaDivId += '_'+selOptions.valueIds[i];
                }
            }
        }
        
        var obj = $("#"+poaDivId).length > 0 ? $("#"+poaDivId) : $("#"+divID); 
    	curPoaPrice = parseFloat($(obj).attr("poaDiffPrice"));
    	curPoaPrice = isNaN(curPoaPrice) ? 0 : curPoaPrice;
    }
    
    //poa变化时VIP下一等级价格也变化
	var currency = getCookieCurrency();
	//var curPoaPrice = parseFloat($(obj).attr('oriprice'));
	//if ($(obj).attr('price_prefix') == "-") curPoaPrice = -curPoaPrice;

	if ($(".vip_price").find(".Lower_prices").length > 0){
		var vipUpgradePrice = parseFloat($(".vip_price").find(".Lower_prices").attr("data-oriprice-nopoa"));
		$(".vip_price").find(".Lower_prices").attr("data-oriprice", vipUpgradePrice + curPoaPrice);
		$(".vip_price .Lower_prices").find("em").html(getPriceByCurrency(vipUpgradePrice + curPoaPrice, currency, true));
	}else if($(".vip_price").find(".p_content").length > 0){
		var vipTipPrice = parseFloat($(".vip_price").find(".p_content").attr("data-oriprice-nopoa"));
		$(".vip_price").find(".p_content").attr("data-oriprice", vipTipPrice + curPoaPrice);
		var formatNewTipPrice = getPriceByCurrency(vipTipPrice + curPoaPrice, currency, true); //console.log(formatNewTipPrice);console.log(formatNewTipPrice.replace(/\d*/g, '') + "<strong>"+formatNewTipPrice.replace(/[^\d]*/g, '')+"</strong>");
		$(".vip_price .p_content").find("em").html(formatNewTipPrice.replace(/\d+((,|\.)\d+)?/g, '') + "<strong>"+formatNewTipPrice.replace(/(\D+(,|\.)?)+/, '')+"</strong>");
	}
}

function checkAttrStock(obj, init,getCurWarehouse){
	//主产品修改 绑定产品也跟着变化
    bundle_same(1);

    //切换仓库,所有选择的属性去掉
    //getCurWarehouse == 1是首次ajax加载，首次加载不需要去掉已选属性，防止单属性或者是Url自动选择的属性被取消选择
    if(init == true && getCurWarehouse != 1){
        $('.attrValues').each(function(){
            if($(this).hasClass("attrimg"))
            {
                $(this).removeClass("imgactive").find("i").remove();
                $(this).removeClass("active").removeClass("hasclicked");
                $(this).removeClass('out_stock_img');
                $(this).find('span').remove();
            }else{
                $(this).removeClass("active").find("i").remove();
                $(this).removeClass("imgactive").removeClass("hasclicked");
                $(this).removeClass('out_stock');
            }
        })
		if(!G_autoSelAttrByUrl){
			autoSelAttrByUrl();
		}
	}
    changeGrowthPrice();
	var products_id = $('#products_id').val();
	var warehouse = $('#curWarehouse').val();

	//var data = 'com=product&t=checkAttrStockInfo';
	var data = '';

	//ajax请求改成伪静态重定向
	var ajaxUrl = homeUrl+'ajax/checkAttrStockInfo/'+products_id+'/'+warehouse+'.html';
	//把客户端的国家也做成缓存规则中去
	eval('var countryCookie = '+$.cookie("countryCookie")+';');
	data += 'clientCountry='+countryCookie.code;

	//data += '&products_id='+products_id;
	//data += '&warehouse='+warehouse;
    data += '&this_value_ids='+$(obj).attr('value_id');
    data += '&this_option_ids='+$(obj).attr('option_id');

    if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}

	//Get selected options

    /*
	var selOptions = getSelectedOptions();
	if(selOptions && selOptions.valueIds.length > 0){
		for(var i = 0; i < selOptions.valueIds.length; i++){
			data += '&option_ids[]='+selOptions.optionIds[i];
			data += '&value_ids[]='+selOptions.valueIds[i];
		}
	}
	*/

    //如果全选上了不做操作

//    if(validateSelOptions()){
//        return true;
//    }
	var optionList = $('.good_main .attr');
	var optionIds = new Array;
	var valueIds = new Array;
    optionList.each(function(){
		var option_id = $(this).attr('option_id');
		var value_id = 0;
		$(this).find('a').each(function(){
			var acClass = $(this).hasClass('attrimg') ? 'imgactive' : 'active';
			if($(this).hasClass(acClass)){
				value_id = $(this).attr('value_id');
				return false;
			}
		});
		optionIds.push(option_id);
		valueIds.push(value_id);
	});

    var this_opids = new Array;
    var this_valid = new Array;
 	if(valueIds && valueIds.length > 0){
		for(var i = 0; i < valueIds.length; i++){
            if(valueIds[i]!=0){
                data += '&option_ids[]='+optionIds[i];
                data += '&value_ids[]='+valueIds[i];
                this_opids[this_opids.length] = optionIds[i];
                this_valid[this_valid.length] = valueIds[i];
            }
		}
	}

    var this_opid_tmp = $(obj).attr('option_id');

	$.ajax({
		url:ajaxUrl,
		type : 'get',
		data :data,
		dataType:'json',
		success:function(res){
            if(res.allShow==true){
                return true;
            }else{
                //如果是初始化
                if(init==true){
                    $('.attrValues').each(function(){
                        if( $.inArray($(this).attr('value_id'), res) != -1){
                            if($(this).find('img').length > 0){
                                $(this).removeClass('out_stock_img');
                                $(this).find('span').remove();
                            }else{
                                $(this).removeClass('out_stock');
                            }
                        }
                    });


                    $('.attrValues').each(function(){
                        if( $.inArray($(this).attr('value_id'), res) == -1 ){
                            //if(!$.inArray($(this).attr('value_id'), this_valid)){
                                if($(this).find('img').length > 0){
                                    $(this).addClass('out_stock_img');
                                    $(this).removeClass('imgactive');
                                    if($(this).find('span').length <= 0) $(this).append('<span></span>');
                                }else{
                                    $(this).addClass('out_stock');
                                    $(this).removeClass('active');
                                }
                           // }
                        }
                    });
                    return true;
                }

                $('.attrValues').each(function(){
                    if(this_opid_tmp != $(this).attr('option_id')  && $.inArray($(this).attr('value_id'), res) != -1){
                        if($(this).find('img').length > 0){
                            $(this).removeClass('out_stock_img');
                            $(this).find('span').remove();
                        }else{
                            $(this).removeClass('out_stock');
                        }
                    }
                });


                $('.attrValues').each(function(){
                    if(this_opid_tmp != $(this).attr('option_id')  && $.inArray($(this).attr('value_id'), res) == -1 ){
                        //if(!$.inArray($(this).attr('value_id'), this_valid)){
                            if($(this).find('img').length > 0){
                                $(this).addClass('out_stock_img');
                                $(this).removeClass('imgactive');
                                if($(this).find('span').length <= 0) $(this).append('<span></span>');
                            }else{
                                $(this).addClass('out_stock');
                                $(this).removeClass('active');
                            }
                       // }
                    }
                });

                if ($('#addWsCoLumnToCart').length > 0) {
					discountNum();
				}

            }
		}
	});

}

checkAttrStock(null, true,1);

function pinModule(){
	modal_bg();
	$('.modal_container').append($('#pinModule').html());
	//console.log($('#pinModule').html());
	modal_add();
	$('.modal_pinterest_con ul').each(function(){
		$(this).find('img').attr('src',$(this).find('img').attr('data-src'));
	});
}

var wrap_left_btn_status=false;
$(".detailpage .wrap_left_btn").click(function(){
	$(".detailpage").toggleClass("detailpage_close");
	wrap_left_btn_status=true;
	if($(this).find(".arrow_c").length > 0){
		$(this).find("span").attr("class","arrow_d");
		$(".fast_addtocart_box").css("left",0);
	}else{
		$(this).find("span").attr("class","arrow_c");
		$(".fast_addtocart_box").css("left",-230);
	}
});
if ($('#addWsCoLumnToCart').length <= 0) {
	wrap_left_btn();
}
$(window).scroll(function(){
	if ($('#addWsCoLumnToCart').length <= 0) {
		wrap_left_btn();
	}
	//wrap_left_btn_hide();
});
function wrap_left_btn(){
	var height_=$(window).scrollTop()-$(".detailpage").offset().top;
	var height_2=height_-parseInt($(".detailpage").outerHeight())+600;
	if(height_>0)
	{
		if(height_2<0)
		{
		$(".detailpage .wrap_left_btn").css("top",height_+300);
		}
	}else{
		$(".detailpage .wrap_left_btn").css("top",300);
	}
}
function wrap_left_btn_hide(){
	if(wrap_left_btn_status){return false}
	var height_ = $(window).scrollTop() - ($(".detailpage").offset().top + $(".wrap_left").height());
	if(height_>0)
	{
		$(".detailpage").addClass("detailpage_close");
		$(".detailpage .good_tabs_title_desc").width(1200);
		$(".detailpage .wrap_left_btn .arrow_c").attr("class","arrow_d");
	}else{
		$(".detailpage").removeClass("detailpage_close");
		$(".detailpage .good_tabs_title_desc").width(960);
		$(".detailpage .wrap_left_btn .arrow_d").attr("class","arrow_c");
	}

}

function TouchFunc(obj,range){

	$("html,body").one("click",function(){
		//window.history.go(-1);
	});
	var startX = 0, startY = 0, endW = 0, endH = 0, endAbs=0, isSilder = false, windowWidth = 0, swipe_left = 0 ;

	var objUl = $(obj+" ul");
	var Ohtml = '';
	var Vkey = objUl.attr('key')-1;//当前图片位置
	var Vlen = $(obj+" ul li").length;//图片总数

	install();

	$(obj+" ul li").each(function(){
		Ohtml = Ohtml + '<li />'
	});

	objUl.after("<ol>"+ Ohtml +"</ol>").after("<div class='close'>×</div>")
	$(obj+" ol li:eq(" + Vkey + ")").addClass("active");

	objUl.each(function(){
		$(this)[0].addEventListener('touchstart', touchSatrtFunc, false);
		$(this)[0].addEventListener('touchmove', touchMoveFunc, false);
		$(this)[0].addEventListener('touchend', touchEndFunc, false);
		$(this)[0].addEventListener('touchcancel', touchEndFunc, false);
	});

	window.addEventListener("onorientationchange" in window ? "orientationchange" : "resize", orientationChange, false);

	function orientationChange(){
		switch(window.orientation) {
			case 0: install();
			break;
			case 180: install();
			break;
			case -90: install();
			break;
			case 90: install();
			break;
		}
	}

	function install(){
		objUl.css({"-webkit-transition": "0s"});
		var objLi = $(obj+" ul li");
		windowWidth = $(window).width();
		objLi.width(windowWidth);
		objLi.height($(window).height());
		objUl.css({"width" : objLi.length * windowWidth , "margin-left" : -Vkey * windowWidth + 'px'});
		$(window).scrollTop(100);//防止出现下移情况
		//$(obj+" ul li:odd").css("background","#f2f2f2");
	}

	function touchSatrtFunc(evt) {
		try
		{
			var touch = evt.touches[0]; //获取第一个触点
			var x = Number(touch.pageX); //页面触点X坐标
			var y = Number(touch.pageY); //页面触点Y坐标
			swipe_left = 0;
			startX = x;
			startY = y;
			objUl.css({"-webkit-transition": "0s"});
		}
		catch (e) {
		}
	}

	function touchMoveFunc(evt) {
		try
		{
			var touch = evt.touches[0];
			var x = Number(touch.pageX);
			var y = Number(touch.pageY);

			endW = x - startX;
			endH = y - startY;
			endAbs = Math.abs(endW) - Math.abs(endH);

			if (endW != 0 && endAbs > 0) {
				if(endW > 0)
				{
					swipe_left = -1;
					evt.preventDefault();
					objUl.css("margin-left", -windowWidth * Vkey + endW);
				}
				else if(endW < 0)
				{
					swipe_left = 1;
					evt.preventDefault();
					objUl.css("margin-left", -windowWidth * Vkey + endW);
				}
				isSilder = true;
			}


			if (endH != 0) {
				evt.preventDefault();
			}
		}
		catch (e) {
		}
	}

	function touchEndFunc(evt) {
		try {
			//向左滑是1; 嵩哥
			if(isSilder){
				objUl.css({"-webkit-transition": "0.5s"});
				if(swipe_left == -1){
					if(endW > range){
						if($(obj+" ol li.active").index()==0)
						{
							objUl.css({"margin-left": 0});
						}
						else
						{
							Vkey--;
							objUl.css({"margin-left": - windowWidth * Vkey});
							$(obj+" ol li:eq(" + Vkey + ")").addClass("active").siblings().removeClass("active");
						}
					}
					else
					{
							objUl.css({"margin-left": - windowWidth * Vkey});
					}
				}
				else if(swipe_left == 1){
					if(endW < -range){
						if($(obj+" ol li.active").index() == Vlen-1)
						{
							objUl.css({"margin-left": - windowWidth * (Vlen - 1)});
						}
						else
						{
							Vkey++;
							objUl.css({"margin-left": - windowWidth * Vkey});
							$(obj+" ol li:eq(" + Vkey + ")").addClass("active").siblings().removeClass("active");
						}
					}
					else
					{
							objUl.css({"margin-left": - windowWidth * Vkey});
					}
				}
			}
		}
		catch (e) {
		}
	}
}


$(document).on("mouseenter",".good_main .gift",function(){
	$(".good_main .gift_tips").stop().slideDown();
});
$(document).on("mouseleave",".good_main .gift",function(){
	$(".good_main .gift_tips").hide();
});
$(document).on("click",".good_main .gift",function(){
	$(".goods_together_new .scroll_box .goodlist_1 li.my_gift_box").append('<div class="giftborder" />');
	$('html,body').animate({scrollTop:$(".goods_together_unbeatable").offset().top},300);
});

/*24079 更新shipping内容和优化视觉设计*/
$(".good_main .more_save_box").hover(
	function(){
		// $(".good_main .quantity").css("z-index","5");
		// $(".good_main .more_save_tips").stop().slideDown();
		// $(".good_main .more_save_tips table tr").eq(1).find('td:gt(0)').remove();
	    // $(".good_main .more_save_tips table tr").eq(1).addClass("has").append(function(){return more_save();});
	},
	function(){
		$(".good_main .more_save_tips").hide();
		$(".good_main .quantity").css("z-index","");
	});

$(".good_main .more_save_box").click(function(ev){
	if($(".good_main .more_save_tips").is(':visible')){
		$(".good_main .more_save_tips").hide();
		$(".good_main .quantity").css("z-index","");
	}else{
		$(".good_main .quantity").css("z-index","5");
		$(".good_main .more_save_tips").stop().slideDown(300);
		$(".good_main .more_save_tips table tr").eq(1).find('td:gt(0)').remove();
		$(".good_main .more_save_tips table tr").eq(1).addClass("has").append(function(){return more_save();});
	}
	ev.stopPropagation();
});
/*24079 更新shipping内容和优化视觉设计*/

function more_save(){
	var is_flashdeals = $("#is_flashdeals").val();
	var is_unbeatble = $("#is_unbeatble").val();
	var is_hidebatch = $("#is_hidebatch").val();
	var cur_warehouse = $('#curWarehouse').val();

	var price = $(".good_main .price .now").attr('oriPrice');
    var wholesalePrice = $("#isWholesaleEDM").attr('wholesalePrice');
	var new_currency = $.cookie("currency");
	var place = eval('CurrencyCfg.' + new_currency + '[3]');
	var price_1 = getPriceByCurrencyNew(price, new_currency);
	if(((is_flashdeals == 1 || is_unbeatble == 1) && cur_warehouse == 'CN') || is_hidebatch == 1)
	{
		var price_3 = price_1;
		var price_10 = price_1;
		var price_30 = price_1;
		var price_100 = price_1;
	}
	else
	{
        var oriPrice3 = $(".good_main .price .now").attr('oriPrice3');
        var oriPrice10 = $(".good_main .price .now").attr('oriPrice10');
        var oriPrice30 = $(".good_main .price .now").attr('oriPrice30');
        var oriPrice100 = $(".good_main .price .now").attr('oriPrice100');

        if($("#isWholesaleEDM").val()==1 && parseFloat(wholesalePrice)<parseFloat(price) && cur_warehouse == 'CN'){
            price = wholesalePrice;
            oriPrice3 = price * 0.98 - 0.2;
            oriPrice10 = price * 0.97 - 0.24;
            oriPrice30 = price * 0.96 - 0.26;
            oriPrice100 = price * 0.95 - 0.3;
        }
		var price_3 = getPriceByCurrencyNew(oriPrice3, new_currency);
		var price_10 = getPriceByCurrencyNew(oriPrice10, new_currency);
		var price_30 = getPriceByCurrencyNew(oriPrice30, new_currency);
		var price_100 = getPriceByCurrencyNew(oriPrice100, new_currency);

		price_3 = (Number(price_3)*100).toFixed(0)/100;
		price_10 = (Number(price_10)*100).toFixed(0)/100;
		price_30 = (Number(price_30)*100).toFixed(0)/100;
		price_100 = (Number(price_100)*100).toFixed(0)/100;
	}


	var html = '<td>' + price + '</td><td>' + price + '</td><td>' + price + '</td><td>' + price + '</td><td>' + price + '</td>';
	if(price >= 0.5){html = '<td>' + Number(price_1).toFixed(place) + '</td><td>' + Number(price_3).toFixed(place) + '</td><td>' + Number(price_10).toFixed(place) + '</td><td>' + Number(price_30).toFixed(place) + '</td><td>' + Number(price_100).toFixed(place) + '</td>';}
	return html;
}

function changePriceAccordingToQtyAndFlag(qty, firstTime){
	if (getSelectedOptions() == false
            && parseFloat($(".item_con .now").attr('oriattrmax')) > parseFloat($(".item_con .now").attr('oriattrmin'))) {
			
		// 第一次加载(未选择poa)，存在价格区间，不进行批发价判断
		
		/*33704*/
		autoSubtotal();
		/*33704 end*/

        return ;
    }

    var wholesalePrice = parseFloat($("#isWholesaleEDM").attr('wholesalePrice'));
    var price = parseFloat($(".good_main .price .now").attr('oriPrice'));
    var isWholesalePrice = false;
    var wholesalemoq = $("#wholesaleMoq").val();
    var cur_warehouse = $('#curWarehouse').val();

    if(wholesalePrice > 0 && qty > (wholesalemoq-1) && wholesalePrice < price && cur_warehouse == 'CN'){
        price = wholesalePrice;
        isWholesalePrice = true;
    }

    if (isNaN(wholesalePrice) && firstTime == 1) {
        qty = 1;
    }

    // 若数量超过库存，重新取qty的值
    if (qtyAboveStock == true) {
        qty = $("#quantity").val();
    }

    var price_now = getWholesaleEDMPrice(price, qty, isWholesalePrice);
    //如果Wholesale_item存在，就是ws详情页
    if ($('#Wholesale_item').length <= 0) {
    	$(".good_main .price .now").html(price_now);
    }
    // $(".good_main .price .now").html(price_now);
    if (wholesalePrice > 0) {
        if(qty == wholesalemoq){
            $('#quantity').val(wholesalemoq);
            $('.quantity .prev').removeClass('gray');
        };

        if(qty < wholesalemoq){
            if($(".good_main .quantity").children("u").length<1){
                var msg = $("#isWholesaleEDM_msg").val();
                $(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
                $(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
            }
        }else{
        	if( $(".good_main .quantity u").length > 0 ){
        		$(".good_main .quantity").css("height",($(".good_main .quantity").height()-30)+"px");
        		$(".good_main .quantity u").remove();
        	}
	}
    }

	/*33704*/
	autoSubtotal();
	/*33704 end*/

    return true;
}

/*33704*/
function autoSubtotal(){
	var num = parseFloat($('#quantity').val() || 0);
	var nowPrice = parseFloat($('.now').attr('oriprice'));
	
	if($(".good_main .more_save_box").is(':visible') && getSelectedOptions()){
		if(num >= 3 && num < 10) {
			nowPrice = parseFloat($('.now').attr('oriprice3'));
		}else if(num >= 10 && num < 30) {
			nowPrice = parseFloat($('.now').attr('oriprice10'));
		}else if(num >= 30 && num < 100) {
			nowPrice = parseFloat($('.now').attr('oriprice30'));
		}else if(num >= 100) {
			nowPrice = parseFloat($('.now').attr('oriprice100'));
		}
	}

	var nowTotal = (num*nowPrice).toFixed(2);

	//console.log(num,nowPrice,nowTotal);
	if(num==0){
		nowTotal = 0;
	}

	//总额
	$('.point_subtotal').attr('oriprice',nowTotal);
	autoChangePrice($('.point_subtotal'), getCookieCurrency(),true);

	//获得积分
	$('.point_num').text(parseInt(nowTotal));
}
/*33704 end*/

function getWholesaleEDMPrice(price, qty, isWholesalePrice){

	var new_currency = $.cookie("currency");
	var place = eval('CurrencyCfg.' + new_currency + '[3]');
	var price_1 = getPriceByCurrencyNew(price, new_currency);
    price_1 = Number(price_1).toFixed(place);

    if (isWholesalePrice == false) {

        var oriPrice3 = $(".good_main .price .now").attr('oriPrice3');
        var oriPrice10 = $(".good_main .price .now").attr('oriPrice10');
        var oriPrice30 = $(".good_main .price .now").attr('oriPrice30');
        var oriPrice100 = $(".good_main .price .now").attr('oriPrice100');
    } else {
        var oriPrice3 = price * 0.98  - 0.2;
        var oriPrice10 = price * 0.97 - 0.24;
        var oriPrice30 = price * 0.96 - 0.26;
        var oriPrice100 = price * 0.95 - 0.3;
    }
    var price_3 = getPriceByCurrencyNew(oriPrice3, new_currency);
    var price_10 = getPriceByCurrencyNew(oriPrice10, new_currency);
    var price_30 = getPriceByCurrencyNew(oriPrice30, new_currency);
    var price_100 = getPriceByCurrencyNew(oriPrice100, new_currency);

    price_3 = (Number(price_3)*100).toFixed(0)/100;
    price_10 = (Number(price_10)*100).toFixed(0)/100;
    price_30 = (Number(price_30)*100).toFixed(0)/100;
    price_100 = (Number(price_100)*100).toFixed(0)/100;

    var price_now = price_1;

    if(price >= 0.5){
        if(qty>=3 && qty<10){
            price_now = price_3;
            if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(oriPrice3);},500)}
        }else if(qty>=10 && qty<30){
            price_now = price_10;
            if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(oriPrice10);},500)}
        }else if(qty>=30 && qty<100){
            price_now = price_30;
            if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(oriPrice30);},500)}
        }else if(qty>=100){
            price_now = price_100;
            if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(oriPrice100);},500)}
        }else{
        	if(typeof(BrazilInterestRate) != 'undefined'){{setTimeout(function(){BrazilInterestRate.Interest($(".good_main .price .now").attr('oriPrice'));},500)}}        	
        }
    }

    if ($(".price .accounting_date").html() != undefined || $(".timeShow").html() != undefined || $(".good_main .vip_price").length > 0) {
        //限时折扣、vip价的，没有梯度价
        price_now = price_1;
    } else {

        // 抄自 function more_save()
        var is_flashdeals = $("#is_flashdeals").val();
        var is_unbeatble = $("#is_unbeatble").val();
        var is_hidebatch = $("#is_hidebatch").val();
        var cur_warehouse = $('#curWarehouse').val();
        if(((is_flashdeals == 1 || is_unbeatble == 1) && cur_warehouse == 'CN') || is_hidebatch ==1) {
            price_now = price_1;
        }
    }

    return Number(price_now).toFixed(place);
}

	function reset_sortable(){
		 $('.gbin1_list').sortable().bind('sortupdate', function() {});
	}

	function set_gallery(type)
	{
		var products_id = parseInt($('#products_id').val());
		if(products_id<=0) return false;

		$.ajax({
			type: 'get',
			dataType: 'html',
			url: 'index.php?com=product&t=listGallery&type='+type,
			data: 'products_id='+products_id,
			success:function(html){
				modal_bg();
				$('.modal_container').append(html);
				modal_add();
			}
		});
	}

	function sortable(obj)
	{
		var j=0;
		var img = new Array();
		var imgIds = new Array();
		var htmlList = '';
		var type = $('#galleryType').val();
		$('.review_gallery input:checkbox:checked').each(function(){
			var image_id = $(this).attr('image_id');
			if(image_id){
				imgIds[j] = image_id;
			}else{
				if(type == 'set_gallery'){
					imgIds[j] = 'sort_'+$(this).val();
				}else{
					imgIds[j] = 'desc_sort_'+$(this).val();
				}
			}
			img[j] = $(this).parents("li").find('img').eq(0).attr('src');
			htmlList += '<li class="pic">';
			htmlList += '<img src="'+img[j]+'" image_id="'+imgIds[j]+'" class="sortTableDesc" />';
			htmlList += '<span class="close" onclick="return_close(this);">×</span>';
			htmlList += '</li>';
			j++;
		});

		if(!htmlList.length > 0)return false;

		$(".set_picture ul").hide();
		$(".set_picture").append('<div class="gbin1_list_box"><ul class="gbin1_list"></ul></div>');
		$(".gbin1_list_box .gbin1_list").append(htmlList);
		$(obj).parent().hide();
		$(obj).parent().next().show();
		reset_sortable();
	}
	function return_show(obj)
	{
		$(obj).parent().hide();
		$(obj).parent().prev().show();
		$(".gbin1_list_box").remove();
		$(".set_picture ul").show();
	}


	function return_close(e)
	{
		var flag = $(".modal_container .gbin1_list_box .gbin1_list").find("li").length;
		$(e).parent().remove();
		if(flag<2)
		{
			$(".modal_container #viewGalleryDesc").parent().show();
			$(".modal_container #galleryReturn").parent().hide();
			$(".gbin1_list_box").remove();
			$(".set_picture ul").show();
		}

	}

	function return_click(obj){
		var checked = $(obj).find('input:checkbox').eq(0).prop('checked');
		if(checked){
			$(obj).find('input:checkbox').eq(0).prop('checked', false);
		}else{
			$(obj).find('input:checkbox').eq(0).prop('checked', true);
		}
	}


	function setProductGallery()
	{
		var products_id = parseInt($('#products_id').val());
		var image_id = '';
		var sort_str = '';
		var tmp_sort;
		var exist_gallery = parseInt($('#exist_gallery').val());
		var type = $('#galleryType').val();
		if(products_id<=0){ alert('submit error');return false;}


		//拖动排序
		var sortLen = $('.sortTableDesc').length;
		if(sortLen > 0){
			$('.sortTableDesc').each(function(){
				var image_id = $(this).attr('image_id');
				$('#'+image_id).val(sortLen);
				sortLen--;
			});
		}

		$('.review_gallery').find('[name=reviewGallery]').each(function(){
			if($(this).prop('checked'))
			{
				image_id = $(this).val()+'|'+image_id;
				tmp_sort = $('#sort_'+$(this).val()).val();

				if(tmp_sort!='')
					sort_str = $(this).val()+'-'+tmp_sort+'|'+sort_str;
			}
		});

		var data = 'products_id='+products_id+'&image_id='+image_id+'&sort_str='+sort_str+'&type='+type;

		var hasDesc = false;
		$('.review_gallery').find('[name=reviewDescGallery]').each(function(){
			if($(this).prop('checked'))
			{
				hasDesc = true;
				var desc_id = $(this).val();
				var desc_sort = $('#desc_sort_'+desc_id).val();

				data += '&desc_arr['+desc_id+']='+desc_sort;
			}
		});


		var hasOther = false;

		if(type == 'set_gallery'){
			var dataKey = 'otherImages';
		}else{
			var dataKey = 'otherDesc';
		}

		$('.review_gallery').find('[name="'+dataKey+'[]"]').each(function(i){
			if($(this).prop('checked')){
				hasOther = true;
				data += '&otherImages[]='+$(this).val();
				var this_type = $('.review_gallery').find('[name="otherTypes[]"]').eq(i).val();

				if(type == 'set_gallery'){
					var this_sort = $('.review_gallery').find('[name="otherSorts[]"]').eq(i).val();
					data += '&otherSorts[]='+this_sort;
				}else{
					var this_desc_sort = $('.review_gallery').find('[name="otherDescSorts[]"]').eq(i).val();
					data += '&otherDescSorts[]='+this_desc_sort;
				}

				data += '&otherTypes[]='+this_type;
			}
		});

		if((image_id =='' && !hasOther && !hasDesc) && exist_gallery==0){ alert('Please select items'); return false; }

		$.ajax({
			type: 'post',
			dataType: 'JSON',
			url: 'index.php?com=product&t=setGallery',
			data: data,
			success:function(res){
				$('#exist_gallery').val(res.exist_gallery);
				if(res.msg){
					var height = $(".set_picture ul").outerHeight();
					$(".set_picture").append('<div class="success"><b onclick="set_success_remove();">×</b>'+res.msg+'</div>');
					$(".set_picture .success").css("line-height",height+'px');
					setTimeout('set_success_remove()',3000);
				}
			}
		});

		return false;
	}


	function set_success_remove()
	{
		$(".set_picture .success").remove();
	}

	$(document).on("mouseenter", ".hotgoods_1200 .goodlist_1 li", function() {
			$(this).find('.add_cart_bg').css("display", "block");
			$(this).find('.cart').css("display", "block");
		});
		$(document).on("mouseleave", ".hotgoods_1200 .goodlist_1 li", function() {
			$(this).find('.add_cart_bg').hide();
			$(this).find('.cart').hide();
		});

		function add_cart_detail(e)
		{
				var products_id = $(e).parent().find('a').eq(0).attr('data_id');
				var data = 'com=product&t=getFastBuyCart';
				data += '&pid=' + products_id;
				modal_bg();
				$.ajax({
					url: homeUrl + 'index.php',
					timeout: 10000,
					type: 'get',
					data: data,
					dataType: 'html',
					success: function(html) {
						$('.modal_container').append(html);
						modal_add();
					}
				});
		}

			$(document).on("click", ".hot_show_box .cart_box .cancel_fast", function() {
				modal_remove()
			});

			function submit_fast(e)
			{

				var all_select = true;
				var no_select_option = new Array;
				var no_select_option_txt = '';
				var i = 0;
				$(e).parent().prevAll('dl').find('input').each(function() {

					if (!$(this).val().length)
					{
						all_select = false;
						var option_id = $(this).attr('oid');
						var option_txt = $(this).parent().parent().prev().text();
						option_txt = option_txt.replace(':', '');
						no_select_option[option_id] = option_txt;
						i++;
					}
				});

				if (!all_select)
				{
					for (var k in no_select_option) {
						$(e).parents(".cart_box").find("dd#"+k+"").append('<div class="tips"><i></i>Please Select ' + no_select_option[k]+'</div>');
					}
					return false;
				}
				else
				{
					$(e).parents(".cart_box").hide();

					var pid = $(e).attr('id');

					var data = $('#form_' + pid).serialize();

					$.ajax({
						type: "POST",
						url: "index.php",
						data: "com=ajax&t=addToCart&" + data,
						beforeSend: function() {
//							$(e).parents(".cart_box").hide();
							$(e).parents(".cart_box").prev().prev().css("display","block");
						},
						success: function(msg) {
							if (msg)
							{
								alert(msg);
								modal_remove();
							}
							else
							{
								$(e).parents(".cart_box").prev().prev().hide();
								$(e).parents(".cart_box").prev().css("display","block");
								loadHeadCart();
								setTimeout(function(){
								modal_remove();
								},2500);

							}
						}
					});

				}

			}

			$(document).on("click", ".hot_show_box .cart_box .submit_fast", function() {
				submit_fast(this);
			});


		if ($(".hotgoods_1200 .goodlist_1 li").length > 0)
		{
			$(document)
					.on('mouseenter', '.select', function() {
						$(this).attr('off', '0');
					})
					.on('mouseleave', '.select', function() {
						$(this).attr('off', '1');
					})
					.on('click', '.select .select_text', function() {
						$(".hot_show_box .cart_box dl").css("z-index", "auto");
						$(this).parents("dl").css("z-index", "4");
						if ($(this).next('.select_box').is(':hidden'))
						{
							$(this).next('.select_box').show();
						}
						else
						{
							$(this).next('.select_box').hide();
						}
					})
					.on('click', '.select .select_box dl dd a', function() {
						$(this).parents(".select").find("input").val($(this).attr("cid"));
						$(this).parents(".select").find(".text").html($(this).html());
						$(this).parent().parent().parent().hide();
					})

			$(document).click(function() {
				$('.select').each(function() {
					if ($(this).attr('off') == 1)
					{
						$(this).find('.select_box').hide();
					}
				});
			});
		}


	//判断数量是否超过了限制
	function checkFlashDealNum(quantity, op)
	{
		quantity = parseInt(quantity);
		if(isNaN(quantity))
		{
			return false;
		}

		if(op == 'add')
		{
			quantity++;
		}
		else
		{
			quantity--;
		}

        qtyAboveStock = false;
		quantity = quantity < 1 ? 1 : quantity;

		var stock_limit_num = $("#stock_limit_num").val();
		var stock_limit_num_msg = $("#stock_limit_num").attr("msg");
		var buy_limit_num = $("#buy_limit_num").val();
		var buy_limit_num_msg = $("#buy_limit_num").attr("msg");

		var clearStockInfo = getClearStockInfo();
		var clearStockInfo = eval('(' + clearStockInfo + ')');
		var stocks = clearStockInfo.stocks;
		var clearStock = clearStockInfo.clearStock;
		var clearStockMsg = clearStockInfo.clearStockMsg;

		var divID = 'stockMsg_'+$('#curWarehouse').val();
		var selOptions = getSelectedOptions();
        if (selOptions != false) {
            if(selOptions.valueIds.length > 0){
                for(var i = 0; i < selOptions.valueIds.length; i++){
                    divID += '_'+selOptions.valueIds[i];
                }
            }
        }
        var maxStock = $('#'+divID).attr('maxStock');
        var maxStockMsg = $('#'+divID).attr('maxStockMsg');

		if(stock_limit_num != undefined && buy_limit_num != undefined)
		{
			stock_limit_num = parseInt(stock_limit_num);
			buy_limit_num = parseInt(buy_limit_num);

			if(stock_limit_num >= buy_limit_num)
			{
				if(quantity > buy_limit_num)
				{
                    qtyAboveStock = true;
					$("#quantity").val(buy_limit_num);
					changePriceAccordingToQtyAndFlag(buy_limit_num);
					showFlashDealsMsg('show', buy_limit_num_msg,buy_limit_num,op);
					return false;
				}
			}
			else
			{
				if(quantity > stock_limit_num)
				{
                    qtyAboveStock = true;
					$("#quantity").val(stock_limit_num);
					changePriceAccordingToQtyAndFlag(stock_limit_num);
					showFlashDealsMsg('show', stock_limit_num_msg,stock_limit_num,op);
					return false;
				}
			}
		}
		else if(stock_limit_num != undefined)
		{
			stock_limit_num = parseInt(stock_limit_num);

			if(stock_limit_num > maxStock){
				if(quantity > 300){
					if(maxStock > 300){
						$("#quantity").val(300);
						changePriceAccordingToQtyAndFlag(300);
					} else {
						changePriceAccordingToQtyAndFlag(maxStock);
						$("#quantity").val(maxStock);
					}
	                qtyAboveStock = true;
					showFlashDealsMsg('show', maxStockMsg,maxStock,op);
					return false;
				}else if(quantity > maxStock){
	                qtyAboveStock = true;
					$("#quantity").val(maxStock);
					changePriceAccordingToQtyAndFlag(maxStock);
					showFlashDealsMsg('show', maxStockMsg,maxStock,op);
					return false;
				}
			} else {
				if(quantity > stock_limit_num){
	                qtyAboveStock = true;
					$("#quantity").val(stock_limit_num);
					changePriceAccordingToQtyAndFlag(stock_limit_num);
					showFlashDealsMsg('show', stock_limit_num_msg,stock_limit_num,op);
					return false;
				}
			}
		}
		else if(buy_limit_num != undefined)
		{
			buy_limit_num = parseInt(buy_limit_num);

			if(quantity > buy_limit_num)
			{
                qtyAboveStock = true;
                $("#quantity").val(buy_limit_num);
				changePriceAccordingToQtyAndFlag(buy_limit_num);
				showFlashDealsMsg('show', buy_limit_num_msg,buy_limit_num,op);
				return false;
			}
		}
		else if(clearStock)
		{
			stocks = parseInt(stocks);

			if(quantity > stocks)
			{
                qtyAboveStock = true;
				$("#quantity").val(stocks);
				changePriceAccordingToQtyAndFlag(stocks);
				showFlashDealsMsg('show', clearStockMsg,stocks,op);
				return false;
			}
		}else if(maxStock != undefined){
			if(quantity > 300){
				if(maxStock > 300){
					$("#quantity").val(300);
					changePriceAccordingToQtyAndFlag(300);
				} else {
					changePriceAccordingToQtyAndFlag(maxStock);
					$("#quantity").val(maxStock);
				}
                qtyAboveStock = true;
				showFlashDealsMsg('show', maxStockMsg,maxStock,op);
				return false;
			}else if(quantity > maxStock){
                qtyAboveStock = true;
				$("#quantity").val(maxStock);
				changePriceAccordingToQtyAndFlag(maxStock);
				showFlashDealsMsg('show', maxStockMsg,maxStock,op);
				return false;
			}
		}

		showFlashDealsMsg('hide','',quantity,op);
		return true;
	}

	function showFlashDealsMsg(op, msg, quantity,_this)
	{
		if(op == 'show')
		{
			if($(".good_main .quantity u").length > 0)
			{
				$(".good_main .quantity u").html('<i></i>'+msg);
			}
			else
			{
				$(".good_main .quantity").css("height","80px");
				$(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
				//WS详情页数量超过了300
				if ($('#Wholesale_item').length > 0) {
					numPrice(parseInt($('#quantity').val()));
				}
			}
		}
		else
		{
			$(".good_main .quantity").css("height","");
			$(".good_main .quantity u").remove();
		}

		/*#14992 多件优惠促销需求 start*/
	    if(typeof(filterBuyMoreSaveMoreNum) != 'undefined' && typeof(filterBuyMoreSaveMorePrice) != 'undefined'){
	    	BuyMoreSaveMore(op,quantity,_this);
	    }
	    /*#14992 多件优惠促销需求 end*/

	}
	//判断数量是否超过了预定购买限制
	function checkPreorderNum(quantity)
	{
		var ele = $("#vip-product-limit-num").length > 0 ? '#vip-product-limit-num' : '#preorder_limit_num';
		if (ele == '#vip-product-limit-num' && $(".vip_price").length > 0 && $(".vip_price").is(":hidden")){
			return true;
		}
		if ($(ele).length > 0) {
			var preorder_limit_num = $(ele).val();
			if (quantity > 0 && quantity >= preorder_limit_num) {
				showFlashDealsMsg('hide');
				var msg = $("#preorder_limit_msg").text();
				$(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
				$(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
				$("#quantity").val(preorder_limit_num);
				return false;
			}
		}
		return true;
	}

        //判断数量是否超过了于比价产品每单限制
	function checkTimeDiscountNum(quantity)
	{
		if ($("#time_discount_limit_num").length > 0) {
			var time_discount_limit_num = $("#time_discount_limit_num").val();
			if (quantity >= time_discount_limit_num) {
				var msg = $("#time_discount_limit_msg").text();
				$(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
				$(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
				$("#quantity").val(time_discount_limit_num==0?1:time_discount_limit_num);
				return false;
			}
		}
		return true;
	}


if($(".good_photo_max_fashion").length == 0 && $(".good_intimate").length == 0)
{
	$(".wrap_right .good_tabs_box table").each(function(){
		if($(this).attr("style") && ($(this).attr("style").indexOf("border-collapse: inherit;") > -1) )
		{
			$(this).css("border", "1px solid #dddddd");
		}
		else
		{
			if ($(this).attr("border") === undefined || $(this).attr("border") === false/* || $(this).attr("border") === "0"*/)
			{
				$(this).attr("border", "1");
			}
			if ($(this).attr("cellpadding") === undefined || $(this).attr("cellpadding") === false)
			{
				$(this).attr("cellpadding", "5");
			}
		}
	});
}

function getSoldTotal(){
	//废弃
	return false;
	var product_id = $('#products_id').val();
	$.ajax({
		'type': 'get',
		'url': homeUrl + 'index.php?com=ajax&t=getSoldTotal&product_id=' + product_id,
		'data': '',
		'success': function(res){
			$('.sold b').text(res);
		}
	});
}
getSoldTotal();


function getClearStockInfo()
{
	var warehouse = $('#curWarehouse').val();
	var divID = 'stockMsg_'+warehouse;

	var selOptions = getSelectedOptions();
	if(selOptions==false){
		return false;
	}
	if(selOptions.valueIds.length > 0){
		for(var i = 0; i < selOptions.valueIds.length; i++){
			divID += '_'+selOptions.valueIds[i];
		}
	}

	var stocks = $('#'+divID).attr('stocks');
	var clearStock = $('#'+divID).attr('clearStock');
	var clearStockMsg = $('#'+divID).attr('clearStockMsg');
	var stockMsg = $('#'+divID).attr('stock_message');

	return "{'stocks':'"+stocks+"', 'clearStock':"+clearStock+", 'stock_message':'"+stockMsg+"', 'clearStockMsg':'"+clearStockMsg+"'}";

}


function jQuery_isTagName(ev){
	ev=$.event.fix(ev);
	var target=ev.target||ev.srcElement;
	var tagname=target.tagName.toString().toLowerCase();
	if(tagname=="img" || (tagname== "a" && $(target).children("img").length > 0)){
	  return false;
	}
	return true;
}

$(document).on("contextmenu dragstart", ".good_tabs_box .list,.good_photo,.good_photo_zoom_box", function(ev){
	if(!jQuery_isTagName(ev)){
	  ev.preventDefault();
	  return false;
	}
	return true;
});

/*copy sku*/
/*if($(".good_main li.sku").find("b").prev().outerWidth(true)>0)
{
	var sku_b_width = $(".good_main li.sku").find("b").prev().outerWidth(true);
	if(sku_b_width>199)
	{
		$(".good_main li.sku b").hover(function(){
			$(this).parent().css("padding-right","200px");
			$(this).addClass("active");
		},
		function(){
			$(this).parent().css("padding-right","");
			$(this).removeClass("active");
		});
	}
	else
	{
		$(".good_main li.sku b").hover(function(){
			$(this).parent().css("padding-right",sku_b_width);
			$(this).addClass("active");
		},
		function(){
			$(this).parent().css("padding-right","");
			$(this).removeClass("active");
		});
	}
}*/

/*=1000*/
function focusAuto(){
	var focusW = parseInt($(".wrap:eq(0)").css("width"));
	if(focusW == 1000 && !focus_1){
		$('.photo_video_box').masonry({columnWidth:259});focus_1 = true; focus_2 = false;
	}
	if(focusW == 1200 && !focus_2){
		$('.photo_video_box').masonry({columnWidth:244});focus_1 = false; focus_2 = true;
	}
}
var focus_1 = false, focus_2 = false;
$(window).resize(function(){
	focusAuto();
});

function couponBanner(html){
	if(typeof(html) == 'undefined'){
		html = null;
	}
	if(typeof(isGetCouponBanner) == 'undefined'){
		isGetCouponBanner = false;
	}

	if(!isGetCouponBanner){
		if(html === null){
			return false;
		}
		$('#coupon_banner').html(html);
		isGetCouponBanner = true;
	}else{
		return true;
	}
}

function getBundleList(setHtml){
	var pid = $('#products_id').val();
	var curWarehouse = $('#curWarehouse').val();
	$('.gift').css('display','none');
	$('.gift[warehouse="'+curWarehouse+'"]').css('display','block');

	if(typeof(setHtml) == 'undefined'){
		setHtml = '';
	}else{
		var isSetHtml = true;
	}

	//如果Wholesale_item存在，说明是ws的详情页
	if ($('#Wholesale_item').length > 0) {
		var currency = $.cookie("currency");
		_selCurrency(currency);
		return true;
	}

	if (product_bundle[curWarehouse]) {
		$("#product_bundle").html(product_bundle[curWarehouse]);
		var currency = $.cookie("currency");
		scroll_play(".goods_together_new",4);
		scroll_play(".goods_together",5);
		_selCurrency(currency);
		return true;
	}else {
		setHtml = setHtml.replace(/(^\s*)|(\s*$)/g, "")
		if(setHtml.length == 0 && typeof(isSetHtml) == 'undefined'){
			return false;
		}

		if ($("#product_bundle").length > 0) {
			$("#product_bundle").remove();
			$(".detailpage").before(setHtml);
			if (is_country_limit){
				$("#product_bundle .buy_now").addClass('gray');
				$("#product_bundle .selected_cart").addClass('gray');
			}
			curWarehouse = $("#product_bundle").attr("warehouse");
			product_bundle[curWarehouse] = $("#product_bundle").html();
			tabs(".goods_together_unbeatable .good_tabs_title li", "click");
		} else{
			$(".detailpage").before(setHtml);
			if (is_country_limit){
				$("#product_bundle .buy_now").addClass('gray');
				$("#product_bundle .selected_cart").addClass('gray');
			}
			curWarehouse = $("#product_bundle").attr("warehouse");
			product_bundle[curWarehouse] = $("#product_bundle").html();
			tabs(".goods_together_unbeatable .good_tabs_title li", "click");
		}
		if (!product_bundle[curWarehouse]) {product_bundle[curWarehouse] = ' ';}
		DetailLazyImage();
	}
}

function getSelectAttrId(){
	var select_id = '';
	var selOptions = getSelectedOptions();
	if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
		for(var i = 0; i < selOptions.valueIds.length; i++){
			select_id += selOptions.valueIds[i];
		}
	}

	return select_id;
}

function getSelectAttrIdSplit(){
	var split="_";//分隔符
	var select_id_split = '';
	var selOptions = getSelectedOptions();
	if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
		for(var i = 0; i < selOptions.valueIds.length; i++){
			select_id_split +=split+selOptions.valueIds[i];
		}
	}

	return select_id_split;
}

function translate_btn(html){
	if(typeof(html) == 'undefined'){
		html = '';
	}
	if(typeof(isGetViewEnBtn) == 'undefined'){
		isGetViewEnBtn = false;
	}
	if(!isGetViewEnBtn){
		if(html.length == 0){
			return false;
		}
		$(".good_tabs_title li").eq(0).append(html);
		isGetViewEnBtn = true;
	}else{
		return true;
	}
}

function viewInEnglish(obj){
	if($(obj).hasClass("en_view_open")){
		$(obj).removeClass("en_view_open").text($(obj).attr('enName'));
		$(".good_tabs_box .list").eq(0).html($('.en_view_bak').html());
		return false;
	}

	if($(".en_view_box").html().length == 0){
		if($(obj).hasClass("en_view_loading")){return false};
		$(obj).addClass("en_view_loading");

		var id = $('#products_id').val();
		var data = 'com=product&t=viewEnDesc&products_id='+id;
		$.ajax({
			url:homeUrl+'index.php',
			type : 'get',
			data :data,
			success:function(desc){
				$(obj).removeClass("en_view_loading");
				if(desc.length > 0){
					$(".en_view_box").html(desc);
					$(obj).addClass("en_view_open").text($(obj).attr('langName'));
					$('.en_view_bak').html($(".good_tabs_box .list").eq(0).html());
					if($(".good_photo_max_fashion").length == 0 && $(".good_intimate").length == 0)
					{
						$(".en_view_box table").each(function(){
							if($(this).attr("style") && ($(this).attr("style").indexOf("border-collapse: inherit;") > -1) )
							{
								$(this).css("border", "1px solid #dddddd");
							}
							else
							{
								if ($(this).attr("border") === undefined || $(this).attr("border") === false || $(this).attr("border") === "0")
								{
									$(this).attr("border", "1");
								}
								if ($(this).attr("cellpadding") === undefined || $(this).attr("cellpadding") === false)
								{
									$(this).attr("cellpadding", "5");
								}
							}
						});
					}
					$(".good_tabs_box .list").eq(0).html($(".en_view_box").html());
				}
			}
		});
	}else{
		$(obj).addClass("en_view_open").text($(obj).attr('langName'));
		$(".good_tabs_box .list").eq(0).html($('.en_view_box').html());
	}
}


/**
* 详情页选择属性 和 绑定选择属性 主产品一致调整
* @parm  int type  1 主产品改变绑定产品  2 绑定产品改变主产品
*/
function bundle_same(type)
{
	var active_name = "active";
	var imgactive_name = "imgactive";

	var attr_zhu = ".good_main .attrValues";
	var attr_bund = ".item_attr_box .item_attr_list .item_box a";

	var att1 = attr_zhu;
	var att2 = attr_bund;

	switch (type)
	{
		case 2 :  //绑定的改变主产品显示的
		att1 = attr_bund ;
		att2 = attr_zhu ;
		break;

	}

	$(att1).each(function(){
			var active_ = $(this).hasClass(active_name); //文字选中
			var imgactive_ = $(this).hasClass(imgactive_name); //图片选中
			var class_name = active_ ? active_name : ( imgactive_ ? imgactive_name : "" );  //是文字选中还是图片选中

			if( active_ || imgactive_ )
			{
				var value_id = $(this).attr('value_id');
				var ori_name = $(this).attr('ori_name');
				var option_id = $(this).attr('option_id') ;


                // 计算APP ONLY PRICE的价格增减量
                var price_prefix = $(this).attr("price_prefix");
                // var poa_oriprice = parseFloat($(this).attr("oriprice"));
                var ori_app_price = parseFloat($(".mobile_discount_trigger .appSuperPrice").attr("oriappprice"));
                // 当存在app专享价的时候才处理
                if(ori_app_price && validateSelOptions()){
                    var app_price = ori_app_price;
                    var select_attr_id_split=getSelectAttrIdSplit();
                    var curWarehouse = $('#curWarehouse').val();
                    var divID ='stockMsg_'+curWarehouse+select_attr_id_split;
                    var poa_oriprice =parseFloat($("#"+divID).attr("poaDiffPrice"));

                    if(!isNaN(poa_oriprice)){
                        if(price_prefix == "-"){
                            app_price -= poa_oriprice;
                        }else{
                            app_price += poa_oriprice;
                        }

                        var currency = $.cookie("currency");
                        var currency_app_price = getPriceByCurrency(app_price, currency);
                        $(".mobile_discount_trigger .appSuperPrice").attr("oriprice", app_price).text(currency + " " + currency_app_price);
                    }
                }

				//修改一致选项
				$(att2).each(function(){
						var value_id_i = $(this).attr('value_id');
						var ori_name_i = $(this).attr('ori_name');
						var option_id_i = $(this).attr('option_id') ;
						//console.info(value_id+" "+value_id_i+" "+option_id+" "+option_id_i);
						if( option_id == option_id_i )
						{
							$(this).removeClass("active");
							$(this).removeClass("imgactive");
							if( value_id == value_id_i )
							{
								$(this).addClass(class_name).append("<i />");
							}else
							{
								$(this).removeClass(class_name).find("i").remove();
							}
						}
				});

			}
	});

    /**
     * 未选中状态
     */
    if($(att1 + "." + active_name).length == 0 && $(att1 + "." + imgactive_name).length == 0){
        var orimaxprice = $(".item_con .now").attr("orimaxprice");
        var oriminprice = $(".item_con .now").attr("oriminprice");

        if(orimaxprice != oriminprice){
            var currency = getCookieCurrency();
            $(".item_con .now").attr("oriattrmax", orimaxprice);
            $(".item_con .now").attr("oriattrmin", oriminprice);
            $(".item_con .now").attr("oriprice", oriminprice);
            $(".item_con .now").text(getPriceByCurrency(oriminprice, currency) + " ~ " + getPriceByCurrency(orimaxprice, currency));

            var maxAppPrice = $(".price_sub_info .appSuperPrice").attr("orimaxappprice");
            var minAppPrice = $(".price_sub_info .appSuperPrice").attr("oriminappprice");
            if(!isNaN(maxAppPrice) && !isNaN(minAppPrice)){
            	$(".price_sub_info .appSuperPrice").text(currency + " " + getPriceByCurrency(minAppPrice, currency) + " ~ " + getPriceByCurrency(maxAppPrice, currency));
            }
        }
    }

	if(type == 2){
		stockMessage();
	}else if(type == 1){
		calculateBundlePrice();
	}

}

//预订产品添加到购物车
$(document).on("click","#booking,.perorder",function(){
//$('#booking,.perorder').click(function(){
    addcartOrBuynow = true;
    if ($(this).attr('id') != 'booking') {
        scollToGoodsMain = true;
    }

    if (!validateSelOptions()) {
        return false;
    }

	if($(this).hasClass("gray")){
		return false;
	}
	var result = checkItemRestBookNum();
	if(!result){
		return false;
	}
	var result = checkRestBookNum();
	if(!result){
		return false;
	}
	//获取选中的属性
	var selOpResult = getSelectedOptions();
	if(selOpResult){
		if($('#isCheckStock').val()==1){//检查是否还在查库存状态
			return false;
		}
		for(var i = 0; i < selOpResult.optionIds.length; i++){
			var op = selOpResult.optionIds[i];
			var val = selOpResult.valueIds[i];
			var html = '<input type="hidden" name="id['+op+']" value="'+val+'" />';
			$('#detailCartForm').append(html);
		}
	}

	//获取赠品
	$('input[name="accesory_id[]"]').remove();
	var warehouse = $('#curWarehouse').val();
	if ($(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").length) {
		$(".giftmedule[warehouse='"+warehouse+"']").find(".checkbox_on_active").each(function () {
			var accesory_id = $(this).attr('acc_id');
			var accesory_attrs = '';
			$(".more_select_box_list[acc_id='"+accesory_id+"'][warehouse='"+warehouse+"']").find('.gift_attr').each(function () {
				var acc_option_id = $(this).attr('option_id');
				var acc_value_id = $(this).find('a.active').attr('value_id');
				accesory_attrs = accesory_attrs + '{' + acc_option_id + '}' + acc_value_id;
			});
			var accesory_cart_id = accesory_id + accesory_attrs;
			var html = '<input type="hidden" name="accesory_id[]" value="'+accesory_cart_id+'" />';
			$('#detailCartForm').append(html);
		});
	};

	if ($(this).attr('id') == 'booking') {
        _setDEMProductTOCart($('#products_id').val());
    }
	
	$('#detailCartForm').submit();

});

//检验预订产品的购买数量是否超出预设的总数量
function checkRestBookNum(){
	var result = true;
	//获取产品参数
	var products_id = $("#products_id").val();
	var quantity = $("#quantity").val();
    var curWarehouse = $("#curWarehouse").val();
	var data = 'com=product&t=checkRestBookNum&products_id=' + products_id + '&quantity=' + quantity;
    data += '&warehouse='+curWarehouse;

    var valueIds = getSelectedOptions(); 
    var valueIds = valueIds.valueIds;
    if (valueIds != undefined) {
        data += '&valueId='+valueIds.join(','); 
    }

	$.ajax({
		url:homeUrl+'index.php',
	    type: 'get',
		async: false,
		data: data,
		dataType: 'json',
		success: function(res){
			if(!res.flag){
				if(res.msg == 'login'){
					login();
				}else{
					modal_bg();
					msgbox(0, res.msg);
				}
				result = false;
			}
		}
	});

	return result;
}
//检验用户预订某产品的购买数量是否超出预设的10
function checkItemRestBookNum(){
	var result = true;
	//获取产品参数
	var products_id = $("#products_id").val();
	var quantity = $("#quantity").val();
    var curWarehouse = $("#curWarehouse").val();
	var data = 'com=product&t=checkItemRestBookNum&products_id=' + products_id + '&quantity=' + quantity;
    data += '&warehouse='+curWarehouse;
	$.ajax({
		url:homeUrl+'index.php',
	    type: 'get',
		async: false,
		data: data,
		dataType: 'json',
		success: function(res){
			if(!res.flag){
				if(res.msg == 'login'){
					login();
				}else{
					modal_bg();
					msgbox(0, res.msg);
				}
				result = false;
			}
		}
	});

	return result;
}

//sold 的数量显示
function showSoldNum(){
	var products_id = $("#products_id").val();
	var data = 'com=product&t=showSoldNum&products_id=' + products_id;
	$.ajax({
		url:homeUrl+'index.php',
	    type: 'get',
		async: false,
		data: data,
		dataType: 'json',
		success: function(res){
			if(res.error == 0 && !$('.sold').hasClass('pre')){
				$("#sold_num").html(res.num);
				$('.sold').css('display','inline');
			}
		}
	});
}

//sold 的数量显示
function showPreOrdersNum(getCurWarehouse){
	if(!$('.sold').hasClass('pre')){
		return false;
	}
	$('.sold').addClass('loading');
	var products_id = $("#products_id").val();
	var curWarehouse = $('#curWarehouse').val();

	var data = 'com=product&t=showPreOrdersNum&products_id=' + products_id;

    data += '&warehouse='+curWarehouse;

	//由于静态化的页面会存储错误的当前仓库数据
	//所以在页面初始化执行获取库存信息的时候需要设定重新获取当前仓库
	if(typeof(getCurWarehouse) != 'undefined'){
		data += '&getCurWarehouse=1';
	}

	$.ajax({
		url:homeUrl+'index.php',
	    type: 'get',
		async: false,
		data: data,
		success: function(res){
			$("#sold_num").html(res);
			$('.sold').removeClass('loading');
		}
	});
}

//presell 的数量显示
function showPresellNum(){
	if(!$('.sold').hasClass('presell')){
		return false;
	}
	$('.sold').addClass('loading');
	var products_id = $("#products_id").val();
	var data = 'com=product&t=showPresellNum&products_id=' + products_id;
	$.ajax({
		url:homeUrl+'index.php',
	    type: 'get',
		async: false,
		data: data,
		success: function(res){
			$("#sold_num").html(res);
			$('.sold').removeClass('loading');
		}
	});
}




//服装siz评论加载
$(document).on("click",".they_think .think_goods ul li",function(){
	if($(this).hasClass("nothing")){return false;}

	if($(this).hasClass("active")){
		$("#size_option").val("");
		getReviews(1);
	}else{
		var id = $(this).attr("size");
		$("#size_option").val(id);
		getReviews(1);
	}

});
//star
$(document).on("click",".good_review_top .review li",function(){
	if($(this).hasClass("nothing")){return false;}

	if($(this).hasClass("active")){
		$("#star_option").val("");
		$("#size_option").val("");
		getReviews(1);
	}else{
		var id = $(this).attr("star");
		$("#size_option").val("");
		$("#star_option").val(id);
		getReviews(1);
	}

});
//评论标签Tag
$(document).on("click",".review_tags .tags li",function(){
	if($(this).hasClass("active")){
		$("#tag_option").val("");
		getReviews(1);
	}else{
		var tag = $(this).attr("data-tag");
		$("#tag_option").val(tag);
		getReviews(1);
	}
});

$(document).on("keydown",".page_input",function(event){
	if (event.keyCode == "13") {
		var quantity = $(this).val();
		if(quantity)
		{
			getReviews(quantity);
		}
	}
 });



//产品选中事件
$(document).on("click",".goods_together_new .price",function(){
    var li=$(this).parents("li"),
    	$checkbox = $(this).find('span');
    if ($('#addWsCoLumnToCart').length > 0) return false;
    if(!li.hasClass("selected")){

        $checkbox.removeClass('checkbox_on');
        $checkbox.addClass('checkbox_on_active');
	}else{
        $checkbox.removeClass('checkbox_on_active');
        $checkbox.addClass('checkbox_on');
	}
    //计算数量和价格
    var selected_num = 0;
    var accSpeTotalPrice = parseFloat($("#main_final_price").val());
    var accTotalPrice = parseFloat($("#main_ori_price").val());
    $(".goods_together_new .goodlist_1 li").each(function(){
    	if($(this).find('.checkbox_on_active').length == 1){
    		selected_num++;

    		accSpeTotalPrice += parseFloat($(this).find('.final_price_class').val());
    		accTotalPrice += parseFloat($(this).find('.ori_price_class').val());
    	}

    })

    //设置数量
    $("#selected_num").html(selected_num);

	var accSavePrice = accTotalPrice - accSpeTotalPrice;
    //价格
	$("#accTotalPrice").attr('oriprice', accTotalPrice.toFixed(2));
	$("#accSpeTotalPrice").attr('oriprice', accSpeTotalPrice.toFixed(2));
	$("#accSavePrice").attr('oriprice', accSavePrice.toFixed(2));

	var currency = $.cookie("currency")
	autoChangePrice($("#accSpeTotalPrice"), currency, true);
	autoChangePrice($("#accTotalPrice"), currency, true);

	var node = $("#accSavePrice");
	var format = true;
	var oriPrice = parseFloat(node.attr('oriPrice'));
	var oriAttrMax = parseFloat(node.attr('oriAttrMax'));
	var oriAttrMin = parseFloat(node.attr('oriAttrMin'));
	var formatPrice = getPriceByCurrency(oriPrice, currency, format);
	var preg = /<span.+?\/span>/;
	if(preg.test(node.html())){
		var span = node.html().match(preg);
		formatPrice = span + formatPrice;
		node.html(formatPrice);
	}else{
		if(oriAttrMax > oriAttrMin){
			if (currency == 'RUB' || currency == 'AED') {
				var str1 = getPriceByCurrency(oriAttrMin, currency, false);
				var str2 = getPriceByCurrency(oriAttrMax, currency, format);
			} else {
				var str1 = getPriceByCurrency(oriAttrMin, currency, format);
				var str2 = getPriceByCurrency(oriAttrMax, currency, false);
			}
			var attrRangeStr = str1 +' ~ '+ str2;
			node.html(attrRangeStr);
		}else{
			node.text(formatPrice);
		}
	}
});

$(document).on("click",".goods_together_new .selected_wish",function(){
	// 防止多次点击
	if($('.goods_together_new .selected_wish').hasClass('gray')) return false;
	$('.goods_together_new .selected_wish').addClass('gray');

    var main_pid = $('#products_id').val();
    var validSelect = 0;
    var pids = main_pid + '|';
    $(".goods_together_new li").each(function(){
	    if($(this).find('.checkbox_on_active').length == 1){
	    	validSelect++;
		    var pid_str = $(this).attr("id");
		    var pid_arr = pid_str.split('_');
		    var pid = pid_arr[1];
			pids = pids + pid + '|';
		}
	});

    //没有勾选要收藏的产品
	if (validSelect == 0){
		modal_bg();
		msgbox(0, selected_none);
		$('.goods_together_new .selected_wish').removeClass('gray');
		return false;
	}

	$.ajax({
		type: 'post',
		url: homeUrl + 'index.php',
		data: {'com':'product','t':'addManyWishList','pids':pids, 'main_pid':main_pid},
		dataType: 'json',
		success: function(res){
			$('.goods_together_new .selected_wish').removeClass('gray');
		    if(res.login){
			    login();
			}else{
				if(res.mainProductAmount) $('.addwish').find('u').text(res.mainProductAmount);
			    countWishList(res.nums);
			    modal_bg();
				msgbox(0, res.msg);
			}
		}
	});
});


$(document).on("click",".goods_together_new .buy_now",function(){
	addcartOrBuynow = true;
	scollToGoodsMain = true;

	if (!validateSelOptions()) {
		$(".goods_together .buy_now").removeClass("selected_cart_loading");
		$('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
		return false;
	}

	//获取选中的属性

	var selOpResult = getSelectedOptions();
	if(selOpResult){
		if($('#isCheckStock').val()==1){//检查是否还在查库存状态
			return false;
		}
		for(var i = 0; i < selOpResult.optionIds.length; i++){
			var op = selOpResult.optionIds[i];
			var val = selOpResult.valueIds[i];
			var html = '<input type="hidden" name="id['+op+']" value="'+val+'" />';
			$('#detailCartForm').append(html);
		}
	}

	if($(this).hasClass("selected_cart_loading")){
		return false;
	}
	$(this).addClass("selected_cart_loading");

	var html = '';
	var goods_num = 1;
	$(".goods_together_new .goodlist_1 li").each(function(){
    	if($(this).find('.checkbox_on_active').length == 1){
    		var accesory_cart_id = $(this).attr('cart_id');
    		html += '<input type="hidden" name="accesory_id[]" value="'+accesory_cart_id+'" />';
    		goods_num++;
    	}
    })
    //没有勾选产品
	if (goods_num <= 1){
		modal_bg();
		msgbox(0, selected_none);
		$(this).removeClass("selected_cart_loading");
		return false;
	}

	$('#detailCartForm').append(html);
	$('#detailCartForm').submit();
});


$(document).on("click",".goods_together_new .selected_cart",function(){
	if($(this).hasClass('gray') || is_country_limit){
		return false;
	}
    addcartOrBuynow = true;
    scollToGoodsMain = true;
    if (!validateSelOptions()) {
        $(".goods_together .selected_cart").removeClass("selected_cart_loading");
        $('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
        return false;
    }

	if($(this).hasClass("selected_cart_loading")){
		return false;
	}
	$(this).addClass("selected_cart_loading");

	//accesory_ids
	var accesory_ids = '';
	var goods_num = 1;
	$(".goods_together_new .goodlist_1 li").each(function(){
    	if($(this).find('.checkbox_on_active').length == 1){
    		accesory_ids += '&accesory_id[]='+$(this).attr('cart_id');
    		goods_num++;
    	}
    })
    //没有勾选要收藏的产品
	if (accesory_ids == ''){
		modal_bg();
		msgbox(0, selected_none);
		$(this).removeClass("selected_cart_loading");
		return false;
	}

	var warehouse = $("#curWarehouse").val();

	//主产品
	var main_pid = $("#products_id").val();
	var selOpResult = getSelectedOptions();
	if(selOpResult==false){
		$('.select_prompt').find('span').addClass('twinkling');
		setTimeout(function(){
			$('.select_prompt').find('span').removeClass('twinkling');
		},2000);
		return false;
	}
	if(selOpResult){
		if($('#isCheckStock').val()==1){//检查是否还在查库存状态
			return false;
		}
		for(var i = 0; i < selOpResult.optionIds.length; i++){
			var op = selOpResult.optionIds[i];
			var val = selOpResult.valueIds[i];
		 	main_pid += '{'+op+'}'+val;
		}
	}

	//发送ajax请求
	$.ajax({
	    type: 'post',
		url: homeUrl + 'index.php',
		data :'com=product&t=addAccesoryToCart&warehouse='+warehouse+'&main_pid='+main_pid+accesory_ids,
		dataType: 'json',
		success: function(res){
			if(res.error == 0){
				//加载头部购物车
				loadHeadCart();
			    modal_bg();
			    msgbox(0,res.msg);
				sumCartGoodsNum(goods_num);
			}
			$(".goods_together_new .selected_cart").removeClass("selected_cart_loading");
		}
	});
});


//配件选择功能
$(document).on("click",".goods_together_new .price",function(){
	var li=$(this).parents("li"),
		$checkbox = $(this).find('span');
	if ($('#addWsCoLumnToCart').length > 0) return false;
	var item_attr_box=$(".goods_together_new .item_attr_box");
	if(!li.hasClass("selected")){
		if(li.hasClass("hasattr")){
			goods_getattr(li.attr("id"));
			$(".goods_together_new .item_attr_list").children().hide();
			$(".goods_together_new .item_attr_list ."+ li.attr("id")).show();
			$(".goods_together_new").addClass("goods_together_zindex");
			if(li.parent().parent().hasClass("thisitem")){
				item_attr_box.fadeIn().css({"left":16});
			}else{
				item_attr_box.fadeIn().css({"left":$(this).parent().position().left + 284});
			}
		}
	}else{
		$(".goods_together_new").removeClass("goods_together_zindex");
		item_attr_box.fadeOut();
	}
	//获取主产品id
	var main_pid = $("#main_pro_bdl").val();
	li.toggleClass("selected");
	$("#selected_main").removeClass("checkbox_on");
	$("#selected_main").addClass("checkbox_on_active");
	var tmpObj = $checkbox;
	$('.btn').find('.re_ok').eq(0).addClass('ok');
	$('.btn').find('.re_ok').eq(0).removeClass('cancel');
	if(li.hasClass('hasattr')){
		var id = li.attr("id");
		var arr = new Array();
		arr =id.split("_");
		var bdl_pid = arr[1];
		var tmpflag = false;
		$('.item_' + bdl_pid).find('img').each(function(){
            if ($(this).attr('src') == '') {
                $(this).attr('src', $(this).attr('osrc'));
            }
        });

		$('.item_' + bdl_pid).find('a').each(function(){
			if($(this).hasClass('out_stock')){
				tmpObj.removeClass("checkbox_on_active");
				tmpObj.addClass("checkbox_on");
				li.removeClass('selected');
				tmpflag = true;
			}
		});
		if(tmpflag){
			$('.btn').find('.re_ok').eq(0).addClass('cancel');
			$('.btn').find('.re_ok').eq(0).removeClass('ok');
		}
	}

	calculateBundlePrice();
});


$(document).on("click",".goods_together_new .item_attr_box .close,.goods_together_new .item_attr_box .cancel,.goods_together_new .chang",function(){
	$(".goods_together_new").removeClass("goods_together_zindex");
	var item_attr_box=$(".goods_together_new .item_attr_box");
	item_attr_box.fadeOut();
});
$(document).on("click",".goods_together_new .item_attr_box .ok",function(){
	$(".goods_together_new").removeClass("goods_together_zindex");
	var item_attr_box=$(".goods_together_new .item_attr_box");
	item_attr_box.fadeOut();
});
//accessory切换属性
$(document).on("click",".goods_together_new .item_attr_box .attr a",function(){
	if($(this).hasClass("attrimg"))
	{
		$(this).addClass("imgactive").append("<i />").siblings().removeClass("imgactive").find("i").remove();
	}else{
		$(this).addClass("active").append("<i />").siblings().removeClass("active").find("i").remove();
	}

	if($(this).parent().parent().attr('id') == 'temptest'){
		$(this).parent().find("a").removeClass('out_stock');
		//判断属性组合的poa是否有库存;如果没有则变灰
		var obj = $(this).parent().parent().parent();
		obj.find("a").each(function(){
			if($(this).hasClass('out_stock')){
				$(this).removeClass('out_stock');
				if($(this).hasClass("attrimg")){
					$(this).addClass('imgactive');
				}else{
					$(this).addClass('active');
				}
			}
		});
		checkStockByPoa(obj);
	}

	var mobjAttr = $(this).parent().parent();
	var accesory_id = mobjAttr.attr('acc_id');
	var moptions = '';
	mobjAttr.find(".active,.imgactive").each(function(){
		var moptions_id = $(this).parent().attr("option_id");
		var moptions_val_id = $(this).attr('value_id');
		var moptions_str = '{' + moptions_id + '}' + moptions_val_id;
		moptions = moptions + moptions_str;
	});
	var cart_id = accesory_id + moptions;

	$('#item_' + accesory_id).attr('cart_id', cart_id);

	return false;
});


function autoClickAttrPic(sel_attr){
	if(sel_attr != 'undefined'){
		$.each(sel_attr, function(attr_id, attr_val){
			if($(".attrValues.attrimg[option_id='"+attr_id+"'][value_id='"+attr_val+"']").find("img").eq(0).length){
				clickAttrPic($(".attrValues.attrimg[option_id='"+attr_id+"'][value_id='"+attr_val+"']").find("img").eq(0), '0');
				return false;
			}
		})
	}
}

if($(".good_photo_max_fashion").length>0)
{
	$(".detailpage .good_tabs_box .list:first-child").find("table").css({"border-spacing":"2px","border-collapse":"inherit","width":"100%"});
}

if( $(".size_chart").attr("child_data")=='is_children_shoes' || $(".today_recommend").length>0 && $(".good_photo_max_fashion").length==0 && $(".good_photo_max_fashion_450").length==0)
{
	var shoesTable = $(".detailpage .good_tabs_box .list:first-child").find("table");
	shoesTable.each(function(){
		var trTable = $(this).find("tr").length;
		var colspan = $(this).find("tr:last td").attr("colspan");
		var tdTable = $(this).find("tr:last td").length;
		if(trTable>3)
		{
			if(colspan>0 && tdTable==1)
			{
				$(this).addClass("charts_hover");
			}
			else
			{
				if(tdTable>4)
				{
					$(this).addClass("charts_hover");
				}
			}
		}
	});
}

$(document).on("mouseenter",".charts_hover td",function(){
	var $this  = $(this);
	var $table = $this.parents(".charts_hover");
	var colspan = $table.find("td").attr("colspan");
	$table.find(".active").removeClass("active");
	if(colspan>0)
	{
		$this.addClass("active").parent().children().eq(0).addClass("active");
        if($(".size_chart").attr("child_data")=='is_children_shoes'){
            $this.addClass("active").parent().children().eq(4).addClass("active");
            $this.addClass("active").parent().children().eq(5).addClass("active");
        }else{
            $this.addClass("active").parent().children().eq(6).addClass("active");
	    	$this.addClass("active").parent().children().eq(7).addClass("active");
        }

		$table.find("tr:eq(1)").children().eq($this.index()).addClass("active");
		$table.find("tr:first").addClass("tr_first");
		$table.find("tr:last").addClass("tr_last");
	}
	else{
		$this.addClass("active").parent().children().eq(0).addClass("active");
		$table.find("tr:eq(0)").children().eq($this.index()).addClass("active");
		if($table.hasClass("is_ring_product")&&$this.index()>0){
            $this.addClass("active").parent().children().eq(1).addClass("active");
		}
	}
});

$(".good_main .item_discount_box").hover(
	function(){

		$(".good_main .warehouse").css("z-index",3);
		$(".good_main .item_discount_tips_wrap").stop().slideDown(300);
		setTimeout(function(){
			$(".good_main .item_discount_tips .arrow_b").show();
		},300);
	},

	function(){
		$(".good_main .warehouse").css("z-index",'');
		$(".good_main .item_discount_tips_wrap").hide();
		$(".good_main .item_discount_tips .arrow_b").hide();
	});


//详细页赠品
$(document).on("click",".giftmedule_list li span:first-child",function(){
	var accesory_id = $(this).attr('acc_id');
	if( $(this).hasClass("checkbox_on_active")){
		$(".more_select_box_list[acc_id='"+accesory_id+"']").show();
	}else{
		$(".more_select_box_list[acc_id='"+accesory_id+"']").hide();
	}
	if ($(this).hasClass("hasattr")) {
		checkGiftNumber();
	};
});
$(document).on("click",".more_select_box .more_select",function(){
	$(this).next().slideToggle();
});
$(document).on("click",".more_select_tip .close,.more_select_tip .cancel,.more_select_tip .ok",function(){
	$(this).parents(".more_select_tip").slideUp();
});
$(document).on("click",".gift_attr a",function(){
	if($(this).hasClass("attrimg"))
	{
		$(this).addClass("imgactive").append("<i />").siblings().removeClass("imgactive").find("i").remove();
		$(this).siblings().removeClass("active");
	}else{
		$(this).addClass("active").append("<i />").siblings().removeClass("active").find("i").remove();
		$(this).siblings().removeClass("imgactive");
	}
	return false;
});
function checkGiftNumber(){
	var cur_warehouse = $('#curWarehouse').val();
	var num = $('.item_box.giftmedule[warehouse='+cur_warehouse+']').find(".checkbox_on_active.hasattr").length;
	if(num==0){
		$('.item_box.giftmedule[warehouse='+cur_warehouse+']').find(".more_select_box").fadeOut();
	}
	else{
		$('.item_box.giftmedule[warehouse='+cur_warehouse+']').find(".more_select_box").fadeIn();
	}
}
checkGiftNumber();
function changeWarehouseGift(){
	var cur_warehouse = $('#curWarehouse').val();
	$('.item_box.giftmedule').hide();
	$('.item_box.giftmedule[warehouse='+cur_warehouse+']').show();
	checkGiftNumber();
}

$(document).on("click",".arrivalnotice",function(){

	var products_id = $("input[name='products_id']").val();
	if($(".alert_arrival_item").length>0){return false;}
	$.ajax({
		url:homeUrl+'index.php?',
		type : 'get',
		data :'com=product&t=presellAlert&pid='+products_id,
		dataType:'html',
		success:function(html){
			modal_bg();
			$('.modal_container').append(html);
			modal_add();
		}
	});

});

$(document).on("click",".buy_link .arrival_alert",function(){
	var status = false;
	var o = $(this);
	var products_id = $("input[name='products_id']").val();
	if(o.hasClass('loading'))return;
	var attrCount = 0;
	var all_value_ids = '';
	var poastock = all_Stock_Out;
	if($('.good_main .attr').length>0){
		if(poastock != true){
			$('.good_main .attr').each(function(){
				if($(this).find('.hasclicked').length==0){
					if($(this).find('a').length>$(this).find('.out_stock').length){
						attrCount ++;
						$(this).find('.select_prompt').show();
					}
				}else{
					var value_id = $(this).find('.hasclicked').attr('value_id');
					if(typeof(value_id) == 'undefined'){
						value_id = '';				
					}

					all_value_ids += '&value_ids[]='+ value_id;
				}
			});
		}else{
			$('.good_main .attr').each(function(){
				var value_id = $(this).find('.hasclicked').attr('value_id');
				if(typeof(value_id) == 'undefined'){
					value_id = '';				
				}
				if(value_id !=''){
					all_value_ids += '&value_ids[]='+ value_id;
				}

			});
		}
	}
	if(attrCount>0){
		status = true;
	}
	if(status){
		return false;
	}
	o.addClass('loading');
	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data :'com=product&t=arrivalNotice&products_id='+products_id+'&warehouse=CN'+all_value_ids,
		dataType:'json',
		success:function(res){
			if(res.login == false){
				login();
			}else{
				modal_bg();
				$('.modal_container').append(res.html);
				modal_add();
				o.removeClass('loading');
			}
		}
	});

});

function removeArrivalNotice(){
	$('.arrivalnotice_item').remove();
}

function SendArrivalNoticeConfirm(obj){
	var status = false;
	var o = $(obj);
	var input = o.parent().prev().find('input');
	var val = input.val();
	var oldval = input.attr('oldvalue');
	var initval = input.attr('initvalue');
	var msg = input.attr('msg');
	var msg2 = input.attr('msg2');
	input.siblings('.tips').remove();
	var products_id = $("input[name='products_id']").val();
	var warehouse = $('.good_main .warehouse ul li.active').attr('id');
	var all_value_ids = '';
	var attrCount = 0;
	var poastock = all_Stock_Out;
	if($('.good_main .attr').length>0){
		if(poastock != true){
			$('.good_main .attr').each(function(){
				/*if($(this).find('.hasclicked').length==0){
					attrCount ++;
				}*/
				var value_id = $(this).find('.hasclicked').attr('value_id');
				if(typeof(value_id) == 'undefined'){
					value_id = '';				
				}

				all_value_ids += '&value_ids[]='+ value_id;
			});
		}
		else{
			$('.good_main .attr').each(function(){
				var value_id = $(this).find('.hasclicked').attr('value_id');
				if(typeof(value_id) == 'undefined'){
					value_id = '';				
				}
				if(value_id !=''){
					all_value_ids += '&value_ids[]='+ value_id;
				}

			});
		}
	}
	/*if(attrCount>0){
		status = true;
	}*/
	
	if(!val){
		input.focus();
		status = true;
	}else{
		if(val != initval && !zValidate.email(val)){
			inputNotice(input, msg);
			status = true;
		}else{
			var testmail = val.split('@');
			if(testmail[1] == 'banggoodauto.com'){
				inputNotice(input, msg2);
				status = true;
			}else if(val==initval){
				val = oldval;
			}
		}
	}

	if(status){
		return false;
	}


	o.addClass('loading');
	
	$.ajax({
		url:homeUrl+'index.php?',
		type : 'post',
		data :'com=product&t=submitArrivalNotice&products_id='+products_id+'&warehouse='+warehouse+'&email='+val+all_value_ids,
		dataType:'json',
		success:function(res){
			modal_remove();
			modal_bg();
			$('.modal_container').append(res.html);
			modal_add();
			if(val==initval){
				$('.arrivalnotice_success .text b').html(initval);			
			}else{
				var formatPhoneReg1 = /^(..).+(..)$/g;
				var replacestr = '';
				var formatPhone = val.split('@');
				if(formatPhone[0].length>4){
					replacestr = formatPhone[0].replace(formatPhoneReg1, "$1***$2");
				}else{
					replacestr = formatPhone[0].substr(0,2)+'***';
				}
				$('.arrivalnotice_success .text b').html(replacestr+'@'+formatPhone[1]);	
			}
			
		}
	});

}

function AlertMeOnArrival(obj){
	var o = $(obj);
	if(o.hasClass("loading")){return false;}
	var email = o.siblings("dl").find("input");
	var val = email.val();
	var products_id = $("input[name='products_id']").val();
	var status = false;
	o.siblings("dl").find(".tips,.log").remove();
	if(!zValidate.email(val)){
		var msg = email.attr("msg");
		email.parent().append("<div class='tips'><i></i>" + msg + "</div>");
		var status = true;
	}
	if(o.siblings("dl").find('.log').length>0)
	{
		return false;
	}
	if(status)
	{
		return false;
	}
	o.addClass("loading");

	$.ajax({
		url:'index.php',
		type : 'post',
		data :'com=product&t=ajaxAddPre&email=' + val + '&products_id=' + products_id,
		dataType:'json',
		success:function(res){
			preorder_success(res.msg);
			o.removeClass("loading");
			//推荐统计
			Rd.detailAutoClick('presell',$('#products_id').val());
		}
	});

	return false;
}

function preorder_success(msg){
	var text = '<span class="log"><i></i>' + "Successfully pre ordered, you will be emailed when stock arrives." + '</span>';
	if($(".alert_arrival_item .log").length > 0){
		$(".alert_arrival_item .log").remove();
	}
	$(".alert_arrival_item .alertbox").empty().append(text);
	setTimeout(function(){
		modal_remove();
	},3000);
};

/*
$(document).on("mouseover","#item_shipments_box .item_con",function(){
        var curWarehouse = $('#curWarehouse').val();
        var cur_ship_method = $(this).find("a").text();
        var ship_reg = '';
        var NoTracking  = "<div class='shiping_tracking'>"+LANGUAGE.LP_TRACKING_NUMBER_NO+"</div>";
        $(this).find("a").append(NoTracking);
        if(curWarehouse=='USA'){
            ship_reg = new RegExp( ship_lang_usa.LC_SHIPMENT_IPA_IPA);
            if(ship_reg.test(cur_ship_method)){
                $(this).find("a").find(".shiping_tracking").css({  'display':'block' });
            }
        }else if(curWarehouse=='UK'){
            for(x in ship_lang_uk){
                ship_reg = new RegExp( ship_lang_uk[x]);
                if(ship_reg.test(cur_ship_method)){
                    $(this).find("a").find(".shiping_tracking").css({  'display':'block' });
                }
            }
        }
});
$(document).on("mouseout","#item_shipments_box .item_con",function(){
   $(this).find("a").find(".shiping_tracking").remove();
});
*/

//判断数量是否超过了特定产品限制
function checkSpecialNum(quantity)
{
        if ($("#special_limit_num").length > 0) {
                var special_limit_num = $("#special_limit_num").val();
                if (quantity >= special_limit_num) {
                		showFlashDealsMsg('hide');
                        var msg = $("#special_limit_msg").text();
                        $(".good_main .quantity").css("height",($(".good_main .quantity").height()+30)+"px");
                        $(".good_main .quantity").append('<u><i></i>'+msg+'</u>');
                        $("#quantity").val(special_limit_num==0?1:special_limit_num);
                        return false;
                }
        }
        return true;
}

$(function() {
    //倒计时一分钟海外仓提示消失
    setTimeout(function () {
        $(".good_main .warehouse").removeClass("warehouse_prompt");
    }, 60000);

	// 处理apponlyprice面板的显示
	var isLogin = parseInt($(".header_login .user_info .user_log").attr("haslogin"));
	if(isLogin){
		$(".mobile_discount_wrap .nologin").hide();
		$(".mobile_discount_wrap .online").show();
	} else {
		$(".mobile_discount_wrap .nologin").show();
		$(".mobile_discount_wrap .online").hide();

		$(".mobile_discount_wrap .nologin a").click(function(){
			login();
		});
	}
})



function changeCurWarehouse(cur_warehouse){
	$(".good_main .warehouse ul li").each(function(){
		var id = $(this).attr("id");
		if(id==cur_warehouse){
			selWarehouse(this);
		}
	});
}

//异步图片延迟
function DetailLazyImage(){
	var _httpsStr = document.location.protocol == 'https:' ? "https:" : "http:";
	$("img.bg_lazy").lazyload({
		placeholder : _httpsStr+"//img.banggood.com/newimages/grey.gif",
		effect      : "fadeIn"
	});
}

//加入购物车换Customers Who Bought This Item Also Bought图片路径
function ChangeHotgood970(){
	$(".addcart_status .goodlist_1 li").each(function(){
		var src = $(this).find(".img img").attr("data-original");
		$(this).find(".img a").html('<img src="'+src+'" />');
	});
}

//链接上如果带有poa，默认选中
function selectPOA() {
    var ret = false;
    var href = decodeURI(location.href);
    if (href.indexOf('value_ids[]') != -1) {
        var value_ids = new Array();
        var urlArr = href.split('value_ids[]=');
        var len = urlArr.length;
        for (var i=0; i<len; i++) {
            if (i>0) {
                var tmp = urlArr[i].split('&');
                $(".attrValues").each(function() {
                    if ($(this).attr('value_id') == tmp[0]) {
                        $(this).trigger('click'); 
                        ret = true;
                        return false;
                    }
                })
            }
        }
    } else if (href.indexOf('ID=') != -1) {
        var urlArr = href.split('ID=');
        var id = urlArr[1].split('&')[0];
        do {
            var len = id.substring(0, 1);
            id = id.substring(1);
            var tmpId = id.substring(0, len);
            $(".attrValues").each(function() {
                if ($(this).attr('value_id') == tmpId) {
                    $(this).trigger('click'); 
                    ret = true;
                    return false;
                }
            });

        } while (id.length > 0);
    }

    return ret;
}

//根据url参数判断显示主图
function selectDefault(){
	var href = decodeURI(location.href);
    if (href.indexOf('ID') > -1) {
        var urlArr = href.split('ID=');
            if(urlArr.length == 1)return;
        var id = urlArr[1].split('&')[0];
        var len = id.substring(0, 1);
        id = id.substring(1);
        var tmpId = id.substring(0, len);
        $(".attrValues.attrimg").each(function() {

            if ($(this).attr('value_id') == tmpId) {
            	var smallImgurl = $(this).find('img').attr('src').replace('other_items//', 'other_items/').split('banggood.com')[1];
            	$('.good_photo_min li').each(function(index, item){
            		var listImgurl = $(item).find('img').attr('src').split('banggood.com')[1];
            		if (smallImgurl == listImgurl) {
            			$(item).addClass('active').siblings().removeClass('active');
        			}
            	});
            	var imgurl = $(this).find('img').attr('viewimage');
            	// console.log(imgurl, 966);
                $('.good_photo_max div').html('<img src="'+ imgurl +'" alt="" />');
            }
        })
    }
}
if ($('#addWsCoLumnToCart').length <= 0) selectDefault();

$(document).on('mouseenter','.more_save_box th,.more_save_box td',function(){
	var text = $(this).get(0).tagName;
	if(text=='TH'){
		$(this).parent().next().find('td').eq($(this).index()).css('background','#f4f4f4').siblings().removeAttr('style');
	}
	else{
		$(this).css('background','#f4f4f4').siblings().removeAttr('style');
	}
});

$(document).on('mouseleave','.more_save_box th,.more_save_box td',function(){
	$(this).parents('table').find('th,td').removeAttr('style');
});


$(document).on("click",".add_wish_btn",function(){
	var _this = $(this);
	var filter_id = [];
    $('#goods_together .scroll_box li').each(function () {
        var str = $(this).attr('id');
        if (str !== null && str !== undefined) {
            filter_id.push(str.substring(5));
        }
    });
	var products_id = $('#products_id').val();
	var timer = 0;
	var isClick = _this.hasClass('active');   //防止重复点击
	var data = 'com=product&t=addWishlist&products_id=' + products_id+"&filter_id="+ $('#products_id').val() + ',' + filter_id.join(',') + ',' + alsobuyPids.join(',') + ',' + hotProductIds.join(',');
	var imgSrc = $('.good_photo_max').find('img').attr('src'); //产品图片
	var title = $('.good_main').find('[itemprop=name]').text(); //产品标题
	var price_us = $('.good_main .hbactive b').text(); //货币符号
	var price = $('.good_main').find('.now').text(); //产品价格
	clearTimeout(timer);
	if(isClick)return;

	_this.addClass("active");
	modal_bg();

	$.ajax({
		url:homeUrl+'index.php',
		type : 'get',
		data : data,
		dataType:'json',
		success:function(res){
			_this.removeClass("active");
			modal_remove();
			if(res.login){
				login();
			}else{
				//amount（0：已收藏，-1：超过1000上限，1或大于1：收藏成功）
				if(res.amount>=1){
					_this.parent().find('u').text(res.amount);
					var wishNum = parseInt($("#userwish").text(), 10);
					$("#userwish").text((wishNum?wishNum:0)+1);
					check_wish_flag();

					modal_bg();
					$('.modal_container').append(res.template);
					modal_add();

				}else if(res.amount==-1){

					var _tip = _this.parent().siblings('.addwish_tip').find('.select_prompt');
					_tip.show().find('span').text(res.msg);
					timer = setTimeout(function(){
						_tip.hide();
					},2000);

				}else{

					modal_bg();
					$('.modal_container').append(res.template);
					modal_add();

				}
				$('.modal_container').find('.pic img').attr('src',imgSrc);
				$('.modal_container').find('.message .txt').text(title);
				$('.modal_container').find('.message .price').html(price_us+price);

				if(typeof(pintrk) != 'undefined'){
					pintrk('track', 'lead', {
				    lead_type: $('meta[property="og:title"]').attr('content')
				  });
				}
				if(res.recommend_products){
					$('.module .modal_container').css({marginTop:"250px"})
					if(res.lang=='ar-AR'){
						var commend_list = res.recommend_products;
						var commend_listStr = '' +						
						'<div class="customer_also_viwed_content">';
					commend_listStr += commend_list.length <= 4?'<div class="chang btn_left btn_off">':'<div class="chang btn_left">';
						commend_listStr += '' +
								'<span class="arrow_c">' +
									'<i><i></i></i>' +
								'</span>' +
							'</div>' +
							'<div class="chang btn_right btn_off">'+
								'<span class="arrow_d">' +
									'<i><i></i></i>' +
								'</span>' +
							'</div>' ;
					}else{
						var commend_list = res.recommend_products;
						var commend_listStr = '' +						
							'<div class="customer_also_viwed_content">' +
								'<div class="chang btn_left btn_off">' +
									'<span class="arrow_c">' +
										'<i><i></i></i>' +
									'</span>' +
								'</div>';
						commend_listStr += commend_list.length <= 4?'<div class="chang btn_right btn_off">':'<div class="chang btn_right">';
						commend_listStr += '' +
									'<span class="arrow_d">' +
										'<i><i></i></i>' +
									'</span>' +
								'</div>' ;
					}
					commend_listStr += '' +
							'<div class="contentList">' +
								'<div class="contentListBox">' +
									'<ul style=width:' + (commend_list.length * 136) + 'px;>';
					
					if(res.lang=='ar-AR'){
						for (var i = res.recommend_products.length-1; i >= 0; i--) {
							commend_listStr += '' +
											'<li>' +
												'<a class="sendrecommendPoint bottom_Recommendation'+recommendListNum(i)+'_image_180117 clickandsend" data-point-id="181523536'+(recommendListNum(i)+1)+'" href="' + commend_list[i].url + '?rmmds=detail-popup-addwish-alsoview" data-r_cid=' + commend_list[i].botCat + ' data-pro_id=' + commend_list[i].products_id + '>' +
													'<img src="' + commend_list[i].image_url + '" alt="' + commend_list[i].products_name + '">' +
												'</a>' +
												'<a class="sendrecommendPoint" href="' + commend_list[i].url + '?rmmds=detail-popup-addwish-alsoview" data-r_cid=' + commend_list[i].botCat + ' data-pro_id=' + commend_list[i].products_id + '>' +
													'<p>' + commend_list[i].products_name + '</p>' +
												'</a>' +
												'<div class="price">' + commend_list[i].format_final_price + '</div>' +
											'</li>';
						}
					}else{
						for (var i = 0; i < res.recommend_products.length; i++) {
							commend_listStr += '' +
											'<li>' +
												'<a class="sendrecommendPoint bottom_Recommendation'+recommendListNum(i)+'_image_180117 clickandsend" data-point-id="181523536'+(recommendListNum(i)+1)+'" href="' + commend_list[i].url + '?rmmds=detail-popup-addwish-alsoview" data-r_cid=' + commend_list[i].botCat + ' data-pro_id=' + commend_list[i].products_id + '>' +
													'<img src="' + commend_list[i].image_url + '" alt="' + commend_list[i].products_name + '">' +
												'</a>' +
												'<a class="sendrecommendPoint" href="' + commend_list[i].url + '?rmmds=detail-popup-addwish-alsoview" data-r_cid=' + commend_list[i].botCat + ' data-pro_id=' + commend_list[i].products_id + '>' +
													'<p>' + commend_list[i].products_name + '</p>' +
												'</a>' +
												'<div class="price">' + commend_list[i].format_final_price + '</div>' +
											'</li>';
						}
					}
					commend_listStr += '' +
									'</ul>' +
								'</div>' +
							'</div>' +
						'</div>';
					$('.customer_also_viwed').append(commend_listStr);
					}else{
						$(".customer_also_viwed").css({display:"none"})
					}
			}
		},
		error:function(){
			modal_remove();
		}
	});
});

/* 30754 */ 
$(document).on("click",".add_ebay_btn",function(){
	var _this = this;
	var products_id = $('#products_id').val();

	if(_this.onoff)return;
	_this.onoff = true;

	modal_bg();
	$.ajax({
		url:'/index.php?com=account&t=addToEbayCenter&products_id='+products_id,
		dataType:'json',
		success:function(res){
			_this.onoff = false; 

			var tipIcon = '';
			if(res.code=='Failure'){
				tipIcon = 'error';
			}
			//if(res.code=='Success'){			
				$('.modal_container').html('<div class="modal_ship addto_ebay_dialog_box">'+
					'<div class="modal_ship_con">'+
						'<div class="addto_ebay_dialog_tip"><span><i class="'+tipIcon+'"></i>'+res.msg+'</span></div>'+
					'</div>'+
				'</div>');
				modal_add();

				clearTimeout(_this.timer);
				_this.timer = setTimeout(function(){
					modal_remove();
				},3000);
			//}
		}
	});
});
/* 30754 end */ 

/*2016-08-13 addwish优化*/
(function(){
	//点击显示标签列表
	$('body').on('click.into','.into-btn',function(){
		var _this = $(this);
		var tagBox = _this.closest('.into').find('.wish_tag_box');
		var tagUl = tagBox.find('ul');
		var tagNum = tagUl.find('li').length;
		if(tagNum<=6){
			tagUl.css('height','auto');
		}else{
			tagUl.css('height','150px');
		}
		tagBox.show();
		return false;
	});

	//新增标签
	$('body').on('click.addTag','.add-btn',function(){
		var _this = $(this);
		var isClick = _this.hasClass('active');
		var products_id = $('#products_id').val();
		//tag_name（标签名称），is_delete（0：添加、修改，1：删除） tag_id（修改时标签ID）
		var tag_name = _this.closest('.add').find('input').val();

		//tag_name（标签名称），is_delete（0：添加、修改，1：删除） tag_id（修改时标签ID）
        //var data = 'com=product&t=newWishlisTagt&tag_name='+tag_name+'&is_delete=0&tag_id=';
        //对象写法，防止用户输入 tag_name 为  java & php ,有&符号解析不正确
        var data = {
        	com : 'product',
        	t : 'newWishlisTagt',
        	tag_name : tag_name,
        	is_delete : 0,
        	tag_id : ''
        };

		if(isClick)return;
		_this.addClass('active');

		$.ajax({
			url:homeUrl+'index.php',
			type : 'get',
			data : data,
			dataType:'json',
			success:function(res){
				// console.log(res);
				_this.removeClass('active');
				if(res.amount>=1){
					var oUl = $('.wish_tag_box').find('ul');
					oUl.append('<li data-id="'+res.id+'">'+
											'<div class="tag-title"><label class="my_allCheckbox checkbox_on"><i></i></label><span>'+tag_name+'</span></div>'+
										'</li>').show();
					var len = oUl.find('li').length;
					if(len<=6){
						oUl.css('height','auto');
					}else{
						oUl.css('height','150px');
					}
					_this.closest('.add').find('input').val('');
					_this.closest('.add').removeClass('add-active');
				}else{
					$('.wish_error_tip').remove();
					_this.closest('.wish_tag_box').prepend('<p class="wish_error_tip" style="display:none;background:#fe9900;color:#fff;line-height:15px;margin:0;padding:5px 12px;text-align:center;">'+res.msg+'</p>');
					$('.wish_error_tip').stop().slideDown();
					setTimeout(function(){
						$('.wish_error_tip').remove();
					},2000);
				}
			}
		});
	});

	//点击勾选，并添加到分类标签中
	$('body').on('click','.wish_tag_box li',function(){
		var _this = $(this);
		var label = _this.find('label');
		var isChecked = label.hasClass('checkbox_on_active');
		var tag_id = _this.attr('data-id');
		var products_id = $('#products_id').val();

		// var isClick = _this.hasClass('cur');
  //       if(isClick)return;
  //       _this.addClass('cur');

		if(isChecked){
			//取消加入
			label.removeClass('checkbox_on_active');
			toggleTagstaus(this,products_id,tag_id,1);
		}else{
			//加入标签
			label.addClass('checkbox_on_active');
			toggleTagstaus(this,products_id,tag_id,0);
		}

		function toggleTagstaus(obj,products_id,tag_id,status){
			//index.php?com=product&t=addWishlisTagt  参数products_id（商品ID,可多个，逗号隔开） ，tag_id（标签ID），is_delete是否删除（1：新增，0：删除）
			$.ajax({
				url:homeUrl+'index.php',
				type : 'get',
				data : 'com=product&t=addWishlisTagt&products_id='+products_id+'&tag_id='+tag_id+'&is_delete='+status,
				dataType:'json',
				success:function(res){
					_this.removeClass('cur');
					if(res.amount && res.amount>0){
						var tagnum = $(obj).closest('.wish_tag_box').find('.checkbox_on_active').length;
						var intoNum = $(obj).closest('.into').find('.into-num');
						if(tagnum>0){
							intoNum.html('(Added into <i>'+tagnum+'</i> tag)').show();
						}else{
							intoNum.html('(Added into <i>0</i> tag)').hide();
						}
					}
				},
                error:function(){
                    _this.removeClass('cur');
                }
			});
		}



	});

	//标签显示隐藏
	$('body').on('click.hide','.modal_ship',function(){
		$('.wish_tag_box').hide();
	});
	$('body').on('click.show','.wish_tag_box',function(){
		return false;
	});

	//清空输入的tag_name
	$('body').on('click.del','.del-txt-btn',function(){
		$(this).closest('.add').find('input').val('');
		$(this).closest('.add').removeClass('add-active');
	});

	$('body').on('keyup keypress keydown','.add-input input',function(){
		var val = $(this).val();
		if(val.length>24){
            $(this).val(val.substring(0,24));
        }
		if(val){
			$(this).closest('.add').addClass('add-active');
		}else{
			$(this).closest('.add').removeClass('add-active');
		}
	});

	//邮箱订阅提醒
	$('body').on('click','.wish_dialog_con .recieve',function(){
		var _this = $(this);
		setTimeout(function(){
			var isChecked = _this.find('label').hasClass('checkbox_on_active');
			var oTaggle = _this.siblings('.recieve_toggle');
			if(isChecked){
				oTaggle.show();
			}else{
				oTaggle.hide();
			}
		},10);
	});
	$('body').on('click','.wish_dialog_con .submit input',function(){
		var _this = $(this);
		var isClick = _this.hasClass('active');
		var oldEmail = $('.recieve_toggle').find('.recieve_email input').attr('init-email');
		var email = $('.recieve_toggle').find('.recieve_email input').val();
		var tip = $('.recieve_toggle').find('.tip');
		var myreg = /^[\w-']+([\.\+][\w-']+)*@([a-zA-Z0-9-]+(\.[a-zA-Z0-9-]+)*?\.[a-zA-Z]{2,6}|(\d{1,3}\.){3}\d{1,3})(:\d{4})?$/;
		var products_id = $('#products_id').val();
		var curWarehouse = $('#curWarehouse').val();
		if(email==oldEmail){
			email = $('.recieve_toggle').find('.recieve_email input').attr('email');
		}else if(!email || !myreg.test(email.replace(/(^\s*)|(\s*$)/g, ""))){
			tip.show();
			return;
		}
		if(isClick)return;
		_this.addClass('active');
		$.ajax({
			url:homeUrl+'index.php',
			type : 'post',
			data : 'com=ajax&t=priceAlert&products_id='+products_id+'&cur_warehouse='+curWarehouse+'&email='+email+'&notetxt=bool',
			dataType:'json',
			success:function(res){
				modal_remove();
			}
		});
	});

})();

/*end 2016-08-13 addwish优化*/

//Review GA
var reviewgaCount = 0;
var productdetaillabel = ['Review_Write','Review_All','Review_Good','Review_Bad','Review_Images','Review_Comments','Review_Useful','Review_Useless','QuestionC_post-new-topic'];
var jiongfilter = ['Review_','QuestionC_'];

for(shcl=0;shcl<productdetaillabel.length;shcl++){
	$(document).on('click','.'+productdetaillabel[shcl]+'',function(){
		var objarr = $(this).get(0).className.split(" ");
		for (var jb = 0; jb < objarr.length; jb++){
			for(var jc=0;jc < jiongfilter.length;jc++){
				if(objarr[jb].indexOf(jiongfilter[jc]) > -1){
					if(reviewgaCount<1){
						var gahtml = ''+
							'<script type="text/javascript">\
						         (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){\
								  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\
								  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\
								  })(window,document,"script","//www.google-analytics.com/analytics.js","ga");\
								  ga("create", "UA-3406726-2", "banggood.com");\
								  ga("require", "displayfeatures");\
								  ga("send", "pageview");\
							</script>';
							$('body').append(gahtml);
						}
					ga('send', 'event', 'Product_Detail', 'Click', ''+objarr[jb]+'');
					reviewgaCount++;
				}
			}
		}
	});
}

$('.detailpage .good_tabs_box .list:first-child').find('span,strong,font,div,em,p').each(function(){
	var arr = [];
	var leftstr = '(';
    var rightstr = ')';
	var type = $(this).attr('style');
	var color = $(this).css('Color');
	if(typeof(type) == 'undefined'){
		type = '';
	}

	color  = color.replace(/color/,'');
	color = color.replace(/rgb/,'');
	color = color.replace(leftstr,'');
	color = color.replace(rightstr,'');
	arr = color.split(',');

	if(arr[0]==255 && arr[1]==0 && arr[2]==0){

	}else{
		type = type.replace(/color/g,'');
	}
	$(this).attr('style',type);
	$(this).removeAttr('color');
});

$('.detailpage .good_tabs_box .list:first-child').find('td').each(function(){
	var arr = [];
	var leftstr = '(';
    var rightstr = ')';
	var type = $(this).attr('style');
	var color = $(this).css('Color');
	var bgcolor = $(this).css('backgroundColor');
	if(typeof(type) == 'undefined'){
		type = '';
	}
	if(bgcolor.indexOf('rgba')>-1){
	}
	else{
		color = bgcolor;
	}
	color  = color.replace(/color/,'');
	color = color.replace(/rgb/,'');
	color = color.replace(leftstr,'');
	color = color.replace(rightstr,'');
	arr = color.split(',');
	if(arr[0]==255 && arr[1]==0 && arr[2]==0){

	}else{
		if(($(this).get(0).tagName.toLowerCase()=='td' && arr[0]==255 && arr[1]==255 && arr[2]==0) || ($(this).get(0).tagName.toLowerCase()=='td' && arr[0]==128 && arr[1]==128 && arr[2]==128)  || ($(this).get(0).tagName.toLowerCase()=='td' && arr[0]==51 && arr[1]==51 && arr[2]==51)){
			type = type.replace(/color/g,'');
		}
	}
	$(this).attr('style',type);
});

/*20170222 coupon领取样式优化*/
(function(){

	var couponTimer = 0;
	$('.item_coupon').on('mouseover click','.coupon_enter',function(){
		clearTimeout(couponTimer);
		$(this).find('.coupon_enter_list').show();
		if(!this.onoff){
			getCopy();
	    }
	    this.onoff = true;
		// return false;  //注视掉，避免埋点没法发起请求
	});
	$('.item_coupon').on('mouseout','.coupon_enter',function(){
		var _this = this;
		couponTimer = setTimeout(function(){
			$(_this).find('.coupon_enter_list').hide();
		},100);
	});
	$('.item_coupon').on('mouseout','.get_it_btn',function(){
		clearTimeout(couponTimer);
		return false;
	});

	//get it
	function getCopy(){
		$('.get_it_btn').zclip({
	        path: "/templates/black/js/ZeroClipboard.swf",
			copy: function() {
				return $(this).attr('code');
			},
			afterCopy:function(){
				if($(this).closest('li').hasClass('copyed'))return;
				modal_bg();

				var _this = this;
				var coupon_id = $(_this).attr('coupon_id');
				var isClick = $(_this).hasClass('cur');

				if(isClick)return;
				$(_this).addClass('cur');

				$.get('/index.php?com=product&t=ajaxGetPublicCoupon&coupon_id='+coupon_id,function(res){
					$('.item_coupon').find('.coupon_enter_list').hide(); //隐藏coupon列表
					//console.log(res);
					$(_this).removeClass('cur');
					// code 1 成功，-2 没登录。其他失败
					if(res.code==-2){
						login();
					}else if(res.code==1){
						$('.modal_container').append($('.item_coupon_dialog').html());
						modal_add();

						var time = $('.module .item_coupon_dialog_box').find('.tm span');
						var num = 3;
						var timer = 0;
						$(_this).closest('li').addClass('copyed');

						clearInterval(timer);
						timer = setInterval(function(){
							num--;
							if(num<=0){
								modal_remove();
								$('.item_coupon').find('.coupon_enter_list').hide(); //隐藏coupon列表
								clearInterval(timer);
							}
							time.text(num);
						},1000);
					}else{
						modal_remove();
					}
				},'json');

			}
	    });
	}
})();
/*end 20170222 coupon领取样式优化*/

function Ajaxalsoviewlookingfor(){

        function ViewAlsoView() {
            var rec_sid = GetRecommendCookie('rec_sid');
            var filter_id = [];
            $('#goods_together .scroll_box li').each(function () {
                var str = $(this).attr('id');
                if (str !== null && str !== undefined) {
                    filter_id.push(str.substring(5));
                }
            });
/*            var hotProductIds = [];
            $('.bot .goodlist_1 li').each(function () {
                var pro_id = $(this).attr('products_id');
                if(pro_id !== null && pro_id !== undefined){
                    hotProductIds.push(pro_id);
				}
                // console.log(hotProductIds);
            });*/
            var ab = rec_sid.split('|');
            ab = ab[0];
            ab = ab % 2;

            $.ajax({
                url: homeUrl + 'alsoview-' + $('#products_id').val() + '.html?filterId=' + $('#products_id').val() + ',' + filter_id.join(',') + ',' + alsobuyPids.join(',') + ',' + hotProductIds.join(',') + '&ab=' + ab,
                timeout: 10000,
                type: 'get',
                dataType: 'html',
                success: function (html) {
                    $('.viewalsoview').addClass('rec_viewalsoview');
                    if (html) {
                        if ($('.viewalsoview').attr("class").indexOf("viewalsoviewTop") > 0) {
                            $('.viewalsoviewLocation').before('<div class="wrap viewalsoview"></div>');
                        } else {
                            $('.viewalsoview').show();
                        }
                        $('.viewalsoview').html(html);
                        scroll_play('.hotgoods_1200', 6);
                        $("img.bg_lazy").lazyload({
                            placeholder: httpsStr + "//img.banggood.com/newimages/grey.gif",
                            effect: "fadeIn"
                        });
                    } else {
                        $('.viewalsoview').show();
                    }
                    $('.viewalsoview .goodlist_1 li').each(function () {
                        var href = $(this).find('.img a').attr('href');
                        var s = new RegExp(".*-p-([0-9]*)\\.html");
                        var g = s.exec(href);
                        looingforPids.push(g[1]);
                    });
                }
            });
        }

        if ($('.viewalsoview').length > 0) {
            ViewAlsoView();
        }
    }

/* 2017-03-24 品牌街详情页入口 */
//(function(){
//	已经合并到 ajaxAllin 接口
//	var products_id = $('#products_id').attr('value');
//	$.ajax({
//		type: 'get',
//		url: '/index.php?com=product&t=ajaxBrand&products_id=' + products_id,
//		dataType: 'json',
//		success: function(res){
//			if (typeof(res) != "undefined" && res) {
//				/* 13678 */
//				var tpl_html = '<li><span style="padding-right:5px;">'+res.text+': <a href="'+res.url+'" style="color:#f60; text-decoration: none;">'+res.brands_name+'</a></span></li>';
//				$('.good_main .info').prepend(tpl_html);
//				/* end 13678 */
//			}
//		}
//	});
//})();
/* end 2017-03-24 品牌街详情页入口 */

    function GetRecommendCookie(cookie_name) {
        var allcookies = document.cookie;
        var cookie_pos = allcookies.indexOf(cookie_name);
        var mycookies = '';
        if (cookie_pos != -1) {
            cookie_pos = cookie_pos + cookie_name.length + 1;
            var cookie_end = allcookies.indexOf(";", cookie_pos);
            if (cookie_end == -1) {
                cookie_end = allcookies.length;
            }
            mycookies = unescape(allcookies.substring(cookie_pos, cookie_end));
        }
        return mycookies;
    }

    var frequentlyBuyID = [];
    var hotProductIds = [];

    function getHotProduct() {
        var rec_sid = GetRecommendCookie('rec_sid');
        $('#goods_together .scroll_box li').each(function () {
            var str = $(this).attr('id');
            if (str !== null && str !== undefined) {
                frequentlyBuyID.push(str.substring(5));
            }
        });

        var ab = rec_sid.split('|');
        ab = ab[0];
        ab = ab % 2;
        var product_id = $('#products_id').val();
        var url = 'HotProduct-' + product_id + '.html?ab=' + ab + '&filterId=' + $('#products_id').val() + ',' + frequentlyBuyID.join(',');
        var lang = $.cookie("_bgLang");
        if (lang == 'en-GB') {
            url += '&lang=' + lang;
        }
        $.ajax({
            url: url,
            timeout: 10000,
            type: 'get',
            dataType: 'html',
            success: function (html) {
                if ($('.hotlist_1').length > 0) {
                    $('.hotlist_1').addClass('ajax_hotproduct');
                    $('.ajax_hotproduct').before(html);
                    $('.ajax_hotproduct').remove();
                } else {
                    if ($('.hotlist_3').length > 0) {
                        $('.hotlist_3').before(html);
                    } else {
                        $('.wrap_left').prepend(html);
                    }
                }

                $(".hotlist_1 img").lazyload({
                    placeholder: httpsStr + "//img.banggood.com/newimages/grey.gif",
                    effect: "fadeIn"
                });
                $('.wrap_left .hotlist_1 .goodlist_1 li').each(function () {
                    var href = $(this).find('.img a').attr('href');
                    var s = new RegExp(".*-p-([0-9]*)\\.html");
                    var g = s.exec(href);
                    hotProductIds.push(g[1]);
                });
                // console.log(hotProductIds);
                getAlsoBuy();
            }
        });
    }



$(document).on('mouseenter','.sizechange_item',function(){
	/* 21555 */
	if($(this).hasClass('changesize')){
		$(this).addClass('active');
	}
	/* 21555 */
});
$(document).on('mouseleave','.sizechange_item',function(){
	$(this).removeClass('active');
});

$(document).on('click','.sizechange_item .list li',function(){
	var size = $(this).attr('data-size');
	var text = $(this).html();
	var sizeArr = [];
	for(var i=0;i<AllCountrySize.length;i++){
		if(AllCountrySize[i].country == size){
			$(this).parent().parent().prev().find('.sizename').html(text);
			sizeArr = AllCountrySize[i].value_name.split(',');
		}
	}
	for(var j=0;j<sizeArr.length;j++){
		$(this).closest('.item_box').find('.attrValues').eq(j).attr({'title':sizeArr[j],'ori_name':sizeArr[j]});
		$(this).closest('.item_box').find('.attrValues').eq(j).html(sizeArr[j]);
		if($(this).closest('.item_box').find('.attrValues').eq(j).hasClass('active')){
			$(this).closest('.item_box').find('.attrValues').eq(j).append('<i />');
		}
	}
});

if(typeof(AllCountrySize) != 'undefined' && AllCountrySize.length>0 && $('#all_country_size').length>0){
	$('.sizechart_item').show();
	var size_item_name = $('#all_country_size').find('.item_name').html();
	var size_clone_html = size_item_name.split('</b>');
	var countrySizeList = '';
	/* 21555 */
	for(var i=0;i<AllCountrySize.length;i++){
		if(AllCountrySize[i].value_name){
			var countrysizeli = '<li data-size="'+AllCountrySize[i].country+'"><b>('+AllCountrySize[i].country+')</b> '+size_clone_html[1].split(':')[0]+'</li>';
			countrySizeList += countrysizeli;
		}
	}
	$('.detailpage .good_tabs_box .sizechart_item .text').html(size_item_name);
	$('.detailpage .good_tabs_box .sizechart_item ul').html(countrySizeList);

	var coverSizeHtml = ''+
		'<div class="sizechange_item '+(countrySizeList?'changesize':'')+'">'+
			'<div class="sizetags">'+
				'<span class="sizename">'+size_item_name+'</span><span class="arrow_a"><i><i></i></i></span>'+
			'</div>'+
			'<div class="list">'+
				'<ul>'+
					countrySizeList
				'</ul>'+
			'</div>'+
		'</div>'
	$('#all_country_size .item_name').html(coverSizeHtml);
	/* 21555 */

	//var sizechangewidth = $('.sizechange_item').outerWidth();
	var sizenamewidth = $('.sizechange_item .sizename').outerWidth();
	if(sizenamewidth>60){
		$('.sizechange_item').css('width',sizenamewidth+31);
	}
}

/*#14992 多件优惠促销需求 start*/
/*showFlashDealsMsg()有改动*/
function createBuyMore(){
	$('.good_main .buymoresavemore li:not(":first-child")').each(function(){
		var max = $(this).attr('max');
		var eachprice = $(this).attr('each-price');
		filterBuyMoreSaveMoreNum.push(max);
		filterBuyMoreSaveMorePrice.push(eachprice);
	});
}
$(document).on('click','.good_main .buymoresavemore li:not(":first-child")',function(){
	if($(this).siblings().hasClass('twinkling') || $(this).hasClass('twinkling'))return;
	var o = $(this);
	var num = $(this).attr('max');
	var price = $(this).attr('each-price');
	$('#quantity').val(num);
	$('#quantity').addClass('twinkling');
	$(this).addClass('twinkling');
	$('.quantity input:text').trigger("blur");
	RemoveTwinkling();
});

function BuyMoreSaveMore(op,num,o){
	num = parseInt(num);
	if(op=='show'){
		checkBuyOneGetOne(num);
		return false;
	}
	for(var i=0;i<filterBuyMoreSaveMoreNum.length;i++){
		if(filterBuyMoreSaveMoreNum[i]>num){
			$('.addonemore .getnum').html(filterBuyMoreSaveMoreNum[i]-num);
			if(i==0){
				$('.addonemore .enough').hide();
				$('.addonemore .get').show();
				$('.addonemore .getprice').html($('.buymoresavemore li[each-price="'+filterBuyMoreSaveMorePrice[i]+'"]').find('em.price').html());
				$('.good_main .price .now').html($('.good_main .price .now').attr('oriprice'));
				if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest($('.good_main .price .now').attr('oriprice'), num);},500)}
				autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
			}else{
				$('.addonemore .enough').show();
				$('.addonemore .get').hide();
				$('.addonemore .enough .getprice').attr('oriprice',filterBuyMoreSaveMorePrice[i-1]);
				$('.addonemore .enough .getprice').html($('.buymoresavemore li[each-price="'+filterBuyMoreSaveMorePrice[i-1]+'"]').find('em.price').html());
				$('.good_main .price .now').html(filterBuyMoreSaveMorePrice[i-1]);
				if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(filterBuyMoreSaveMorePrice[i-1], num);},500)}
				$('.item_box .now').eq(0).attr('oriprice',filterBuyMoreSaveMorePrice[i-1]);
				autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
				if(filterBuyMoreSaveMoreNum[i]-1 == num && o =='sub'){
					$(".addonemore .enough .getprice").after('<i class="getprice price" oriprice="'+filterBuyMoreSaveMorePrice[i-1]+'">'+$('.buymoresavemore li[each-price="'+filterBuyMoreSaveMorePrice[i-1]+'"]').find('em.price').html()+'</i>').stop().animate({
						"margin-top":"-16px"
					},300,function(){
						$(".addonemore .enough .getprice:last-child").prevAll().remove();
					});
				}
			}
			break;
		}else if(filterBuyMoreSaveMoreNum[i]==num){
			$('.good_main .price .now').html(filterBuyMoreSaveMorePrice[i]);
			$('.item_box .now').eq(0).attr('oriprice',filterBuyMoreSaveMorePrice[i]);
			autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
			if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(filterBuyMoreSaveMorePrice[i], num);},500)}
			$('.addonemore .get').hide();
			$('.addonemore .enough').show();
			var Maxprie = $('.buymoresavemore li[max="'+num+'"]').find('em.price').html();
			var Maxeachprice = $('.buymoresavemore li[max="'+num+'"]').attr('each-price');
			$('.addonemore .enough .getprice').attr('oriprice',Maxeachprice);
			$('.addonemore .enough .getprice').html(Maxprie);
			if(o =='add'){
				$(".addonemore .enough .getprice").after('<i class="getprice price" oriprice="'+Maxeachprice+'">'+Maxprie+'</i>').stop().animate({
					"margin-top":"-16px"
				},300,function(){
					$(".addonemore .enough .getprice:last-child").prevAll().remove();
				});
			}
			break;
		}
	}
	if(num > filterBuyMoreSaveMoreNum[filterBuyMoreSaveMoreNum.length - 1]){
		if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(filterBuyMoreSaveMorePrice[filterBuyMoreSaveMorePrice.length - 1], num);},500)}
	}
	if(filterBuyMoreSaveMoreNum[0]>num){
		$('.item_box .now').eq(0).attr('oriprice',$('.item_box .now').eq(0).attr('oldoriprice'));
		autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
	}
}

function RemoveTwinkling(){
	setTimeout(function(){
		$('#quantity,.buymoresavemore li').removeClass('twinkling');
	},300);
}

function checkBuyOneGetOne(num){
	num = parseInt(num);
	for(var i=0;i<filterBuyMoreSaveMoreNum.length;i++){
		if(filterBuyMoreSaveMoreNum[i] > num){
			if(filterBuyMoreSaveMoreNum[0]>num){
				$('.item_box .now').eq(0).attr('oriprice',$('.item_box .now').eq(0).attr('oldoriprice'));
				$('.addonemore .enough .getprice').html('US$'+$('.item_box .now').eq(0).attr('oldoriprice'));
				$('.addonemore .enough .getprice').attr('oriprice',$('.item_box .now').eq(0).attr('oldoriprice'))
				autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
				autoChangePrice($('.addonemore .enough .getprice'), $.cookie("currency"),true);
				break;
			}
			$('.addonemore .get').hide();
			$('.addonemore .enough').show();
			$('.addonemore .enough .getprice').html($('.buymoresavemore li[max="'+filterBuyMoreSaveMoreNum[i-1]+'"]').find('em.price').html());
			$('.good_main .price .now').html(filterBuyMoreSaveMorePrice[i-1]);
			$('.item_box .now').eq(0).attr('oriprice',filterBuyMoreSaveMorePrice[i-1]);
			autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
			if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(filterBuyMoreSaveMorePrice[i-1], num);},500)}
			break;
		}else{
			if(filterBuyMoreSaveMoreNum[i]==num){
				$('.item_box .now').eq(0).attr('oriprice',filterBuyMoreSaveMorePrice[i]);
				autoChangePrice($('.item_box .now').eq(0), $.cookie("currency"));
				if(typeof(BrazilInterestRate) != 'undefined'){setTimeout(function(){BrazilInterestRate.Interest(filterBuyMoreSaveMorePrice[i], num);},500)}
				$('.addonemore .get').hide();
				$('.addonemore .enough').show();
				$('.addonemore .enough .getprice').html($('.buymoresavemore li[max="'+filterBuyMoreSaveMoreNum[i]+'"]').find('em.price').html());
				break;
			}
		}
	}
}

function changeBuyMoreSaveMoreWarehouse(warehouse){
	if(filterBuyMoreSaveMoreNum !=''){
		if(warehouse=='CN'){
			$('.buymoresavemore,.good_main .addonemore').show();
			BuyMoreSaveMore('',1);
		}else{
			$('.buymoresavemore,.good_main .addonemore').hide();
		}
	}
}
/*#14992 多件优惠促销需求 end*/

//改变url参数
function changeUrl() {
    var href = decodeURI(location.href);
    var hrefArr = href.split('?');
    var baseUrl = hrefArr[0];
    var params = '';
    var quote = '';
    if (hrefArr[1]) {
        strs = hrefArr[1].split("&");
        strlen = strs.length;

        for (var i=0; i<strlen; i++) {
            var param = strs[i].split("="); 
            if (param[0] != 'ID' && param[0] != 'cur_warehouse') { 
                params += quote + param[0] + '=' + param[1];
                quote = '&'; 
            }
        } 
    } 

    var selOptions = getSelectedOptions(); 
    if (selOptions != false) { 
        if(selOptions.valueIds != undefined && selOptions.valueIds.length > 0){
            var id = '';
            for(var i = 0; i < selOptions.valueIds.length; i++){
                id += selOptions.valueIds[i].length + selOptions.valueIds[i];
            }
            params += quote + 'ID=' + id;
            quote = '&';
        } 
    }

        params += quote + 'cur_warehouse=' + $('#curWarehouse').val();
        history.replaceState({}, "", baseUrl + '?' + params);
    }


	/*点击切换addwishlist推荐商品 start*/
(function () {
	$(document).on('click', '.btn_left', function () {
		var ul = $(this).siblings('.contentList').find('ul');
		var uloffsetLeft = ul[0].offsetLeft;
		var liWidth = parseInt(ul.children().outerWidth(true));
			if ($(this).hasClass('btn_off')) {
				return;
			} else {
				if (uloffsetLeft < 0) {
					ul.css({ left: uloffsetLeft + liWidth * 4 + "px" });
					$(".customer_also_viwed_content .btn_right").removeClass("btn_off");
				}
				if (ul[0].offsetLeft >= 0) {
					$(".customer_also_viwed_content .btn_left").addClass("btn_off");
				}
			}
	})
	$(document).on('click', '.btn_right', function () {
		var ul = $(this).siblings('.contentList').find('ul');
		var listLength = parseInt(ul.css('width'));
		var uloffsetLeft = ul[0].offsetLeft;
		var liWidth = parseInt(ul.children().outerWidth(true));
		if ($(this).hasClass('btn_off')) {
			return;
		} else {
			if (listLength + uloffsetLeft > liWidth * 4) {
				ul.css({ left: uloffsetLeft - liWidth * 4 + "px" });
				$(".customer_also_viwed_content .btn_left").removeClass("btn_off");
			}
			if (listLength + ul[0].offsetLeft <= liWidth * 4) {
				$(".customer_also_viwed_content .btn_right").addClass("btn_off");
			}
		}
	})
})();
function recommendListNum(i){
	i = (i%4)+1;
	return i; 
}
/*点击切换addwishlist推荐商品 end*/

/*推荐商品埋点 start*/
$(document).on("click", ".contentListBox>ul>li>.sendrecommendPoint", function (e) {

	var r_cid = $(this).data("r_cid");
	var products_id = $(this).data("pro_id");
	var data = "";
	data += "r_cid=" + r_cid;
	data += "&r_position=detail-popup-addwish-alsoview";
	data += "&products_id=" + products_id;
	data += "&ac=view";
	
	$.ajax({
		type: 'POST',
		url: '//rec.banggood.com/index.php?com=recommend&t=record',
		data: data,
		crossDomain: true,
		dataType: 'jsonp',
		success: function (res) {

		}
	})

})
/*推荐商品埋点 end*/


    /*   getHotProduct();
     scroll_play('.hotgoods_1200',6);
     translate_btn();
     $(".scrollLoading").scrollLoading();
     couponBanner();
     getBundleList();*/



var DetailPageCID = [];
var BrazilProductCID = ['1212', '1218', '1994', '2365', '1827', '1850', '1825', '1852', '1824', '1828'];
function GetDetailPageCateID(){
	if($('.inhere li a').length > 0){
		var s = new RegExp(".*-c-([0-9]*)[-.]");
		$('.inhere li a').each(function(){
			var href = $(this).attr('href');
			var g=s.exec(href);
			DetailPageCID.push(g?encodeURIComponent(g[1]):0);			
		});
		DetailPageCID.shift();
	}
}

GetDetailPageCateID();



function GetBrazilSupportedPayment(){
	if(typeof(LS_PAYMENT) == 'undefined'){
		LS_PAYMENT = '';
	}
	var brhtml = ''+
		'<div class="item_box supportedpayment">'+
			'<div class="item_name">'+LS_PAYMENT+'</div>'+
				'<div class="item_con">'+
					'<div class="brpaymnetlist creditcard">'+
						'<i class="icon"></i>'+
						'<div class="supportedpaymentbox">'+
							'<ul>'+
								'<li><img src="//css.banggood.com/images/icon/08.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/04.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/07.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/02.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/03.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/05.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/06.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/01.png" alt=""></li>'+
							'</ul>'+
							'<dl></dl>'+
							'<span class="arrow_b"><i><i></i></i></span>'+
						'</div>'+
					'</div>'+
					'<div class="brpaymnetlist paypal">'+
						'<i class="icon"></i>'+
						'<div class="supportedpaymentbox">'+
							'<ul>'+
								'<li><img src="//css.banggood.com/images/icon/08.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/07.png" alt=""></li>'+
								'<li><img src="//css.banggood.com/images/icon/06.png" alt=""></li>'+
							'</ul>'+
							'<span class="errortips">É necessário ter um Cartão de Crédito Internacional associado à conta PayPal.</span>'+
							'<span class="arrow_b"><i><i></i></i></span>'+
						'</div>'+
					'</div>'+
					'<div class="brpaymnetlist boleto">'+
						'<i class="icon"></i>'+
						'<div class="supportedpaymentbox">'+
							'<span class="errortips">Boleto está temporariamente indisponível no momento para este produto.</span>'+
							'<span class="arrow_b"><i><i></i></i></span>'+
						'</div>'+
					'</div>'+
				'</div>'+
			'</div>';

	if(typeof($.cookie("countryCookie")) != 'undefined'){
        eval('var countryCookie = '+$.cookie("countryCookie")+';');
        if(typeof(countryCookie.code) != 'undefined' && countryCookie.code == 'BR'){
        	if($('.supportedpayment').length == 0){
        		$('.buy').before(brhtml);
        	}
			/*if(isclearStock == 0){
				$('.supportedpayment .boleto .supportedpaymentbox').remove();
			}else{
				$('.supportedpayment .boleto i.icon').addClass('gray');
			}*/

			
			
			

			BrazilInterestRate.Interest();	
			
        }
    }
}


var BrazilInterestRate = (function(){
	var list = [1,2,3,4,5,6,9,10,12];
　　var rate = [0,0.0301,0.0401,0.0501,0.0607,0.0708,0.1021,0.1123,0.1304];

　　var Interest = function(price, num){

		var	i = 0,
			length = 0,
			free = 0,
			oriprice = $('.good_main .price .now').attr('oriprice'),
			qty = parseInt($('#quantity').val()),
			freeTxt = ' , Sem Juros';
		if(typeof(price) != 'undefined'){
			oriprice = parseFloat(price);
		}
		if(typeof(num) != 'undefined'){
			qty = parseInt(num);
		}
		if(typeof(AllFreeInterest) != 'undefined'){
			free = 1;
		}
		
		
		var totalprice = parseFloat(oriprice) * qty * parseFloat(eval('CurrencyCfg.BRL[0]'));
		var lossRate = CurrencyLoss;
		if(typeof(CurrencyBGLoss) != 'undefined' && CurrencyBGLoss > 0){
			lossRate = CurrencyBGLoss;
		}
		totalprice = totalprice * parseFloat(lossRate);
		$('.supportedpayment .creditcard .supportedpaymentbox').find('ul,dl').show();
		$('.supportedpayment .creditcard .supportedpaymentbox').find('.errortips').remove();
		$('.supportedpayment .creditcard .supportedpaymentbox').removeClass('others');
		$('.supportedpayment .creditcard .icon').removeClass('gray');
		var creditcardHtml = $('.supportedpayment .creditcard dl');
		creditcardHtml.empty();
		
		if(totalprice < 50){length = 1;}
		else if(totalprice*(1+rate[1]) >= 50 && totalprice*(1+rate[1]) < 75){length = 2;}
		else if(totalprice*(1+rate[2]) >= 75 && totalprice*(1+rate[2]) < 100){length = 3;}
		else if(totalprice*(1+rate[3]) >= 100 && totalprice*(1+rate[3]) < 125){length = 4;}
		else if(totalprice*(1+rate[4]) >= 125 && totalprice*(1+rate[4]) < 150){length = 5;}
		else if(totalprice*(1+rate[5]) >= 150 && totalprice*(1+rate[5]) < 225){length = 6;}
		else if(totalprice*(1+rate[6]) >= 225 && totalprice*(1+rate[6]) < 250){length = 7;}
		else if(totalprice*(1+rate[7]) >= 250 && totalprice*(1+rate[7]) < 300){length = 8;}
		else if(totalprice*(1+rate[8]) >= 300){length = 9;}

		
		totalprice = totalprice.toFixed(2);

		var FiveTotalPrice = parseFloat(oriprice) * qty;


		if(FiveTotalPrice < 0.5){
			$('.supportedpayment .boleto i.icon').addClass('gray');
			$('.supportedpayment .boleto .supportedpaymentbox .errortips').html('Pagamento com Boleto requer um valor de pedido no mínimo de 0,5USD');
		}else{
			$('.supportedpayment .boleto i.icon').removeClass('gray');
			$('.supportedpayment .boleto .supportedpaymentbox .errortips').html('Boleto está temporariamente indisponível no momento para este produto.');
			if(isclearStock == 1){
				$('.supportedpayment .boleto i.icon').addClass('gray');
			}else{
				$('.supportedpayment .boleto .supportedpaymentbox').remove();
			}
		}

		for(;i<length;i++){
			if(i == 0){
				creditcardHtml.append('<dd>'+list[i]+' de R$'+(totalprice*(rate[i]+1)/list[i]).toFixed(2)+freeTxt+'</dd>');
			}else{
				if(free == 1){
					creditcardHtml.append('<dd>'+list[i]+' de R$'+(totalprice*(rate[i]+1)/list[i]).toFixed(2)+freeTxt+'</dd>');
				}else{
					creditcardHtml.append('<dd>'+list[i]+' de R$'+(totalprice*(rate[i]+1)/list[i]).toFixed(2)+' , Total c/Juros R$'+((totalprice*(rate[i]+1)/list[i]).toFixed(2)*list[i]).toFixed(2)+'</dd>');
				}
				
			}
		}

		for(var k=0;k<BrazilProductCID.length;k++){
			for(var j=0;j<DetailPageCID.length;j++){
				if(BrazilProductCID[k] == DetailPageCID[j]){
					$('.supportedpayment .creditcard .supportedpaymentbox').addClass('others');
					$('.supportedpayment .creditcard .icon').addClass('gray');
					$('.supportedpayment .creditcard .supportedpaymentbox').find('ul,dl').hide();
					if($('.supportedpayment .creditcard .supportedpaymentbox .errortips').length == 0){
						$('.supportedpayment .creditcard .supportedpaymentbox').append('<span class="errortips">A opção Cartão de Crédito não está disponível para produtos desta categoria.</span>');
					}else{
						$('.supportedpayment .creditcard .supportedpaymentbox .errortips').html('A opção Cartão de Crédito não está disponível para produtos desta categoria.');
					}
					
				}
			}
		}

		if(is_dropship_for_Brazil == 1){
			$('.supportedpayment .creditcard .supportedpaymentbox').addClass('others');
			$('.supportedpayment .creditcard .icon').addClass('gray');
			$('.supportedpayment .creditcard .supportedpaymentbox').find('ul,dl').hide();
			if($('.supportedpayment .creditcard .supportedpaymentbox .errortips').length == 0){
				$('.supportedpayment .creditcard .supportedpaymentbox').append('<span class="errortips">A opção Cartão de Crédito não está disponível para membros do nosso programa Dropshipping</span>');
			}else{
				$('.supportedpayment .creditcard .supportedpaymentbox .errortips').html('A opção Cartão de Crédito não está disponível para membros do nosso programa Dropshipping');
			}
			
		}

		if($('.point .point_subtotal').length > 0){
			var _totalprice = parseInt($('.point .point_subtotal').attr('oriprice'));
			if(_totalprice > 1200){

				$('.supportedpayment .creditcard .supportedpaymentbox').addClass('others');
				$('.supportedpayment .creditcard .icon').addClass('gray');
				$('.supportedpayment .creditcard .supportedpaymentbox').find('ul,dl').hide();
				if($('.supportedpayment .creditcard .supportedpaymentbox .errortips').length == 0){
					$('.supportedpayment .creditcard .supportedpaymentbox').append('<span class="errortips">A opção Cartão de Crédito não está disponível para compras acima de U$1200 (Doláres)</span>');
				}else{
					$('.supportedpayment .creditcard .supportedpaymentbox .errortips').html('A opção Cartão de Crédito não está disponível para compras acima de U$1200 (Doláres)');
				}
				
			}
		}
　  };

	return {
		Interest : Interest
	};

})();

