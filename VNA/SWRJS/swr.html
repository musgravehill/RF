<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="common/bootstrap.min.css">
        <title>SWRJS</title>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <b>DUT-port</b>
                    <textarea id="portDUT" class="form-control">
5865;0;138;
5845;0;149;
5825;0;159;
5805;0;169;
5785;0;179;
5765;0;189;
5745;0;197;
                    </textarea>
                </div>
                <div class="col">
                    <b>Short\open circuit, 50R, 75R, etc. at DUT-port</b>
                    <textarea id="portCorrection" class="form-control">
5865;0;2;
5845;0;3;
5825;0;3;
5805;0;2;
5785;0;4;
5765;0;3;
5745;0;3;
5725;0;3;
5733;0;3;
5752;0;3;
5771;0;3;
5790;0;3;
5809;0;2;
5828;0;2;
5847;0;1;
5866;0;1;
5705;0;3;
5685;0;3;
5665;0;3;
5645;0;2;
5885;0;2;
5905;0;0;
5925;0;0;
5945;0;0;
5740;0;3;
5760;0;3;
5780;0;3;
5800;0;3;
5820;0;2;
5840;0;1;
5860;0;1;

                    </textarea>
                </div>                
            </div>

            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <form class="form-inline m-4">
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_FROM MHz</div>
                            </div>
                            <input id="freq_from" type="number" class="form-control" value="5600" style="width: 90px;" />
                        </div>
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_TO MHz</div>
                            </div>
                            <input id="freq_to" type="number" class="form-control" value="6000" style="width: 90px;" />
                        </div>
                        <div class="form-check mb-2 mr-sm-2">
                            <input class="form-check-input" type="checkbox" id="isUsePortCorrection">
                            <label class="form-check-label" for="inlineFormCheck">
                                use port correction
                            </label>
                        </div>                        
                        <span class="btn btn-danger mb-2" id="freqs_range_apply">ok</span>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_portDUT"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_portCorrection"></canvas>  
                    </div>
                </div>
            </div>

        </div>   <!-- container -->

        <script src="common/jquery-3.2.1.slim.min.js"></script>
        <script src="common/bootstrap.bundle.min.js"></script>
        <script src="common/Chart.bundle.min.js"></script>

        <script type="text/javascript">
            var portCorrection_values = []; //input values from device
            var portCorrection_correction_coef = []; //coefficient for corrction

            var openPort_values = []; //input values from device
            var openportCorrection_coef = []; //coefficient for corrction

            var portDUT_values = []; //input values from device

            var freq_from = 0; //MHz
            var freq_to = 0; //MHz
            var isUsePortCorrection = false;
            var chart_portDUT = false;
            var chart_portCorrection = false;
            document.addEventListener('DOMContentLoaded', function () {
                freqs_range_apply();
            });
            function freqs_range_apply() {
                $('#freqs_range_apply').click(function () {
                    freq_from = parseInt($('#freq_from').val()); //MHz
                    freq_to = parseInt($('#freq_to').val()); //MHz
                    isUsePortCorrection = $("#isUsePortCorrection").prop('checked');
                    portCorrection_fill();
                    portCorrection_calc_correction_coef();
                    portDUT_fill();
                    chart_portDUT_draw();
                    chart_portCorrection_draw();
                });
            }

            function portDUT_fill() {
                var res = $('#portDUT').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        portDUT_values[freq] = volt;
                    }
                });
            }

            function portCorrection_fill() {
                var res = $('#portCorrection').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        portCorrection_values[freq] = volt;
                    }
                });
            }
            function portCorrection_calc_correction_coef() {
                var i;
                var portCorrection_values_freqsRange = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (portCorrection_values[i]) {
                        portCorrection_values_freqsRange.push(portCorrection_values[i]);
                    }
                }
                var portCorrection_values_freqsRange_max = Math.max.apply(null, portCorrection_values_freqsRange);
                for (i = freq_from; i <= freq_to; i++) {
                    if (portCorrection_values[i]) {
                        portCorrection_correction_coef[i] = portCorrection_values_freqsRange_max / portCorrection_values[i];
                    }
                }
            }

            function chart_portDUT_draw() {
                var i;
                var dataLabels = [];
                var dataY_portDUT_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (portDUT_values[i]) {
                        dataLabels.push(i);
                        if (isUsePortCorrection && portCorrection_correction_coef[i]) {
                            dataY_portDUT_values.push(Math.round(portDUT_values[i] * portCorrection_correction_coef[i]));
                        } else {
                            dataY_portDUT_values.push(portDUT_values[i]);
                        }
                    }
                }

                if (chart_portDUT) {
                    chart_portDUT.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_portDUT').getContext('2d');
                chart_portDUT = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [
                            {
                                label: 'portDUT',
                                fill: false,
                                backgroundColor: '#ff2600',
                                borderWidth: 3,
                                borderColor: '#ff2600',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_portDUT_values
                            }
                        ]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                        },

                        /*elements: {
                         line: {
                         tension: 0, // disables bezier curves
                         }
                         },*/
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                });
            }
            function chart_portCorrection_draw() {
                var i;
                var dataLabels = [];
                var dataY_portCorrection_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (portCorrection_values[i] || openPort_values[i]) {
                        dataLabels.push(i);
                        dataY_portCorrection_values.push(portCorrection_values[i]);
                    }
                }


                if (chart_portCorrection) {
                    chart_portCorrection.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_portCorrection').getContext('2d');
                chart_portCorrection = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [
                            {
                                label: 'portCorrection',
                                fill: false,
                                backgroundColor: '#1a7200',
                                borderWidth: 3,
                                borderColor: '#1a7200',
                                pointStyle: 'circle',
                                radius: 2,
                                data: dataY_portCorrection_values
                            },
                        ]
                    },
                    options: {
                        scales: {
                            yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    }
                                }]
                        },
                        /*elements: {
                         line: {
                         tension: 0, // disables bezier curves
                         }
                         },*/
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                });
            }
        </script>

    </body>
</html>