<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="common/bootstrap.min.css">
        <title>SWRJS</title>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <b>DUT-port</b>
                    <textarea id="DUT_portInput" class="form-control">
5865;0;138;
5845;0;149;
5825;0;159;
5805;0;169;
5785;0;179;
5765;0;189;
5745;0;197;
                    </textarea>
                </div>
                <div class="col">
                    <b>Short circuit at DUT-port</b>
                    <textarea id="shortPortInput" class="form-control"></textarea>
                </div>
                <div class="col">
                    <b>Open circuit at DUT-port</b>
                    <textarea id="openPortInput" class="form-control">
5865;0;5;
5845;0;5;
5825;0;6;
5805;0;6;
5785;0;7;
5765;0;8;
5745;0;9;
                    </textarea>
                </div>
                <div class="col">
                    <b>50R at DUT-port</b>
                    <textarea id="50rPortInput" class="form-control">
                    </textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <form class="form-inline m-4">
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_FROM MHz</div>
                            </div>
                            <input id="freq_from" type="number" class="form-control" value="5600" style="width: 90px;" />
                        </div>
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_TO MHz</div>
                            </div>
                            <input id="freq_to" type="number" class="form-control" value="6000" style="width: 90px;" />
                        </div>
                        <div class="form-check mb-2 mr-sm-2">
                            <input class="form-check-input" type="checkbox" id="isUseShortPortCorrection">
                            <label class="form-check-label" for="inlineFormCheck">
                                use shortPort correction
                            </label>
                        </div>
                        <div class="form-check mb-2 mr-sm-2">
                            <input class="form-check-input" type="checkbox" id="isUseOpenPortCorrection">
                            <label class="form-check-label" for="inlineFormCheck">
                                use openPort correction
                            </label>
                        </div>
                        <span class="btn btn-danger mb-2" id="freqs_range_apply">ok</span>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_DUT"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_correction"></canvas>  
                    </div>
                </div>
            </div>

        </div>   <!-- container -->

        <script src="common/jquery-3.2.1.slim.min.js"></script>
        <script src="common/bootstrap.bundle.min.js"></script>
        <script src="common/Chart.bundle.min.js"></script>

        <script type="text/javascript">
            var shortPort_values = []; //input values from device
            var shortPort_correction_coef = []; //coefficient for corrction

            var openPort_values = []; //input values from device
            var openPort_correction_coef = []; //coefficient for corrction

            var DUT_port_values = []; //input values from device

            var freq_from = 0; //MHz
            var freq_to = 0; //MHz
            var isUseShortPortCorrection = false;
            var isUseOpenPortCorrection = false;

            var chart_DUT = false;
            var chart_correction = false;

            document.addEventListener('DOMContentLoaded', function () {
                freqs_range_apply();
            });

            function freqs_range_apply() {
                $('#freqs_range_apply').click(function () {
                    freq_from = parseInt($('#freq_from').val()); //MHz
                    freq_to = parseInt($('#freq_to').val()); //MHz
                    isUseShortPortCorrection = $("#isUseShortPortCorrection").prop('checked');
                    isUseOpenPortCorrection = $("#isUseOpenPortCorrection").prop('checked');


                    shortPort_fill();
                    shortPort_calc_correction_coef();

                    openPort_fill();
                    openPort_calc_correction_coef();

                    DUT_port_fill();

                    chart_DUT_draw();
                    chart_correction_draw();
                });
            }

            function DUT_port_fill() {
                var res = $('#DUT_portInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        DUT_port_values[freq] = volt;
                    }
                });
            }

            function shortPort_fill() {
                var res = $('#shortPortInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        shortPort_values[freq] = volt;
                    }
                });
            }
            function shortPort_calc_correction_coef() {
                var i;
                var shortPort_values_freqsRange = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (shortPort_values[i]) {
                        shortPort_values_freqsRange.push(shortPort_values[i]);
                    }
                }
                var shortPort_values_freqsRange_max = Math.max.apply(null, shortPort_values_freqsRange);
                for (i = freq_from; i <= freq_to; i++) {
                    if (shortPort_values[i]) {
                        shortPort_correction_coef[i] = shortPort_values_freqsRange_max / shortPort_values[i];
                    }
                }

            }

            function openPort_fill() {
                var res = $('#openPortInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        openPort_values[freq] = volt;
                    }
                });
            }
            function openPort_calc_correction_coef() {
                var i;
                var openPort_values_freqsRange = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (openPort_values[i]) {
                        openPort_values_freqsRange.push(openPort_values[i]);
                    }
                }
                var openPort_values_freqsRange_max = Math.max.apply(null, openPort_values_freqsRange);
                for (i = freq_from; i <= freq_to; i++) {
                    if (openPort_values[i]) {
                        openPort_correction_coef[i] = openPort_values_freqsRange_max / openPort_values[i];
                    }
                }
            }


            function chart_DUT_draw() {
                var i;
                var dataLabels = [];

                var dataY_DUT_port_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (DUT_port_values[i]) {
                        dataLabels.push(i);
                        if (isUseShortPortCorrection && shortPort_correction_coef[i]) {
                            dataY_DUT_port_values.push(Math.round(DUT_port_values[i] * shortPort_correction_coef[i]));
                        } else if (isUseOpenPortCorrection && openPort_correction_coef[i]) {
                            dataY_DUT_port_values.push(Math.round(DUT_port_values[i] * openPort_correction_coef[i]));
                        } else {
                            dataY_DUT_port_values.push(DUT_port_values[i]);
                        }
                    }
                }

                if (chart_DUT) {
                    chart_DUT.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_DUT').getContext('2d');
                chart_DUT = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [
                            {
                                label: 'DUT_port',
                                fill: false,
                                backgroundColor: '#ff2600',
                                borderWidth: 3,
                                borderColor: '#ff2600',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_DUT_port_values
                            }
                        ]
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0, // disables bezier curves
                            }
                        },
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                });
            }
            function chart_correction_draw() {
                var i;
                var dataLabels = [];
                var dataY_shortPort_values = [];
                var dataY_openPort_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    if (shortPort_values[i] || openPort_values[i]) {
                        dataLabels.push(i);
                        dataY_shortPort_values.push(shortPort_values[i]);
                        dataY_openPort_values.push(openPort_values[i]);
                    }
                }


                if (chart_correction) {
                    chart_correction.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_correction').getContext('2d');
                chart_correction = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [
                            {
                                label: 'shortPort',
                                fill: false,
                                backgroundColor: '#2601a0',
                                borderWidth: 3,
                                borderColor: '#2601a0',
                                pointStyle: 'circle',
                                radius: 2,
                                data: dataY_shortPort_values
                            },
                            {
                                label: 'openPort',
                                fill: false,
                                backgroundColor: '#1a7200',
                                borderWidth: 3,
                                borderColor: '#1a7200',
                                pointStyle: 'circle',
                                radius: 2,
                                data: dataY_openPort_values
                            }
                        ]
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0, // disables bezier curves
                            }
                        },
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                });
            }
        </script>

    </body>
</html>