<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="common/bootstrap.min.css">
        <title>SWRJS</title>
    </head>
    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col">
                    <b>DUT-port</b>
                    <textarea id="DUT_portInput" class="form-control"></textarea>
                </div>
                <div class="col">
                    <b>Short circuit at DUT-port</b>
                    <textarea id="shortPortInput" class="form-control">
400;0;198;
401;0;198;
402;0;197;
403;0;197;
404;0;196;
405;0;195;
406;0;194;
407;0;193;
408;0;193;
409;0;191;
410;0;190;
411;0;189;
412;0;188;
413;0;187;
414;0;187;
415;0;187;
416;0;186;
417;0;186;
418;0;186;
419;0;187;
420;0;187;
421;0;186;
422;0;188;
423;0;188;
424;0;189;
425;0;190;
426;0;191;
427;0;192;
428;0;192;
429;0;193;
430;0;194;
431;0;195;
432;0;197;
433;0;197;
434;0;199;
435;0;199;
436;0;201;
437;0;203;
438;0;204;
439;0;204;
440;0;206;
441;0;207;
442;0;208;
443;0;208;
444;0;209;
445;0;210;
446;0;210;
447;0;209;
448;0;209;
449;0;209;
450;0;208;
451;0;207;
452;0;206;
453;0;205;
454;0;205;
455;0;206;
456;0;204;
457;0;203;
458;0;203;
459;0;201;
460;0;201;
461;0;200;
462;0;198;
463;0;197;
464;0;196;
465;0;196;
466;0;195;
467;0;194;
468;0;194;
469;0;193;
470;0;192;
471;0;190;
472;0;190;
473;0;190;
474;0;189;
475;0;189;
476;0;188;
477;0;187;
478;0;187;
479;0;187;
480;0;187;
481;0;186;
482;0;185;
483;0;186;
484;0;186;
485;0;186;
486;0;186;
487;0;185;
488;0;186;
489;0;186;
490;0;187;
491;0;187;
492;0;187;
493;0;188;
494;0;187;
495;0;188;
496;0;189;
497;0;189;
498;0;190;
499;0;190;
500;0;191;
                    </textarea>
                </div>
                <div class="col">
                    <b>Open circuit at DUT-port</b>
                    <textarea id="openPortInput" class="form-control">
400;0;173;
401;0;174;
402;0;175;
403;0;176;
404;0;177;
405;0;178;
406;0;178;
407;0;179;
408;0;179;
409;0;179;
410;0;180;
411;0;179;
412;0;179;
413;0;178;
414;0;178;
415;0;178;
416;0;178;
417;0;177;
418;0;177;
419;0;177;
420;0;176;
421;0;176;
422;0;176;
423;0;176;
424;0;175;
425;0;175;
426;0;176;
427;0;176;
428;0;176;
429;0;175;
430;0;175;
431;0;175;
432;0;175;
433;0;177;
434;0;175;
435;0;175;
436;0;175;
437;0;174;
438;0;175;
439;0;175;
440;0;174;
441;0;174;
442;0;173;
443;0;172;
444;0;172;
445;0;171;
446;0;171;
447;0;170;
448;0;169;
449;0;167;
450;0;166;
451;0;165;
452;0;165;
453;0;163;
454;0;162;
455;0;159;
456;0;159;
457;0;158;
458;0;157;
459;0;157;
460;0;157;
461;0;156;
462;0;157;
463;0;156;
464;0;157;
465;0;157;
466;0;157;
467;0;157;
468;0;157;
469;0;157;
470;0;157;
471;0;158;
472;0;158;
473;0;158;
474;0;158;
475;0;158;
476;0;158;
477;0;159;
478;0;158;
479;0;159;
480;0;159;
481;0;159;
482;0;159;
483;0;159;
484;0;159;
485;0;159;
486;0;159;
487;0;159;
488;0;159;
489;0;159;
490;0;159;
491;0;159;
492;0;160;
493;0;159;
494;0;159;
495;0;159;
496;0;159;
497;0;158;
498;0;159;
499;0;158;
500;0;157;
                    </textarea>
                </div>
                <div class="col">
                    <b>50R at DUT-port</b>
                    <textarea id="50rPortInput" class="form-control">
                    </textarea>
                </div>
            </div>

            <div class="row">
                <div class="col-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                    <form class="form-inline m-4">
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_FROM MHz</div>
                            </div>
                            <input id="freq_from" type="number" class="form-control" value="400" style="width: 90px;" />
                        </div>
                        <div class="input-group mb-2 mr-sm-2">
                            <div class="input-group-prepend">
                                <div class="input-group-text">FREQ_TO MHz</div>
                            </div>
                            <input id="freq_to" type="number" class="form-control" value="500" style="width: 90px;" />
                        </div>
                        <div class="form-check mb-2 mr-sm-2">
                            <input class="form-check-input" type="checkbox" id="isUseShortPortCorrection">
                            <label class="form-check-label" for="inlineFormCheck">
                                use shortPort correction
                            </label>
                        </div>
                        <div class="form-check mb-2 mr-sm-2">
                            <input class="form-check-input" type="checkbox" id="isUseOpenPortCorrection">
                            <label class="form-check-label" for="inlineFormCheck">
                                use openPort correction
                            </label>
                        </div>
                        <span class="btn btn-danger mb-2" id="freqs_range_apply">ok</span>
                    </form>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_DUT"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="chart-container" style="position: relative; height: 500px;"> <!-- style="position: relative; height: 300px;" -->
                        <canvas id="chart_correction"></canvas>  
                    </div>
                </div>
            </div>

        </div>   <!-- container -->

        <script src="common/jquery-3.2.1.slim.min.js"></script>
        <script src="common/bootstrap.bundle.min.js"></script>
        <script src="common/Chart.bundle.min.js"></script>

        <script type="text/javascript">
            var shortPort_values = []; //input values from device
            var shortPort_correction_coef = []; //coefficient for corrction

            var openPort_values = []; //input values from device
            var openPort_correction_coef = []; //coefficient for corrction

            var DUT_port_values = []; //input values from device

            var freq_from = 0; //MHz
            var freq_to = 0; //MHz
            var isUseShortPortCorrection = false;
            var isUseOpenPortCorrection = false;

            var chart_DUT = false;
            var chart_correction = false;

            document.addEventListener('DOMContentLoaded', function () {
                freqs_range_apply();
            });

            function freqs_range_apply() {
                $('#freqs_range_apply').click(function () {
                    freq_from = parseInt($('#freq_from').val()); //MHz
                    freq_to = parseInt($('#freq_to').val()); //MHz
                    isUseShortPortCorrection = $("#isUseShortPortCorrection").prop('checked');
                    isUseOpenPortCorrection = $("#isUseOpenPortCorrection").prop('checked');


                    shortPort_fill();
                    shortPort_calc_correction_coef();

                    openPort_fill();
                    openPort_calc_correction_coef();

                    DUT_port_fill();

                    chart_DUT_draw();
                    chart_correction_draw();
                });
            }

            function DUT_port_fill() {
                var res = $('#DUT_portInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        DUT_port_values[freq] = volt;
                    }
                });
            }

            function shortPort_fill() {
                var res = $('#shortPortInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        shortPort_values[freq] = volt;
                    }
                });
            }
            function shortPort_calc_correction_coef() {
                var i;
                var shortPort_values_freqsRange = [];
                for (i = freq_from; i <= freq_to; i++) {
                    shortPort_values_freqsRange.push(shortPort_values[i]);
                }

                var shortPort_values_freqsRange_max = Math.max.apply(null, shortPort_values_freqsRange);

                for (i = freq_from; i <= freq_to; i++) {
                    shortPort_correction_coef[i] = shortPort_values_freqsRange_max / shortPort_values[i];
                }

            }

            function openPort_fill() {
                var res = $('#openPortInput').val();
                var ar = res.split('\n');
                var tmp, freq, volt;
                $(ar).each(function (i, item) {
                    tmp = item.split(';');
                    freq = parseInt(tmp[0]);
                    volt = parseInt(tmp[2]);
                    if (freq > 0 && volt >= 0) {
                        //console.log('f=' + freq + ' v=' + volt);
                        openPort_values[freq] = volt;
                    }
                });
            }
            function openPort_calc_correction_coef() {
                var i;
                var openPort_values_freqsRange = [];
                for (i = freq_from; i <= freq_to; i++) {
                    openPort_values_freqsRange.push(openPort_values[i]);
                }

                var openPort_values_freqsRange_max = Math.max.apply(null, openPort_values_freqsRange);

                for (i = freq_from; i <= freq_to; i++) {
                    openPort_correction_coef[i] = openPort_values_freqsRange_max / openPort_values[i];
                }

            }


            function chart_DUT_draw() {
                var i;
                var dataLabels = [];                

                var dataY_DUT_port_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    dataLabels.push(i);
                    if (isUseShortPortCorrection) {
                        dataY_DUT_port_values.push(Math.round(DUT_port_values[i] * shortPort_correction_coef[i]));
                    } else if (isUseOpenPortCorrection) {
                        dataY_DUT_port_values.push(Math.round(DUT_port_values[i] * openPort_correction_coef[i]));
                    } else {
                        dataY_DUT_port_values.push(DUT_port_values[i]);
                    }
                }

                if (chart_DUT) {
                    chart_DUT.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_DUT').getContext('2d');
                chart_DUT = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [
                            {
                                label: 'DUT_port',
                                fill: false,
                                backgroundColor: '#ff2600',
                                borderWidth: 3,
                                borderColor: '#ff2600',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_DUT_port_values
                            }
                        ]
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0, // disables bezier curves
                            }
                        },
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                });
            }
            function chart_correction_draw() {
                var i;
                var dataLabels = [];

                var dataY_shortPort_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    dataLabels.push(i);
                    dataY_shortPort_values.push(shortPort_values[i]);
                }

                var dataY_shortPort_correction_coef = [];
                for (i = freq_from; i <= freq_to; i++) {
                    dataY_shortPort_correction_coef.push(shortPort_correction_coef[i]);
                }

                var dataY_openPort_values = [];
                for (i = freq_from; i <= freq_to; i++) {
                    dataY_openPort_values.push(openPort_values[i]);
                }

                var dataY_openPort_correction_coef = [];
                for (i = freq_from; i <= freq_to; i++) {
                    dataY_openPort_correction_coef.push(openPort_correction_coef[i]);
                }                

                if (chart_correction) {
                    chart_correction.destroy();
                    //alert('destroy');
                }

                var ctx = document.getElementById('chart_correction').getContext('2d');
                chart_correction = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataLabels,
                        datasets: [                           
                            {
                                label: 'shortPort',
                                fill: false,
                                backgroundColor: '#99ccff',
                                borderWidth: 3,
                                borderColor: '#99ccff',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_shortPort_values
                            },
                            /*{
                                label: 'shortPort_correction_coef',
                                fill: false,
                                backgroundColor: '#99ccff',
                                borderWidth: 3,
                                borderColor: '#99ccff',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_shortPort_correction_coef
                            },*/
                            {
                                label: 'openPort',
                                fill: false,
                                backgroundColor: '#99ff99',
                                borderWidth: 3,
                                borderColor: '#99ff99',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_openPort_values
                            },
                            /*{
                                label: 'openPort_correction_coef',
                                fill: false,
                                backgroundColor: '#99ff99',
                                borderWidth: 3,
                                borderColor: '#99ff99',
                                pointStyle: 'circle',
                                radius: 1,
                                data: dataY_openPort_correction_coef
                            }*/

                        ]
                    },
                    options: {
                        elements: {
                            line: {
                                tension: 0, // disables bezier curves
                            }
                        },
                        animation: {
                            duration: 0, // general animation time
                        },
                        hover: {
                            animationDuration: 0, // duration of animations when hovering an item
                        },
                        responsiveAnimationDuration: 0,
                        maintainAspectRatio: false, //chart.canvas.parentNode.style.height = '128px';

                        //responsive: true,
                        //hover: {
                        //mode: 'nearest',
                        //intersect: true
                        //}
                    }
                }); 
            }
        </script>

    </body>
</html>